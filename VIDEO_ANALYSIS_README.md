# Анализ видео

Новый модуль для анализа видео и текстового контента через Yandex API и OpenRouter.

## Описание

Модуль позволяет:
1. Отправлять URL контента в Yandex API для получения sharing URL
2. Извлекать текст из HTML страницы sharing URL
3. Анализировать извлеченный текст с помощью OpenRouter API
4. Возвращать структурированный анализ с ключевыми инсайтами

## Поддерживаемые типы контента

✅ **Поддерживается:**
- **Видео** - YouTube, VK, другие видеоплатформы
- Статьи и новости (Habr, Medium, блоги, новостные сайты)
- Документация (техническая документация, руководства)
- Блоги и обзоры (текстовый контент с платформ)

❌ **Не поддерживается:**
- Социальные сети (Twitter, Facebook, Instagram)
- Платформы с динамическим контентом
- Защищенные или приватные материалы

## Установка

### 1. Переменные окружения

Добавьте в файл `.env`:

```bash
# Токен для Yandex API (300.ya.ru)
YANDEX_API_TOKEN=your_yandex_token_here

# Токен для OpenRouter API (уже должен быть установлен)
OPENROUTER_API_KEY=your_openrouter_key_here
```

### 2. Зависимости

Все необходимые зависимости уже включены в `requirements.txt`:
- `beautifulsoup4` - для парсинга HTML
- `requests` - для HTTP запросов

## Использование

### Веб-интерфейс

1. Запустите приложение: `python app.py`
2. Перейдите по адресу: `http://localhost:5000/video-analysis`
3. Введите URL видео и нажмите "Анализировать видео"

### API

```python
from video_analyzer import VideoAnalyzer

# Создаем анализатор
analyzer = VideoAnalyzer()

# Анализируем видео
result = analyzer.analyze_video("https://example.com/video")

if result['success']:
    print(f"Анализ: {result['analysis']}")
else:
    print(f"Ошибка: {result['error']}")
```

### Тестирование

Запустите тестовый скрипт:

```bash
python test_video_analyzer.py
```

## Структура модуля

### VideoAnalyzer

Основной класс с методами:

- `get_sharing_url(video_url)` - получает sharing URL от Yandex API
- `get_sharing_url_direct(video_url)` - получает sharing URL напрямую с 300.ya.ru
- `extract_text_from_sharing_url(sharing_url)` - извлекает текст из HTML
- `analyze_text_with_openrouter(text)` - анализирует текст через OpenRouter
- `analyze_video(video_url)` - выполняет полный анализ

### Стратегия обработки URL

1. **Для YouTube/VK URL**: Используется прямой метод `get_sharing_url_direct()`
2. **Для остальных URL**: Сначала пробуется API, затем прямой метод как fallback
3. **Извлечение текста**: Улучшенные селекторы для работы с 300.ya.ru

### Маршруты Flask

- `GET /video-analysis` - страница с формой
- `POST /api/analyze-video` - API эндпойнт

## Промпт для анализа

Используется следующий промпт для OpenRouter:

```
Проанализируй данный текст/транскрипт/видео и выдели самые важные и необычные аспекты, которые раскрываются в материале.

Выдели нестандартные и интересные инсайты, которые обычно упускают в простых резюме.

Сфокусируйся на психологических, технических, культурных и этических нюансах.

Не делай простого пересказа по хронологии, а структурируй обзор по ключевым темам и интересным фактам.

Кратко объясни суть каждого пункта, избегай общих фраз и «воды».

При возможности выдели необычные наблюдения или примеры, которые иллюстрируют раскрываемые идеи.

Итог дай в виде связного обзора с примерно 7-10 пунктами, раскрывающих основные уникальные моменты материала.
```

## Обработка ошибок

Модуль обрабатывает следующие типы ошибок:

1. **Ошибки инициализации** - отсутствие токенов API
2. **Ошибки Yandex API** - неверный URL, проблемы с API
3. **Ошибки извлечения текста** - проблемы с парсингом HTML
4. **Ошибки OpenRouter API** - проблемы с анализом текста
5. **Сетевые ошибки** - проблемы с подключением

### Retry логика OpenRouter API

При ошибках OpenRouter API система автоматически:
- Уменьшает `max_tokens` (16000 → 8000 → 4000 → 2000)
- Увеличивает таймаут до 120 секунд
- Повторяет запросы с разными параметрами
- Предоставляет детальную диагностику ошибок

## Ограничения

- Текст извлекается из HTML страницы, структура может меняться
- Длина текста ограничена лимитами OpenRouter API
- Качество анализа зависит от модели OpenRouter

## Разработка

### Добавление новых селекторов

Для улучшения извлечения текста можно добавить новые CSS селекторы в метод `extract_text_from_sharing_url`:

```python
content_selectors = [
    '.content',
    '.text',
    '.transcript',
    # Добавьте новые селекторы здесь
]
```

### Изменение промпта

Промпт для анализа можно изменить в методе `analyze_text_with_openrouter`.

### Настройка модели

По умолчанию используется `meta-llama/llama-4-maverick:free`. Можно изменить в коде или добавить выбор модели в интерфейс. 