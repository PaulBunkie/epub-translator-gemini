<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aiTube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s ease forwards',
                        'scale-in': 'scaleIn 0.3s ease forwards',
                    }
                }
            }
        }
    </script>
    <style>

        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .video-card {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .video-card:nth-child(1) { animation-delay: 0.1s; }
        .video-card:nth-child(2) { animation-delay: 0.2s; }
        .video-card:nth-child(3) { animation-delay: 0.3s; }
        .video-card:nth-child(4) { animation-delay: 0.4s; }
        .video-card:nth-child(5) { animation-delay: 0.5s; }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
                 .line-clamp-5 {
             display: -webkit-box;
             -webkit-line-clamp: 5;
             -webkit-box-orient: vertical;
             overflow: hidden;
         }
         
         .line-clamp-3 {
             display: -webkit-box;
             -webkit-line-clamp: 3;
             -webkit-box-orient: vertical;
             overflow: hidden;
         }
        
        /* Стили для умного макета */
        .layout-smart {
            grid-auto-rows: minmax(180px, auto);
            grid-auto-flow: dense; /* Автоматически заполняет дыры */
        }
        
        /* Стили для кликабельного превью */
        .video-thumbnail-clickable {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .video-thumbnail-clickable:hover {
            transform: scale(1.02);
        }
        
        .video-thumbnail-clickable:active {
            transform: scale(0.98);
        }
        
        /* Hover эффект для всей карточки */
        .group:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Анимированный градиент для букв "ai" */
        .ai-gradient {
            background: linear-gradient(
                45deg,
                #ff6b6b,
                #4ecdc4,
                #45b7d1,
                #96ceb4,
                #feca57,
                #ff9ff3,
                #54a0ff,
                #5f27cd
            );
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        /* Стили для кнопки Play */
        .play-button-container {
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .video-thumbnail-clickable:hover .play-button-container {
            opacity: 1;
        }
        
        .play-button {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(249, 115, 22, 0.4);
            transform: scale(0.8);
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        /* ТОЛЬКО цвет рамки чата - без изменения толщины, скруглений и теней */
        #videoChatSection .card {
            border-color: #8B5CF6 !important; /* Сиреневая рамка для чата */
        }        
        
        .video-thumbnail-clickable:hover .play-button {
            transform: scale(1);
            box-shadow: 0 12px 40px rgba(249, 115, 22, 0.6);
        }
        
        .play-button::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 20px solid white;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            margin-left: 4px;
        }
        
        /* Chat styles */
        .chat-message {
            margin-bottom: 15px;
        }
        
        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .user-message {
            text-align: right;
        }
        
        .user-bubble {
            background-color: #7C3AED; /* Темно-сиреневый вместо светло-сиреневого */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 6px;
        }
        
        .ai-message {
            text-align: left;
        }
        
        .ai-bubble {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 6px;
        }
        
        .chat-history {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background-color: #fefefe;
        }
        
        .chat-history:empty:before {
            content: "Диалог будет отображаться здесь...";
            color: #999;
            font-style: italic;
        }
        
        /* Стили для анализа видео */
        .analysis-summary-content {
            width: 100%;
            white-space: normal;
            text-overflow: ellipsis;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        /* Стили для контейнера с анализом */
        #modal-analysis-markdown {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #333;
        }
        
        #modal-analysis-markdown h1, 
        #modal-analysis-markdown h2, 
        #modal-analysis-markdown h3, 
        #modal-analysis-markdown h4, 
        #modal-analysis-markdown h5, 
        #modal-analysis-markdown h6 {
            margin-top: 0.6rem;
            margin-bottom: 0.3rem;
            color: #2c3e50;
            font-weight: 600;
        }
        
        #modal-analysis-markdown p {
            margin-bottom: 0.5rem;
        }
        
        #modal-analysis-markdown ul, 
        #modal-analysis-markdown ol {
            margin-bottom: 0.5rem;
            padding-left: 1.2rem;
        }
        
        #modal-analysis-markdown li {
            margin-bottom: 0.2rem;
        }
        
        #modal-analysis-markdown blockquote {
            border-left: 4px solid #667eea;
            padding-left: 0.8rem;
            margin: 0.6rem 0;
            font-style: italic;
            color: #666;
        }
        
        #modal-analysis-markdown code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        
        #modal-analysis-markdown pre {
            background-color: #f8f9fa;
            padding: 0.8rem;
            border-radius: 5px;
            overflow-x: auto;
            margin: 0.6rem 0;
        }
        
        #modal-analysis-markdown pre code {
            background-color: transparent;
            padding: 0;
        }
        
        #modal-analysis-markdown table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.6rem 0;
            font-size: 0.85em;
        }
        
        #modal-analysis-markdown th,
        #modal-analysis-markdown td {
            border: 1px solid #dee2e6;
            padding: 0.4rem;
            text-align: left;
        }
        
        #modal-analysis-markdown th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        #modal-analysis-markdown tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        #modal-analysis-markdown strong {
            font-weight: 600;
            color: #2c3e50;
        }
        
        #modal-analysis-markdown em {
            font-style: italic;
            color: #666;
        }
        
        #modal-analysis-markdown a {
            color: #667eea;
            text-decoration: none;
        }
        
        #modal-analysis-markdown a:hover {
            text-decoration: underline;
        }
        
        #modal-analysis-markdown hr {
            border: none;
            border-top: 1px solid #dee2e6;
            margin: 0.8rem 0;
        }
        
        /* Стили для ссылок по таймкодам */
        .timelink {
            color: #dc3545 !important;
            text-decoration: none !important;
            font-weight: bold;
            background: rgba(220, 53, 69, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(220, 53, 69, 0.3);
            display: inline-block;
            margin: 0 2px;
            transition: all 0.2s ease;
        }
        
        .timelink:hover {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
        }
        
        /* Стили для форматированного текста в чате */
        .ai-bubble h3, .ai-bubble h4, .ai-bubble h5 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .ai-bubble h3 {
            font-size: 1.1em;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 5px;
        }
        
        .ai-bubble ul, .ai-bubble ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ai-bubble li {
            margin-bottom: 5px;
        }
        
        .ai-bubble p {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .ai-bubble strong {
            color: #495057;
        }
        
        /* Стили для плавающей кнопки "Обсудить" при выделении текста */
        .floating-discuss-btn {
            position: absolute;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            z-index: 1060;
            display: none;
            white-space: nowrap;
            transition: all 0.2s ease;
            animation: popIn 0.2s ease-out;
            min-height: 44px; /* Минимальный размер для тача */
            line-height: 24px;
        }
        
        /* Увеличенная кнопка для мобильных устройств */
        @media (max-width: 768px) {
            .floating-discuss-btn {
                padding: 12px 20px;
                font-size: 15px;
                border-radius: 30px;
                min-height: 48px;
                min-width: 120px;
                line-height: 24px;
            }
        }
        
        .floating-discuss-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        
        .floating-discuss-btn:active {
            transform: translateY(0);
        }
        
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Стиль для выделенного текста */
        ::selection {
            background-color: rgba(40, 167, 69, 0.2);
            color: inherit;
        }
        
        /* Переливающиеся кнопки "Обсудить с AI" в стиле заголовка */
        .btn-ai-gradient {
            background: linear-gradient(
                45deg,
                #ff6b6b,
                #4ecdc4,
                #45b7d1,
                #96ceb4,
                #feca57,
                #ff9ff3,
                #54a0ff,
                #5f27cd
            );
            background-size: 400% 400%;
            color: white;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
            animation: gradientShift 6s ease infinite;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .btn-ai-gradient:hover {
            filter: brightness(1.2) saturate(1.3);
            box-shadow: 
                0 0 20px rgba(255, 107, 107, 0.6),
                0 0 30px rgba(78, 205, 196, 0.4),
                0 0 40px rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-ai-gradient:active {
            transform: translateY(0) scale(0.98);
        }
        
                 /* Заголовок чата с градиентом как на изображении */
         .chat-header-gradient {
             background: linear-gradient(to right, #1e293b, #7c3aed);
             color: white;
             border: none;
             font-weight: 600;
         }
         
                                       /* Стили для поля ввода чата */
           #chatInput:focus {
               border-color: #8B5CF6 !important;
               box-shadow: none !important;
               outline: none !important;
           }
          
          #chatInput {
              transition: all 0.2s ease;
              box-shadow: none !important;
          }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- Header -->
    <div class="relative overflow-hidden">
        <div class="relative px-6 py-12">
            <div class="max-w-6xl mx-auto text-center">
                                 <h1 class="text-5xl font-bold text-white mb-4">
                     <i class="fas fa-play-circle text-white me-2"></i><span class="ai-gradient">ai</span><span class="text-white">Tube</span>
                 </h1>
                <p class="text-xl text-gray-300 mb-8">
                    ИИ-анализ популярных видео
                </p>
            </div>
        </div>
    </div>

    <!-- Video Grid -->
    <div class="max-w-6xl mx-auto px-6 pb-12">
        <div id="videos-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 layout-smart">
            <!-- Loading placeholder -->
            <div class="col-span-full text-center py-20">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                <p class="mt-4 text-white text-lg">Загрузка видео...</p>
            </div>
        </div>
    </div>

    <!-- Footer Stats -->
    <div class="bg-black/20 backdrop-blur-sm border-t border-white/10">
        <div class="max-w-6xl mx-auto px-6 py-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                <div>
                    <div class="text-3xl font-bold text-white mb-2" id="total-videos">-</div>
                    <div class="text-gray-400 text-sm">Всего видео</div>
                </div>
                <div>
                    <div class="text-3xl font-bold text-white mb-2" id="total-views">-</div>
                    <div class="text-gray-400 text-sm">Общие просмотры</div>
                </div>
                <div>
                    <div class="text-3xl font-bold text-white mb-2" id="total-subscribers">-</div>
                    <div class="text-gray-400 text-sm">Подписчики</div>
                </div>
                <div>
                    <div class="text-3xl font-bold text-white mb-2" id="total-duration">-</div>
                    <div class="text-gray-400 text-sm">Общее время</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalTitle">Детали видео</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="videoModalBody">
                    <!-- Контент будет загружен динамически -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentVideos = [];
        let isAdminMode = false;

        // Check admin mode on page load
        function checkAdminMode() {
            const urlParams = new URLSearchParams(window.location.search);
            isAdminMode = urlParams.get('admin') === 'true';
            console.log('[Beta] Admin mode:', isAdminMode);
        }

        // Format duration from seconds
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        // Format numbers (K, M)
        function formatNumber(num) {
            if (num >= 1000000) {
                return `${(num / 1000000).toFixed(1)}M`;
            }
            if (num >= 1000) {
                return `${(num / 1000).toFixed(1)}K`;
            }
            return num.toString();
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        // Load videos from API
        async function loadVideos() {
            try {
                const response = await fetch('/api/toptube/videos?status=analyzed&limit=50');
                const data = await response.json();
                
                if (data.success) {
                    currentVideos = data.videos;
                    renderVideos(data.videos);
                    updateStats(data.videos);
                } else {
                    console.error('Error loading videos:', data.error);
                }
            } catch (error) {
                console.error('Error loading videos:', error);
            }
        }

        // Render videos grid
        function renderVideos(videos) {
            const container = document.getElementById('videos-container');
            
            if (videos.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <div class="text-gray-400 text-6xl mb-4">📺</div>
                        <h3 class="text-white text-xl mb-2">Видео не найдены</h3>
                        <p class="text-gray-400">Попробуйте изменить фильтры</p>
                    </div>
                `;
                return;
            }

            // Используем умный алгоритм размещения для заполнения пространства без дыр
            container.innerHTML = createSmartLayout(videos);
        }

        // Умный алгоритм размещения карточек для заполнения пространства без дыр
        function createSmartLayout(videos) {
            const cols = 3; // Количество колонок в сетке (3 для FHD)
            const grid = Array(20).fill().map(() => Array(cols).fill(null)); // Создаем сетку 20x3
            
            // Сортируем видео по video_id в порядке убывания
            const sortedVideos = [...videos].sort((a, b) => b.video_id - a.video_id);
            
            // Создаем очередь видео с размерами
            const videoQueue = sortedVideos.map((video, index) => {
                const title = video.translated_title ? video.translated_title : video.title;
                const titleLength = title.length;
                
                // Получаем длину саммари (если есть)
                let summaryLength = 0;
                if (video.analysis_summary) {
                    summaryLength = video.analysis_summary.length;
                } else if (video.analysis_result) {
                    summaryLength = video.analysis_result.length;
                }
                
                // Общая длина контента для определения размера карточки
                const totalContentLength = titleLength + summaryLength;
                
                let width = 1;
                let height = 1;
                
                // Логика определения размера ТОЛЬКО на основе просмотров
                const isPopular = video.views > 500000; // Больше 500K просмотров
                
                if (isPopular) {
                    // Популярные видео - большие карточки (2x1)
                    width = 2;
                    height = 1;
                } else {
                    // Все остальные - маленькие карточки (1x1)
                    width = 1;
                    height = 1;
                }
                
                return { video, width, height, index, totalContentLength, titleLength, summaryLength };
            });
            
            let html = '';
            
            // Идем по сетке сверху вниз, слева направо
            for (let row = 0; row < grid.length; row++) {
                for (let col = 0; col < cols; col++) {
                    // Если место уже занято, пропускаем
                    if (grid[row][col] !== null) continue;
                    
                    // Ищем подходящую карточку для этого места
                    let placed = false;
                    let videoIndex = -1;
                    
                    // Сначала пробуем найти карточку, которая точно поместится
                    for (let i = 0; i < videoQueue.length; i++) {
                        const { video, width, height } = videoQueue[i];
                        
                        // Проверяем, поместится ли карточка
                        if (row + height <= grid.length && col + width <= cols) {
                            let canPlace = true;
                            
                            // Проверяем, свободно ли место
                            for (let r = row; r < row + height; r++) {
                                for (let c = col; c < col + width; c++) {
                                    if (grid[r][c] !== null) {
                                        canPlace = false;
                                        break;
                                    }
                                }
                                if (!canPlace) break;
                            }
                            
                            if (canPlace) {
                                // Размещаем карточку
                                for (let r = row; r < row + height; r++) {
                                    for (let c = col; c < col + width; c++) {
                                        grid[r][c] = i;
                                    }
                                }
                                
                                // Определяем CSS классы для размера
                                let sizeClass = '';
                                if (width === 2 && height === 2) {
                                    sizeClass = 'md:col-span-2 lg:col-span-2';
                                } else if (width === 2 && height === 1) {
                                    sizeClass = 'md:col-span-2 lg:col-span-2';
                                } else if (width === 1 && height === 2) {
                                    sizeClass = 'lg:row-span-2';
                                }
                                
                                html += createVideoCard(video, i, sizeClass);
                                
                                // Убираем карточку из очереди
                                videoQueue.splice(i, 1);
                                
                                placed = true;
                                videoIndex = i;
                                break;
                            }
                        }
                    }
                    
                    // Если не удалось разместить большую карточку, ищем маленькую (1x1)
                    if (!placed) {
                        for (let i = 0; i < videoQueue.length; i++) {
                            const { video, width, height } = videoQueue[i];
                            
                            // Ищем любую карточку, которую можно сделать маленькой
                            if (width === 1 && height === 1) {
                                // Уже маленькая - размещаем как есть
                                grid[row][col] = i;
                                html += createVideoCard(video, i, '');
                                videoQueue.splice(i, 1);
                                placed = true;
                                break;
                            } else {
                                // Большая карточка - забиваем на правило и делаем маленькой
                                grid[row][col] = i;
                                html += createVideoCard(video, i, '');
                                videoQueue.splice(i, 1);
                                placed = true;
                                break;
                            }
                        }
                    }
                    
                    // Если все карточки размещены, выходим
                    if (videoQueue.length === 0) break;
                }
                
                // Если все карточки размещены, выходим
                if (videoQueue.length === 0) break;
            }
            
            // Добавляем отладочную информацию в консоль
            console.log('[Smart Layout] Grid after placement:', grid);
            console.log('[Smart Layout] Videos placed:', sortedVideos.length - videoQueue.length);
            console.log('[Smart Layout] Remaining in queue:', videoQueue.length);
            
            return html;
        }

        // Create video card HTML
        function createVideoCard(video, index, customSizeClass = null) {
            // Проверяем, есть ли URL, если нет - создаем из video_id
            if (!video.url || video.url === 'undefined' || video.url === 'null') {
                video.url = `https://www.youtube.com/watch?v=${video.video_id}`;
            }
            
            const thumbnailUrl = `https://img.youtube.com/vi/${video.video_id}/maxresdefault.jpg`;
            const title = video.translated_title ? video.translated_title : video.title;
            
            // Определяем размер карточки
            let sizeClass = '';
            
            if (customSizeClass) {
                // Если передан кастомный размер (для умного макета)
                sizeClass = customSizeClass;
            } else {
                // Стандартная логика для обычного макета
                const isPopular = video.views > 500000; // Больше 500K просмотров
                
                if (isPopular) {
                    // Большая карточка для популярных видео
                    sizeClass = 'md:col-span-2 lg:col-span-2';
                } else {
                    // Маленькая карточка для остальных
                    sizeClass = '';
                }
            }
            
            return `
                <div class="group relative bg-white/5 backdrop-blur-sm rounded-2xl overflow-hidden border border-white/10 transition-all duration-500 hover:scale-105 hover:shadow-2xl hover:shadow-purple-500/25 ${sizeClass}">
                    <!-- Thumbnail -->
                    <div class="relative aspect-video bg-gradient-to-br from-gray-800 to-gray-900 cursor-pointer video-thumbnail-clickable" data-video-url="${video.url}" title="Кликните для просмотра оригинального видео на YouTube">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                        <img
                            src="${thumbnailUrl}"
                            alt="${title}"
                            class="w-full h-full object-cover"
                            onerror="this.src='https://img.youtube.com/vi/${video.video_id}/hqdefault.jpg'"
                        />
                        
                        <!-- Duration Badge -->
                        <div class="absolute bottom-3 right-3 bg-black/80 text-white text-sm px-2 py-1 rounded-md font-medium">
                            ${formatDuration(video.duration)}
                        </div>
                        
                        <!-- Play Button - появляется при наведении -->
                        <div class="play-button-container absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
                            <div class="play-button pointer-events-auto"></div>
                        </div>
                        
                        <!-- Click hint -->
                        <div class="absolute top-3 left-3 bg-black/60 text-white text-xs px-2 py-1 rounded-md opacity-0 hover:opacity-100 transition-all duration-300 transform translate-y-1 hover:translate-y-0">
                            YouTube
                        </div>
                    </div>

                    <!-- Content - кликабельная для открытия анализа -->
                    <div class="p-4 pb-0 space-y-3 cursor-pointer transition-colors duration-200" onclick="showVideoDetails('${video.video_id}')" title="Кликните для просмотра анализа">
                        <!-- Title -->
                        <h3 class="text-white font-semibold text-sm leading-tight">
                            ${title}
                        </h3>
                        
                        <!-- Summary (если есть) -->
                        ${video.analysis_summary ? `
                            <p class="text-gray-300 text-sm leading-tight opacity-80">
                                ${video.analysis_summary}
                            </p>
                        ` : video.analysis_result ? `
                            <p class="text-gray-300 text-sm leading-tight opacity-80">
                                ${video.analysis_result}
                            </p>
                        ` : ''}
                        
                        <!-- Channel -->
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-xs font-bold">
                                    ${video.channel_title.charAt(0)}
                                </span>
                            </div>
                            <span class="text-gray-300 text-sm font-medium">
                                ${video.channel_title}
                            </span>
                        </div>

                        <!-- Stats -->
                        <div class="flex items-center justify-between text-xs text-gray-400">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <span>${formatNumber(video.views)} просм.</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                    <span>${formatNumber(video.subscribers)}</span>
                                </div>
                            </div>
                            <span>${formatDate(video.published_at)}</span>
                        </div>

                        <!-- Analysis hint -->
                        <div class="text-center mt-2">
                            <div class="text-blue-400 text-xs opacity-0 hover:opacity-100 transition-opacity duration-300">
                                <i class="fas fa-chart-line me-1"></i>Кликните для анализа
                            </div>
                        </div>
                    </div>

                    <!-- Hover Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-purple-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                </div>
            `;
        }

        // Try to open modal by URL parameter
        function tryOpenModalByParam() {
            const params = new URLSearchParams(window.location.search);
            const videoId = params.get('video');
            if (videoId) {
                const video = currentVideos.find(v => v.video_id === videoId);
                if (video) {
                    showVideoDetails(videoId);
                } else {
                    // Если видео еще не загружены, пробуем снова через 300мс
                    setTimeout(tryOpenModalByParam, 300);
                }
            }
        }

        // Show video details modal
        function showVideoDetails(videoId) {
            const video = currentVideos.find(v => v.video_id === videoId);
            if (!video) return;

            const modalTitle = document.getElementById('videoModalTitle');
            const modalBody = document.getElementById('videoModalBody');
            const thumbnailUrl = `https://img.youtube.com/vi/${video.video_id}/maxresdefault.jpg`;
            
            modalTitle.textContent = video.translated_title ? video.translated_title : video.title;
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-2">
                            <img src="${thumbnailUrl}" alt="${video.translated_title ? video.translated_title : video.title}" 
                                 class="img-fluid rounded" style="max-width: 180px; max-height: 110px; object-fit:cover;"
                                 onerror="this.src='https://img.youtube.com/vi/${video.video_id}/hqdefault.jpg'">
                        </div>
                        <div style="font-size:0.95em;">
                          <div><strong>Канал:</strong> ${video.channel_title}</div>
                          <div><strong>Длительность:</strong> ${formatDuration(video.duration)}</div>
                          <div><strong>Просмотры:</strong> ${formatNumber(video.views)}</div>
                          <div><strong>Подписчики:</strong> ${formatNumber(video.subscribers)}</div>
                          <div><strong>Дата публикации:</strong> ${formatDate(video.published_at)}</div>
                        </div>
                        <a href="${video.url}" target="_blank" class="btn btn-primary btn-sm w-100 mt-2">
                            <i class="fas fa-external-link-alt me-1"></i> YouTube
                        </a>
                        <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="shareVideo('${video.video_id}')">
                            <i class="fas fa-share-alt"></i> Поделиться
                        </button>
                        ${video.analysis_result || video.analysis_summary ? `
                            <button class="btn btn-ai-gradient btn-sm w-100 mt-2" onclick="toggleVideoChat()">
                                <i class="fas fa-robot me-1"></i> Обсудить с ИИ
                            </button>
                        ` : ''}
                    </div>
                    <div class="col-md-8">
                        <div id="modal-analysis-markdown"></div>
                        
                        <!-- Кнопка "Обсудить с AI" внизу контента -->
                        ${video.analysis_result || video.analysis_summary ? `
                            <div class="mt-4 text-center">
                                <button class="btn btn-ai-gradient" onclick="toggleVideoChat()">
                                    <i class="fas fa-robot me-2"></i>Обсудить с ИИ
                                </button>
                            </div>
                        ` : ''}
                        
                    </div>
                </div>
                
                <!-- Диалог для обсуждения (скрыт по умолчанию) -->
                <div id="videoChatSection" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header chat-header-gradient">
                            <h6 class="mb-0 text-white">
                                <i class="fas fa-robot me-2"></i>Обсуждение с ИИ
                                <button type="button" class="btn btn-sm btn-outline-light float-end" onclick="toggleVideoChat()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- История диалога -->
                            <div id="chatHistory" class="chat-history mb-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-muted text-center py-3">
                                    <i class="fas fa-robot me-2"></i>
                                    Привет! Готов обсудить это видео. О чем хотите поговорить?
                                </div>
                            </div>
                            
                            <!-- Поле для ввода сообщения -->
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="Задайте вопрос о содержании видео..." onkeypress="handleChatKeyPress(event)" style="border-color: #8B5CF6; box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25);">
                                <button class="btn" type="button" onclick="sendChatMessage()" style="background-color: #8B5CF6; border-color: #8B5CF6; color: white;">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            
                            <!-- Индикатор загрузки -->
                            <div id="chatLoader" class="text-center mt-2" style="display: none;">
                                <!-- КРУЖОЧЕК - крутится отдельно -->
                                <div class="spinner-border spinner-border-sm text-success me-2" role="status">
                                    <span class="visually-hidden">Думаю...</span>
                                </div>
                                <!-- ТЕКСТ - стоит на месте отдельно -->
                                <span class="text-muted">ИИ обдумывает ответ...</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const analysisDiv = document.getElementById('modal-analysis-markdown');
                if (video.analysis_result) {
                    if (window.marked) {
                        analysisDiv.innerHTML = window.marked.parse(video.analysis_result);
                    } else {
                        analysisDiv.textContent = video.analysis_result;
                    }
                } else if (video.analysis_summary) {
                    analysisDiv.innerHTML = `<div class="analysis-summary-content">${video.analysis_summary}</div>`;
                } else {
                    analysisDiv.innerHTML = '<p class="text-muted">Анализ недоступен</p>';
                }
                
                // Сохраняем ID видео для чата
                const previousVideoId = window.currentVideoId;
                window.currentVideoId = videoId;
                console.log(`[VideoModal] Переключение видео: ${previousVideoId || 'none'} → ${videoId}`);
                
                // НЕ отменяем запросы - позволяем им завершиться и сохранить ответы в соответствующие чаты
                if (previousVideoId && previousVideoId !== videoId) {
                    console.log(`[RequestIsolation] Переключение ${previousVideoId} → ${videoId}. Активные запросы предыдущего видео продолжат выполнение`);
                }
                
                // Загружаем умные подсказки для видео (асинхронно)
                if (video.analysis_result || video.analysis_summary) {
                    loadVideoSuggestions(videoId);
                }
            }, 0);
            // Очищаем предыдущее выделение при открытии нового видео
            clearTextSelectionAndButton();
            
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            
            // Добавляем обработчик закрытия модала
            const modalElement = document.getElementById('videoModal');
            modalElement.addEventListener('hidden.bs.modal', function () {
                console.log('[Modal] Модал закрыт, очищаем выделение');
                clearTextSelectionAndButton();
            });
            
            modal.show();
        }

        // Update footer stats
        function updateStats(videos) {
            const totalVideos = videos.length;
            const totalViews = videos.reduce((sum, v) => sum + v.views, 0);
            const totalSubscribers = videos.reduce((sum, v) => sum + v.subscribers, 0);
            const totalDuration = videos.reduce((sum, v) => sum + v.duration, 0);
            
            document.getElementById('total-videos').textContent = totalVideos;
            document.getElementById('total-views').textContent = formatNumber(totalViews);
            document.getElementById('total-subscribers').textContent = formatNumber(totalSubscribers);
            document.getElementById('total-duration').textContent = Math.round(totalDuration / 3600) + 'ч';
        }

        // Share video function
        function shareVideo(videoId) {
            const url = `${window.location.origin}/beta?video=${videoId}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Ссылка скопирована!');
            });
        }

        // Open original video in new tab
        function openOriginalVideo(videoUrl) {
            if (videoUrl && videoUrl !== 'undefined' && videoUrl !== 'null') {
                try {
                    window.open(videoUrl, '_blank');
                } catch (error) {
                    // Fallback: try to navigate in same tab
                    window.location.href = videoUrl;
                }
            } else {
                alert('Ошибка: неверный URL видео');
            }
        }

        // === ФУНКЦИИ ДЛЯ ВИДЕО ДИАЛОГОВ ===
        
        function startVideoChat(videoId) {
            // Открываем детали видео и сразу показываем диалог
            showVideoDetails(videoId);
            setTimeout(() => {
                toggleVideoChat();
            }, 100);
        }

        function toggleVideoChat() {
            const chatSection = document.getElementById('videoChatSection');
            const isVisible = chatSection.style.display !== 'none';
            
            if (isVisible) {
                // Скрываем диалог
                chatSection.style.display = 'none';
            } else {
                // Показываем диалог
                chatSection.style.display = 'block';
                // Фокусируемся на поле ввода
                document.getElementById('chatInput').focus();
                // Инициализируем диалог если нужно
                initializeVideoChat();
            }
        }

        function initializeVideoChat() {
            const chatHistory = document.getElementById('chatHistory');
            // Очищаем старое приветственное сообщение
            chatHistory.innerHTML = '';
            
            console.log(`[ChatHistory] Инициализация чата для видео ${window.currentVideoId}`);
            
            // Восстанавливаем историю из памяти
            if (window.currentVideoId) {
                const savedHistory = getChatHistory(window.currentVideoId);
                console.log(`[ChatHistory] Восстанавливаем ${savedHistory.length} сообщений для видео ${window.currentVideoId}`);
                
                // Проверяем есть ли новые ответы (сообщения assistant которые пришли пока видео было неактивно)
                let newResponses = 0;
                if (savedHistory.length > 0) {
                    // Считаем сколько сообщений assistant в конце истории
                    for (let i = savedHistory.length - 1; i >= 0; i--) {
                        if (savedHistory[i].role === 'assistant' && 
                            savedHistory[i].timestamp > (Date.now() - 60000)) { // за последнюю минуту
                            newResponses++;
                        } else {
                            break;
                        }
                    }
                    
                    if (newResponses > 0) {
                        console.log(`[ChatHistory] 🔔 Найдено ${newResponses} новых ответов для видео ${window.currentVideoId}!`);
                    }
                }
                
                savedHistory.forEach(msg => {
                    // Используем skipSave=true чтобы НЕ дублировать сообщения в истории
                    addChatMessage(msg.role, msg.content, null, true);
                });
            }
            
            // Если истории нет, добавляем приветственное сообщение с умными подсказками
            if (chatHistory.children.length === 0) {
                const smartSuggestions = window.currentVideoId ? getVideoSuggestions(window.currentVideoId) : getFallbackSuggestions();
                addChatMessage('welcome', 'Привет! Готов обсудить это видео. Вот несколько идей для разговора:', smartSuggestions);
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!window.currentVideoId) {
                alert('Ошибка: не выбрано видео для обсуждения');
                return;
            }
            
            // КРИТИЧНО: Захватываем videoId в начале функции для изоляции
            const videoId = window.currentVideoId;
            console.log(`[ChatIsolation] Отправляем сообщение для видео ${videoId}: "${message.substring(0, 50)}..."`);
            
            // Проверяем не заблокирован ли уже этот видео
            if (window.videoLoadingStates && window.videoLoadingStates[videoId]) {
                console.log(`[ChatIsolation] Видео ${videoId} уже обрабатывает запрос, игнорируем`);
                return;
            }
            
            // Отменяем предыдущий запрос для этого же видео чтобы избежать дублирования
            if (window.videoRequestControllers[videoId]) {
                console.log(`[ChatIsolation] Отменяем предыдущий запрос для видео ${videoId} чтобы избежать дублирования`);
                window.videoRequestControllers[videoId].abort();
                delete window.videoRequestControllers[videoId];
            }
            
            // Добавляем сообщение пользователя (только если это еще активное видео)
            if (window.currentVideoId === videoId) {
                addChatMessage('user', message);
                input.value = ''; // Очищаем поле ввода
            } else {
                console.log(`[ChatIsolation] Видео ${videoId} больше не активно, отменяем`);
                return;
            }
            
            // Включаем индикатор загрузки для этого видео
            setVideoLoading(videoId, true);
            
            try {
                // Создаем AbortController для этого запроса
                const controller = new AbortController();
                window.videoRequestControllers[videoId] = controller;
                
                // Получаем историю диалога для конкретного видео
                const history = getChatHistory(videoId);
                
                console.log(`[ChatIsolation] Отправляем API запрос для видео ${videoId}`);
                
                // Отправляем запрос к API с abort signal
                const response = await fetch(`/api/videos/${videoId}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: history
                    }),
                    signal: controller.signal
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`[ChatIsolation] Получен ответ для видео ${videoId}, модель: ${data.model_used}`);
                    
                    // Сохраняем ответ в историю соответствующего видео
                    saveChatMessage(videoId, 'assistant', data.response);
                    
                    // Показываем в UI только если это активное видео
                    if (window.currentVideoId === videoId) {
                        addChatMessage('ai', data.response, null, true); // skipSave=true, уже сохранили выше
                    } else {
                        console.log(`[ChatIsolation] Ответ сохранен в историю неактивного видео ${videoId}, будет показан при возвращении`);
                    }
                } else {
                    console.log(`[ChatIsolation] Ошибка API для видео ${videoId}: ${data.error}`);
                    
                    // Сохраняем сообщение об ошибке
                    const errorMessage = `❌ Ошибка: ${data.error}`;
                    saveChatMessage(videoId, 'assistant', errorMessage);
                    
                    // Показываем в UI только если это активное видео
                    if (window.currentVideoId === videoId) {
                        addChatMessage('ai', errorMessage, null, true); // skipSave=true
                    } else {
                        console.log(`[ChatIsolation] Ошибка сохранена в историю неактивного видео ${videoId}`);
                    }
                }
                
            } catch (error) {
                // Игнорируем ошибки отмененных запросов
                if (error.name === 'AbortError') {
                    console.log(`[ChatIsolation] Запрос для видео ${videoId} отменен`);
                    return;
                }
                
                console.error(`[ChatIsolation] Ошибка сети для видео ${videoId}:`, error);
                
                // Сохраняем сообщение об ошибке сети в историю
                const networkErrorMessage = '❌ Ошибка сети. Проверьте подключение к интернету.';
                saveChatMessage(videoId, 'assistant', networkErrorMessage);
                
                // Показываем в UI только если это активное видео
                if (window.currentVideoId === videoId) {
                    addChatMessage('ai', networkErrorMessage, null, true); // skipSave=true
                } else {
                    console.log(`[ChatIsolation] Ошибка сети сохранена в историю неактивного видео ${videoId}`);
                }
            } finally {
                // Убираем контроллер из активных
                if (window.videoRequestControllers[videoId]) {
                    delete window.videoRequestControllers[videoId];
                }
                
                // Отключаем индикатор загрузки для этого видео
                setVideoLoading(videoId, false);
            }
        }

        // === УМНЫЕ ПОДСКАЗКИ ===
        
        function loadVideoSuggestions(videoId) {
            console.log(`[Suggestions] Запрос подсказок для видео ${videoId}`);
            
            // Проверяем кеш подсказок
            if (window.videoSuggestions && window.videoSuggestions[videoId]) {
                console.log(`[Suggestions] Используем кешированные подсказки для ${videoId}`);
                return;
            }
            
            // Инициализируем хранилище подсказок
            if (!window.videoSuggestions) {
                window.videoSuggestions = {};
            }
            
            // Помечаем что подсказки загружаются
            window.videoSuggestions[videoId] = 'loading';
            
            // Асинхронный запрос подсказок
            fetch(`/api/videos/${videoId}/suggestions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.suggestions) {
                        window.videoSuggestions[videoId] = data.suggestions;
                        if (data.generated_by_ai && data.model_used) {
                            console.log(`[Suggestions] Загружено ${data.suggestions.length} умных подсказок для ${videoId} (модель: ${data.model_used})`);
                        } else {
                            console.log(`[Suggestions] Загружено ${data.suggestions.length} стандартных подсказок для ${videoId}`);
                        }
                    } else {
                        console.log(`[Suggestions] Ошибка при загрузке подсказок: ${data.error || 'Неизвестная ошибка'}`);
                        window.videoSuggestions[videoId] = getFallbackSuggestions();
                    }
                })
                .catch(error => {
                    console.error(`[Suggestions] Ошибка запроса подсказок:`, error);
                    window.videoSuggestions[videoId] = getFallbackSuggestions();
                });
        }
        
        function getFallbackSuggestions() {
            return [
                "🤔 Объясни главную идею простыми словами",
                "📊 Какие факты и данные наиболее важные?",
                "💡 Что было самым неожиданным открытием?",
                "🔍 На какие моменты стоит обратить внимание?"
            ];
        }
        
        function getVideoSuggestions(videoId) {
            if (!window.videoSuggestions || !window.videoSuggestions[videoId]) {
                console.log(`[Suggestions] Нет подсказок для видео ${videoId}, используем fallback`);
                return getFallbackSuggestions();
            }
            
            const suggestions = window.videoSuggestions[videoId];
            
            // Если подсказки ещё загружаются, возвращаем fallback
            if (suggestions === 'loading') {
                console.log(`[Suggestions] Подсказки для видео ${videoId} загружаются, используем fallback`);
                return getFallbackSuggestions();
            }
            
            if (Array.isArray(suggestions)) {
                console.log(`[Suggestions] Используем ${suggestions.length} подсказок для видео ${videoId}`);
                return suggestions;
            } else {
                console.log(`[Suggestions] Неверный формат подсказок для видео ${videoId}:`, suggestions);
                return getFallbackSuggestions();
            }
        }

        // === ФОРМАТИРОВАНИЕ СООБЩЕНИЙ ===
        
        function parseMarkdown(text) {
            if (!text) return text;
            
            // Экранируем HTML теги
            text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Заголовки
            text = text.replace(/^### (.*$)/gim, '<h5>$1</h5>');
            text = text.replace(/^## (.*$)/gim, '<h4>$1</h4>');
            text = text.replace(/^# (.*$)/gim, '<h3>$1</h3>');
            
            // Жирный текст
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Курсив
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Списки
            text = text.replace(/^\* (.*$)/gim, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Нумерованные списки
            text = text.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // Переносы строк
            text = text.replace(/\n\n/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            
            // Обрамляем в параграфы если есть переносы
            if (text.includes('<br>') || text.includes('</p><p>')) {
                text = '<p>' + text + '</p>';
            }
            
            return text;
        }
        
        function addTimecodeLinks(text) {
            if (!text || !window.currentVideoId) return text;
            
            // Паттерн для поиска таймкодов: (00:05:48) или 00:05:48 или (05:48)
            const timePattern = /(\()?(\d{1,2}:\d{2}(?::\d{2})?)\)?/g;
            
            return text.replace(timePattern, (match, paren, time) => {
                console.log(`[Timelink] Обрабатываем таймкод: ${time}`);
                
                // Конвертируем время в секунды
                const parts = time.split(':');
                let seconds = 0;
                
                if (parts.length === 2) {
                    // Формат MM:SS
                    const minutes = parseInt(parts[0]) || 0;
                    const secs = parseInt(parts[1]) || 0;
                    seconds = minutes * 60 + secs;
                } else if (parts.length === 3) {
                    // Формат HH:MM:SS
                    const hours = parseInt(parts[0]) || 0;
                    const minutes = parseInt(parts[1]) || 0;
                    const secs = parseInt(parts[2]) || 0;
                    seconds = hours * 3600 + minutes * 60 + secs;
                }
                
                console.log(`[Timelink] ${time} → ${seconds} секунд`);
                
                // Создаем YouTube ссылку с таймкодом
                const youtubeUrl = `https://www.youtube.com/watch?v=${window.currentVideoId}&t=${seconds}s`;
                
                return `<a href="${youtubeUrl}" target="_blank" class="timelink" title="Перейти к ${time} в видео (${seconds}с)">${paren || ''}${time}${paren ? ')' : ''}</a>`;
            });
        }
        
        function formatAiMessage(message) {
            // Сначала Markdown, потом таймкоды
            let formatted = parseMarkdown(message);
            formatted = addTimecodeLinks(formatted);
            return formatted;
        }

        function addChatMessage(sender, message, suggestions = null, skipSave = false) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            
            // Сохраняем в истории диалога (кроме приветственного сообщения и при восстановлении истории)
            if (window.currentVideoId && sender !== 'welcome' && !skipSave) {
                console.log(`[ChatHistory] Сохраняем сообщение для видео ${window.currentVideoId}: ${sender} - "${message.substring(0, 50)}..."`);
                saveChatMessage(window.currentVideoId, sender, message);
            } else if (skipSave) {
                console.log(`[ChatHistory] Восстанавливаем сообщение (не сохраняем): ${sender} - "${message.substring(0, 50)}..."`);
            }
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-bubble user-bubble">
                        <strong>Вы:</strong> ${message}
                    </div>
                `;
            } else {
                // Форматируем сообщение от ИИ (Markdown + таймкоды)
                const formattedMessage = formatAiMessage(message);
                
                let html = `
                    <div class="message-bubble ai-bubble">
                        <strong><i class="fas fa-robot me-1"></i>ИИ:</strong> ${formattedMessage}
                `;
                
                if (suggestions && Array.isArray(suggestions) && suggestions.length > 0) {
                    console.log(`[Suggestions] Добавляем ${suggestions.length} подсказок к сообщению`);
                    html += '<div class="mt-2">';
                    suggestions.forEach((suggestion, index) => {
                        if (typeof suggestion === 'string' && suggestion.trim()) {
                            const cleanSuggestion = suggestion.replace(/[🤔📊💡🔍] /, '');
                            console.log(`[Suggestions] Подсказка ${index + 1}: "${suggestion}" -> "${cleanSuggestion}"`);
                            html += `<button class="btn btn-outline-secondary btn-sm me-2 mb-1 suggestion-btn" data-suggestion="${cleanSuggestion.replace(/"/g, '&quot;')}">${suggestion}</button>`;
                        } else {
                            console.warn(`[Suggestions] Пропускаем невалидную подсказку ${index + 1}:`, suggestion);
                        }
                    });
                    html += '</div>';
                } else if (suggestions) {
                    console.warn('[Suggestions] Подсказки не являются массивом или пусты:', suggestions);
                }
                
                html += '</div>';
                messageDiv.innerHTML = html;
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // === ФУНКЦИИ УПРАВЛЕНИЯ ИСТОРИЕЙ ЧАТА ===
        
        function getChatHistory(videoId) {
            if (!window.chatSessions) {
                window.chatSessions = {};
            }
            return window.chatSessions[videoId] || [];
        }
        
        function saveChatMessage(videoId, role, content) {
            if (!window.chatSessions) {
                window.chatSessions = {};
            }
            
            if (!window.chatSessions[videoId]) {
                window.chatSessions[videoId] = [];
            }
            
            const history = window.chatSessions[videoId];
            const message = {
                role: role === 'user' ? 'user' : 'assistant',
                content: content,
                timestamp: Date.now()
            };
            
            history.push(message);
            console.log(`[ChatHistory] Сохранено сообщение в историю видео ${videoId}. Всего сообщений: ${history.length}`);
            
            // Обрезаем до максимум 10 сообщений (5 пар user-assistant)
            if (history.length > 10) {
                const removed = history.splice(0, history.length - 10);
                console.log(`[ChatHistory] Удалено ${removed.length} старых сообщений для видео ${videoId}`);
            }
        }
        
        function clearChatHistory(videoId) {
            if (window.chatSessions && window.chatSessions[videoId]) {
                console.log(`[ChatHistory] Очищаем историю для видео ${videoId}`);
                delete window.chatSessions[videoId];
            }
        }
        
        // Функция для очистки всех висящих вопросов во всех видео
        function cleanupOrphanedQuestions() {
            let totalCleaned = 0;
            
            if (!window.chatSessions) return totalCleaned;
            
            Object.keys(window.chatSessions).forEach(videoId => {
                const history = window.chatSessions[videoId];
                
                // Идем с конца и удаляем висящие вопросы
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].role === 'user') {
                        const hasResponse = i + 1 < history.length && history[i + 1].role === 'assistant';
                        if (!hasResponse) {
                            console.log(`[Cleanup] Удаляем висящий вопрос в видео ${videoId}: "${history[i].content.substring(0, 50)}..."`);
                            history.splice(i, 1);
                            totalCleaned++;
                        }
                    }
                }
            });
            
            // Обновляем UI активного видео если что-то было очищено
            if (totalCleaned > 0 && window.currentVideoId) {
                refreshChatDisplay();
            }
            
            console.log(`[Cleanup] Очищено ${totalCleaned} висящих вопросов`);
            
            if (totalCleaned > 0) {
                console.log('Состояние после очистки:');
                debugChatSessions();
            }
            
            return totalCleaned;
        }
        
        // Быстрая статистика по видео
        function getVideoStats(videoId) {
            if (!videoId) videoId = window.currentVideoId;
            if (!videoId) return null;
            
            const history = getChatHistory(videoId);
            const hasActiveRequest = !!(window.videoRequestControllers && window.videoRequestControllers[videoId]);
            const isLoading = !!(window.videoLoadingStates && window.videoLoadingStates[videoId]);
            
            let userMessages = 0;
            let assistantMessages = 0;
            let orphanedQuestions = 0;
            
            history.forEach((msg, index) => {
                if (msg.role === 'user') {
                    userMessages++;
                    const hasResponse = index + 1 < history.length && history[index + 1].role === 'assistant';
                    if (!hasResponse) orphanedQuestions++;
                } else if (msg.role === 'assistant') {
                    assistantMessages++;
                }
            });
            
            return {
                videoId,
                isActive: videoId === window.currentVideoId,
                totalMessages: history.length,
                userMessages,
                assistantMessages,
                orphanedQuestions,
                hasActiveRequest,
                isLoading
            };
        }

        // Дебаг функция для проверки состояния всех чат-сессий
        function debugChatSessions() {
            console.log('=== DEBUG CHAT SESSIONS ===');
            console.log(`Текущее активное видео: ${window.currentVideoId}`);
            
            // История сообщений
            if (!window.chatSessions || Object.keys(window.chatSessions).length === 0) {
                console.log('История сообщений: пусто');
            } else {
                console.log('История сообщений:');
                Object.keys(window.chatSessions).forEach(videoId => {
                    const history = window.chatSessions[videoId];
                    console.log(`  - Видео ${videoId}: ${history.length} сообщений`);
                    
                    let orphanedQuestions = 0;
                    history.forEach((msg, index) => {
                        const isOrphan = msg.role === 'user' && 
                                       (index + 1 >= history.length || history[index + 1].role !== 'assistant');
                        if (isOrphan) orphanedQuestions++;
                        
                        console.log(`    ${index + 1}. ${msg.role}${isOrphan ? ' [БЕЗ ОТВЕТА]' : ''}: "${msg.content.substring(0, 50)}..."`);
                    });
                    
                    if (orphanedQuestions > 0) {
                        console.warn(`    ⚠️ ВНИМАНИЕ: ${orphanedQuestions} висящих вопросов без ответа!`);
                    }
                });
            }
            
            // Активные запросы
            if (!window.videoRequestControllers || Object.keys(window.videoRequestControllers).length === 0) {
                console.log('Активные запросы: нет');
            } else {
                console.log('Активные запросы:');
                Object.keys(window.videoRequestControllers).forEach(videoId => {
                    const isActive = videoId === window.currentVideoId;
                    console.log(`  - Видео ${videoId}: запрос в процессе ${isActive ? '[АКТИВНОЕ]' : '[ФОНОВОЕ]'}`);
                });
            }
            
            // Состояния загрузки
            if (!window.videoLoadingStates || Object.keys(window.videoLoadingStates).length === 0) {
                console.log('Состояния загрузки: нет');
            } else {
                console.log('Состояния загрузки:');
                Object.keys(window.videoLoadingStates).forEach(videoId => {
                    const isLoading = window.videoLoadingStates[videoId];
                    console.log(`[RequestIsolation] Видео ${videoId}: ${isLoading ? 'загружается' : 'готово'}`);
                });
            }
            
            // Подсказки
            if (!window.videoSuggestions || Object.keys(window.videoSuggestions).length === 0) {
                console.log('Подсказки: нет');
            } else {
                console.log('Подсказки:');
                Object.keys(window.videoSuggestions).forEach(videoId => {
                    const suggestions = window.videoSuggestions[videoId];
                    console.log(`  - Видео ${videoId}: ${Array.isArray(suggestions) ? suggestions.length + ' подсказок' : suggestions}`);
                });
            }
            
            // Общая сводка
            console.log('=== СВОДКА ===');
            if (window.chatSessions && Object.keys(window.chatSessions).length > 0) {
                console.log('Статистика по всем видео:');
                Object.keys(window.chatSessions).forEach(videoId => {
                    const stats = getVideoStats(videoId);
                    const statusParts = [];
                    if (stats.isActive) statusParts.push('АКТИВНОЕ');
                    if (stats.hasActiveRequest) statusParts.push('ЗАГРУЖАЕТСЯ');
                    if (stats.orphanedQuestions > 0) statusParts.push(`${stats.orphanedQuestions} ВИСЯЩИХ`);
                    
                    const status = statusParts.length > 0 ? ` [${statusParts.join(', ')}]` : '';
                    console.log(`  ${videoId}${status}: ${stats.userMessages} вопросов, ${stats.assistantMessages} ответов`);
                });
            } else {
                console.log('Нет активных диалогов');
            }
        }

        // === ИЗОЛЯЦИЯ ЗАПРОСОВ ПО ВИДЕО ===
        
        // Хранилище активных запросов к API по каждому видео
        window.videoRequestControllers = {};
        
        // Хранилище состояния загрузки для каждого видео
        window.videoLoadingStates = {};
        
        function abortVideoRequest(videoId) {
            if (window.videoRequestControllers[videoId]) {
                console.log(`[RequestIsolation] Отменяем запрос для видео ${videoId}`);
                window.videoRequestControllers[videoId].abort();
                delete window.videoRequestControllers[videoId];
                
                // При принудительной отмене удаляем висящий вопрос
                removeLastUserMessage(videoId);
            }
        }
        
        function removeLastUserMessage(videoId) {
            // Удаляем из истории в памяти
            if (window.chatSessions && window.chatSessions[videoId]) {
                const history = window.chatSessions[videoId];
                
                // Ищем последнее сообщение пользователя без ответа
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].role === 'user') {
                        // Проверяем есть ли после него ответ assistant
                        const hasResponse = i + 1 < history.length && history[i + 1].role === 'assistant';
                        if (!hasResponse) {
                            console.log(`[RequestIsolation] Удаляем висящий вопрос для видео ${videoId}: "${history[i].content.substring(0, 50)}..."`);
                            history.splice(i, 1);
                            
                            // Если это активное видео, обновляем UI
                            if (window.currentVideoId === videoId) {
                                refreshChatDisplay();
                            }
                            break;
                        }
                    }
                }
            }
        }
        
        function refreshChatDisplay() {
            // Перерисовываем чат для активного видео
            if (!window.currentVideoId) return;
            
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            // Очищаем текущий чат
            chatHistory.innerHTML = '';
            
            // Восстанавливаем историю без сохранения (skipSave=true)
            const savedHistory = getChatHistory(window.currentVideoId);
            savedHistory.forEach(msg => {
                addChatMessage(msg.role, msg.content, null, true);
            });
            
            // Если истории нет, показываем приветствие
            if (chatHistory.children.length === 0) {
                const smartSuggestions = getVideoSuggestions(window.currentVideoId);
                addChatMessage('welcome', 'Привет! Готов обсудить это видео. Вот несколько идей для разговора:', smartSuggestions);
            }
            
            console.log(`[RequestIsolation] Обновлен дисплей чата для видео ${window.currentVideoId}`);
        }
        
        function setVideoLoading(videoId, isLoading) {
            if (!window.videoLoadingStates) {
                window.videoLoadingStates = {};
            }
            window.videoLoadingStates[videoId] = isLoading;
            
            // Обновляем UI только если это активное видео
            if (window.currentVideoId === videoId) {
                const chatLoader = document.getElementById('chatLoader');
                if (chatLoader) {
                    chatLoader.style.display = isLoading ? 'block' : 'none';
                }
            }
            
            console.log(`[RequestIsolation] Видео ${videoId} загрузка: ${isLoading}`);
        }

        // === ОБСУЖДЕНИЕ ВЫДЕЛЕННОГО ТЕКСТА ===
        
        let selectedText = '';
        let selectedRange = null;
        
        // Создаем плавающую кнопку для обсуждения
        function createFloatingDiscussBtn() {
            if (document.getElementById('floatingDiscussBtn')) {
                return document.getElementById('floatingDiscussBtn');
            }
            
            const btn = document.createElement('button');
            btn.id = 'floatingDiscussBtn';
            btn.className = 'floating-discuss-btn';
            btn.innerHTML = '<i class="fas fa-comments me-1"></i>Обсудить';
            btn.onclick = discussSelectedText;
            document.body.appendChild(btn);
            return btn;
        }
        
        // Обработчик выделения текста в модальном окне
        function handleTextSelection() {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            const btn = createFloatingDiscussBtn();
            
            if (text.length > 0) {
                selectedText = text;
                selectedRange = selection.getRangeAt(0);
                
                // Показываем кнопку рядом с выделением
                const rect = selectedRange.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                
                btn.style.display = 'block';
                
                // Особое позиционирование для мобильных устройств
                if (isMobileDevice()) {
                    // На мобилках позиционируем по центру экрана, но ниже выделения
                    const buttonWidth = 120; // примерная ширина кнопки
                    const leftPosition = Math.max(10, Math.min(
                        window.innerWidth - buttonWidth - 10,
                        rect.left + scrollLeft + rect.width / 2 - buttonWidth / 2
                    ));
                    
                    btn.style.left = leftPosition + 'px';
                    btn.style.top = (rect.bottom + scrollTop + 15) + 'px'; // больше отступ для мобилок
                } else {
                    // Стандартное позиционирование для десктопа
                    btn.style.left = (rect.left + scrollLeft + rect.width / 2 - btn.offsetWidth / 2) + 'px';
                    btn.style.top = (rect.bottom + scrollTop + 8) + 'px';
                }
                
                console.log(`[TextSelection] Выделен текст: "${text.substring(0, 100)}..."`);
            } else {
                btn.style.display = 'none';
                selectedText = '';
                selectedRange = null;
            }
        }
        
        // Обработчик клика по кнопке "Обсудить"
        function discussSelectedText() {
            if (!selectedText || !window.currentVideoId) {
                console.log('[TextSelection] Нет выделенного текста или активного видео');
                return;
            }
            
            // КРИТИЧНО: Захватываем videoId для изоляции
            const videoId = window.currentVideoId;
            console.log(`[TextSelection] Инициируем диалог для видео ${videoId} с выделенным текстом: "${selectedText.substring(0, 100)}..."`);
            
            // Открываем чат если он закрыт
            const chatSection = document.getElementById('videoChatSection');
            if (chatSection.style.display === 'none') {
                toggleVideoChat();
            }
            
            // Проверяем что видео еще активно
            if (window.currentVideoId !== videoId) {
                console.log(`[TextSelection] Видео ${videoId} больше не активно, отменяем обсуждение`);
                return;
            }
            
            // Формируем сообщение с контекстом
            const message = `Объясни этот фрагмент из видео: "${selectedText}"`;
            
            // Вставляем в поле ввода
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = message;
                chatInput.focus();
                
                // Автоматически отправляем сообщение (с небольшой задержкой)
                setTimeout(() => {
                    // Финальная проверка актуальности видео перед отправкой
                    if (window.currentVideoId === videoId) {
                        sendChatMessage();
                    } else {
                        console.log(`[TextSelection] Видео изменилось, отменяем автоотправку`);
                    }
                }, 100);
            }
            
            // Скрываем кнопку
            const btn = document.getElementById('floatingDiscussBtn');
            if (btn) btn.style.display = 'none';
            
            // Очищаем выделение
            window.getSelection().removeAllRanges();
            selectedText = '';
            selectedRange = null;
        }
        
        // Проверка мобильного устройства
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   ('ontouchstart' in window);
        }
        
        // Функция для полной очистки выделения и кнопки
        function clearTextSelectionAndButton() {
            // Скрываем плавающую кнопку
            const btn = document.getElementById('floatingDiscussBtn');
            if (btn) {
                btn.style.display = 'none';
            }
            
            // Очищаем выделение
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
            
            // Очищаем переменные
            selectedText = '';
            selectedRange = null;
            
            console.log('[TextSelection] Очистка выделения и кнопки');
        }
        
        // Улучшенный обработчик выделения для всех устройств
        function checkTextSelectionInModal() {
            const modal = document.getElementById('videoModal');
            if (modal && modal.classList.contains('show')) {
                setTimeout(handleTextSelection, 10);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminMode();
            loadVideos();
            tryOpenModalByParam();
            
            // Добавляем глобальный обработчик кликов для превью
            document.addEventListener('click', function(e) {
                // Клик по превью - открываем исходное видео
                if (e.target.closest('.video-thumbnail-clickable')) {
                    const thumbnail = e.target.closest('.video-thumbnail-clickable');
                    const videoUrl = thumbnail.getAttribute('data-video-url');
                    if (videoUrl) {
                        openOriginalVideo(videoUrl);
                    }
                }
                
                // Клик по контенту карточки - открываем анализ (обрабатывается через onclick)
                // Клик по статусу - тоже открываем анализ
            });
            
            // Обработчик выделения для десктопа
            document.addEventListener('mouseup', checkTextSelectionInModal);
            
            // Обработчик выделения для мобильных устройств
            if (isMobileDevice()) {
                // touchend для завершения касания
                document.addEventListener('touchend', checkTextSelectionInModal);
                
                // selectionchange для изменения выделения (универсальный)
                document.addEventListener('selectionchange', function() {
                    const modal = document.getElementById('videoModal');
                    if (modal && modal.classList.contains('show')) {
                        // Небольшая задержка для мобильных устройств
                        setTimeout(handleTextSelection, 150);
                    }
                });
                
                console.log('[TextSelection] Мобильное устройство обнаружено, включены touch события');
            }
            
            // Скрываем кнопку при клике в другом месте
            document.addEventListener('click', function(e) {
                const btn = document.getElementById('floatingDiscussBtn');
                if (btn && e.target !== btn && !btn.contains(e.target)) {
                    btn.style.display = 'none';
                }
            });
            
            // Скрываем кнопку при прокрутке (обычная и внутри модала)
            document.addEventListener('scroll', function() {
                const btn = document.getElementById('floatingDiscussBtn');
                if (btn) btn.style.display = 'none';
            });
            
            // Дополнительно отслеживаем скролл внутри модального окна
            const modalBody = document.getElementById('videoModalBody');
            if (modalBody) {
                modalBody.addEventListener('scroll', function() {
                    const btn = document.getElementById('floatingDiscussBtn');
                    if (btn) btn.style.display = 'none';
                });
            }
            
            // Обработчик для кнопок подсказок (делегирование событий)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('suggestion-btn')) {
                    const suggestion = e.target.getAttribute('data-suggestion');
                    if (suggestion) {
                        const chatInput = document.getElementById('chatInput');
                        if (chatInput) {
                            chatInput.value = suggestion;
                            chatInput.focus();
                            console.log(`[Suggestions] Скопирована подсказка: "${suggestion}"`);
                        } else {
                            console.warn(`[Suggestions] Поле ввода чата не найдено для подсказки: "${suggestion}"`);
                        }
                    } else {
                        console.warn('[Suggestions] Атрибут data-suggestion не найден на кнопке');
                    }
                }
            });
        });
    </script>

    <!-- Плавающая кнопка для обсуждения выделенного текста будет создана динамически -->
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</body>
</html>
