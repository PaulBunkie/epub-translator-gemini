<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–µ—Ä–µ–≤–æ–¥: {{ book_info.filename if book_info else '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏' }}</title>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> -->
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–≤—É—Ö –∫–æ–ª–æ–Ω–æ–∫ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            display: flex;
            overflow: hidden;
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        #left-panel {
            width: 350px;
            flex-shrink: 0;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            padding: 15px;
            box-sizing: border-box;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        #main-content {
            flex-grow: 1;
            height: 100vh;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
        #left-panel h2 { margin-top: 0; font-size: 1.1em; }
        #left-panel h3 { margin-top: 15px; margin-bottom: 5px; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 3px;}
        #left-panel p { margin: 10px 0; }
        #left-panel label { display: block; margin-bottom: 3px; font-size: 0.9em; font-weight: bold; }
        #left-panel select, #left-panel button { width: 100%; padding: 6px 10px; box-sizing: border-box; margin-bottom: 5px; }
        #left-panel button { cursor: pointer; }
        #left-panel button:disabled { opacity: 0.5; cursor: not-allowed; }
        #left-panel hr { margin: 15px 0; border: 0; border-top: 1px solid #eee; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è */
        #toc-list { list-style: none; padding-left: 0; margin-top: 5px; }
        .toc-item {
            padding: 5px 0;
            padding-left: calc(var(--level, 1) * 18px - 18px);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            font-size: 0.95em;
            line-height: 1.4;
            min-height: 28px;
        }
        .toc-item:last-child { border-bottom: none; }

        .toc-link-container {
             display: flex;
             align-items: center;
             flex-grow: 1;
             margin-right: 10px;
             overflow: hidden;
        }

        .toc-link {
            cursor: pointer; text-decoration: none; color: #0056b3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        .toc-link:hover { text-decoration: underline; }
        .toc-item[data-is-active="true"] .toc-link { font-weight: bold; color: #000; }

        .toc-status {
             margin-left: 8px; font-size: 0.8em; border-radius: 3px;
             padding: 1px 4px; white-space: nowrap; flex-shrink: 0;
        }
        .status-not_translated { background-color: #eee; color: #555; }
        .status-translated { background-color: #dfd; color: #070; }
        .status-processing { background-color: #ffd; color: #a80; }
        .status-error { background-color: #fcc; color: #a00; font-weight: bold; }
        .status-completed_empty { background-color: #eee; color: #777; }

        .toc-actions {
             display: flex;
             align-items: center;
             flex-shrink: 0;
             min-width: 60px;
             justify-content: flex-end;
        }

        .action-btn {
            margin-left: 5px; text-decoration: none; font-size: 1.1em;
            cursor: pointer; vertical-align: middle; border: none;
            background: none; padding: 0; color: #007bff; flex-shrink: 0;
        }
        .action-btn:hover { color: #0056b3; }
        .download-section-link {
             margin-left: 8px;
             text-decoration: none; font-size: 0.9em;
             vertical-align: middle; color: #555;
             flex-shrink: 0;
         }
         .download-section-link:hover { color: #000; }
        .hidden { display: none !important; }
        .processing-indicator { margin-left: 5px; font-style: italic; color: #a80; flex-shrink: 0;}

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        #translation-display { margin-top: 0; padding: 15px; border: 1px solid #ddd; background-color: #f9f9f9; min-height: 100px; }
        #translation-display h3 { margin-top: 0; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #translation-content p { margin: 0 0 1em 0; line-height: 1.6; text-indent: 1.5em; }

    </style>
</head>
<body>
    <div id="left-panel">
        <h2>{{ book_info.filename if book_info else '–ö–Ω–∏–≥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞' }}</h2>
        <p>
            <button onclick="document.getElementById('upload-redirect-form').submit();">–û—Ç–∫—Ä—ã—Ç—å –¥—Ä—É–≥—É—é –∫–Ω–∏–≥—É</button>
            <form id="upload-redirect-form" action="{{ url_for('index') }}" method="get" style="display: none;"></form>
        </p>

        {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–Ω–∏–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ #}
        {% if book_info %} {# <--- –ù–ê–ß–ê–õ–û –í–ù–ï–®–ù–ï–ì–û IF #}
            <p>
                <label for="model-select">–ú–æ–¥–µ–ª—å:</label><br>
                <select id="model-select" name="model_name">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option> <!-- –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                </select>
            </p>
            <p>
                <label for="language-select">–Ø–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∞:</label><br>
                {# –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–∑—ã–∫, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π #}
                {% set current_lang = target_language | default('russian') %}
                <select id="language-select" name="target_language">
                     <option value="russian" {% if current_lang == 'russian' %}selected{% endif %}>Russian</option>
                     <option value="english" {% if current_lang == 'english' %}selected{% endif %}>English</option>
                     <option value="german" {% if current_lang == 'german' %}selected{% endif %}>German</option>
                     <option value="french" {% if current_lang == 'french' %}selected{% endif %}>French</option>
                     <option value="spanish" {% if current_lang == 'spanish' %}selected{% endif %}>Spanish</option>
                     <!-- –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ —è–∑—ã–∫–∏ -->
                </select>
            </p>
            <p>
                <button id="translate-all-btn" {% if book_info.status == 'processing' %}disabled{% endif %}>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤—Å–µ –Ω–µ–ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ</button>
            </p>
            <p>
                {# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Å–∫–∞—á–∏–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª #}
                {% set can_download_full = book_info.status in ['complete', 'complete_with_errors'] and (book_info.translated_count or 0) > 0 %}
                <a id="download-full-link"
                   href="{{ url_for('download_full', book_id=book_id, lang=current_lang) }}"
                   class="{{ '' if can_download_full else 'hidden' }}"
                   target="_blank" rel="noopener noreferrer">
                     <button id="download-full-btn" {% if not can_download_full %}disabled{% endif %}>–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç (.txt)</button>
                </a>
            </p>
            <hr>
            <h3>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</h3>
            <ul id="toc-list">
                {% if book_info.toc %} {# <--- –ù–∞—á–∞–ª–æ IF –¥–ª—è TOC #}
                    <!-- DEBUG: Rendering TOC with {{ book_info.toc | length }} items -->
                    {% for item in book_info.toc %}
                        {% set section_id = item.id %}
                        {% if section_id %} {# <--- –ù–∞—á–∞–ª–æ IF –¥–ª—è section_id #}
                             {% set current_status = book_info.sections.get(section_id, 'not_translated') %}
                             <li class="toc-item" style="--level: {{ item.level }};"
                                 data-section-id="{{ section_id }}"
                                 data-href="{{ item.href }}"
                                 data-status="{{ current_status }}"
                                 data-is-active="false">

                                 <div class="toc-link-container">
                                     <a href="#" class="toc-link" title="{{ item.title | default('') }}">
                                         {{ item.translated_title if item.translated_title else item.title | default('(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)') }}
                                     </a>
                                     <span class="toc-status status-{{ current_status }}">
                                        {# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ #}
                                        {% set status_text = '???' %} {# –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é #}
                                        {% if current_status == 'error_context_limit' %}
                                            {% set status_text = 'Err:Limit' %}
                                        {% elif current_status == 'error_translation' %}
                                            {% set status_text = 'Err:API' %}
                                        {% elif current_status == 'error_caching' %}
                                            {% set status_text = 'Err:Cache' %}
                                        {% elif current_status == 'error_unknown' %}
                                            {% set status_text = 'Error' %}
                                        {% elif current_status == 'completed_empty' %}
                                             {% set status_text = 'Empty' %}
                                        {% elif current_status == 'translated' or current_status == 'cached' %} {# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–∞ –∫–∞–∫ Translated #}
                                             {% set status_text = 'Translated' %} {# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–æ–≤–æ #}
                                        {% elif current_status == 'processing' %}
                                             {% set status_text = 'Processing' %} {# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–æ–≤–æ #}
                                        {% elif current_status == 'not_translated' %}
                                             {% set status_text = 'Not Translated' %} {# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–æ–≤–∞ #}
                                        {% endif %} {# <--- –ó–∞–∫—Ä—ã–≤–∞–µ–º IF/ELIF –±–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ #}
                                        {{ status_text }}
                                    </span>
                                     <span class="processing-indicator" style="{{ 'display: none;' if current_status != 'processing' else '' }}">(...)</span>
                                 </div>

                                  <div class="toc-actions">
                                      <button class="action-btn update-translation-btn {{ 'hidden' if current_status in ['not_translated', 'processing'] }}"
                                            title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–∞–Ω–æ–≤–æ / –û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥">üîÑ</button>

                                      <a href="{{ url_for('download_section', book_id=book_id, section_id=section_id, lang=current_lang) }}"
                                         class="download-section-link {{ 'hidden' if current_status not in ['translated', 'completed_empty', 'cached'] }}"
                                         title="–°–∫–∞—á–∞—Ç—å —Ä–∞–∑–¥–µ–ª">üíæ</a>
                                 </div>
                             </li>
                        {% endif %} {# <--- –ö–æ–Ω–µ—Ü IF –¥–ª—è section_id #}
                    {% endfor %}
                     <!-- DEBUG: Finished rendering TOC -->
                {% else %}
                    <li>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –ø—É—Å—Ç–æ.</li>
                {% endif %} {# <--- –ö–æ–Ω–µ—Ü IF –¥–ª—è TOC #}
            </ul>
        {% else %} {# <--- ELSE –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ IF book_info #}
             <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–Ω–∏–≥—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</p>
        {% endif %} {# <--- –ö–û–ù–ï–¶ –í–ù–ï–®–ù–ï–ì–û IF book_info #}
    </div> <!-- –ö–æ–Ω–µ—Ü left-panel -->

    <div id="main-content">
         <div id="translation-display" style="display: none;"> {# –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é #}
             <h3><span id="translation-section-id">–†–∞–∑–¥–µ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span></h3>
             <div id="translation-content"><p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤—É –≤ –æ–≥–ª–∞–≤–ª–µ–Ω–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞.</p></div>
        </div>
    </div> <!-- –ö–æ–Ω–µ—Ü main-content -->

    <!-- –ü–µ—Ä–µ–¥–∞–µ–º ID –∫–Ω–∏–≥–∏ –≤ JavaScript -->
    <script>
        const currentBookId = "{{ book_id | default('None') }}"; // –ü–µ—Ä–µ–¥–∞–µ–º 'None' –∫–∞–∫ —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ ID –Ω–µ—Ç
        // –Ø–∑—ã–∫ –∏ –º–æ–¥–µ–ª—å —Ç–µ–ø–µ—Ä—å –±–µ—Ä—É—Ç—Å—è –∏–∑ select –≤ JS
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>