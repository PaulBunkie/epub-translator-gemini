<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Перевод: {{ book_info.filename if book_info else 'Загрузка книги' }}</title>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> -->
    <style>
        /* Базовые стили для двух колонок */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            display: flex;
            overflow: hidden;
        }

        /* Левая панель */
        #left-panel {
            width: 350px;
            flex-shrink: 0;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            padding: 15px;
            box-sizing: border-box;
        }

        /* Основной контент */
        #main-content {
            flex-grow: 1;
            height: 100vh;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
        }

        /* Стили для элементов управления в левой панели */
        #left-panel h2 { margin-top: 0; font-size: 1.1em; }
        #left-panel h3 { margin-top: 15px; margin-bottom: 5px; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 3px;}
        #left-panel p { margin: 10px 0; }
        #left-panel label { display: block; margin-bottom: 3px; font-size: 0.9em; font-weight: bold; }
        #left-panel select, #left-panel button { width: 100%; padding: 6px 10px; box-sizing: border-box; margin-bottom: 5px; }
        #left-panel button { cursor: pointer; }
        #left-panel button:disabled { opacity: 0.5; cursor: not-allowed; }
        #left-panel hr { margin: 15px 0; border: 0; border-top: 1px solid #eee; }

        /* Стили для оглавления */
        #toc-list { list-style: none; padding-left: 0; margin-top: 5px; }
        .toc-item {
            padding: 5px 0;
            padding-left: calc(var(--level, 1) * 18px - 18px);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            font-size: 0.95em;
            line-height: 1.4;
            min-height: 28px;
        }
        .toc-item:last-child { border-bottom: none; }

        .toc-link-container {
             display: flex;
             align-items: center;
             flex-grow: 1;
             margin-right: 10px;
             overflow: hidden;
        }

        .toc-link {
            cursor: pointer; text-decoration: none; color: #0056b3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        .toc-link:hover { text-decoration: underline; }
        .toc-item[data-is-active="true"] .toc-link { font-weight: bold; color: #000; }

        .toc-status {
             margin-left: 8px; font-size: 0.8em; border-radius: 3px;
             padding: 1px 4px; white-space: nowrap; flex-shrink: 0;
        }
        .status-not_translated { background-color: #eee; color: #555; }
        .status-translated { background-color: #dfd; color: #070; }
        .status-processing { background-color: #ffd; color: #a80; }
        .status-error { background-color: #fcc; color: #a00; font-weight: bold; }
        .status-completed_empty { background-color: #eee; color: #777; }

        .toc-actions {
             display: flex;
             align-items: center;
             flex-shrink: 0;
             min-width: 60px;
             justify-content: flex-end;
        }

        .action-btn {
            margin-left: 5px; text-decoration: none; font-size: 1.1em;
            cursor: pointer; vertical-align: middle; border: none;
            background: none; padding: 0; color: #007bff; flex-shrink: 0;
        }
        .action-btn:hover { color: #0056b3; }
        .download-section-link {
             margin-left: 8px;
             text-decoration: none; font-size: 0.9em;
             vertical-align: middle; color: #555;
             flex-shrink: 0;
         }
         .download-section-link:hover { color: #000; }
        .hidden { display: none !important; }
        .processing-indicator { margin-left: 5px; font-style: italic; color: #a80; flex-shrink: 0;}

        /* Стили для основного контента */
        #translation-display { margin-top: 0; padding: 15px; border: 1px solid #ddd; background-color: #f9f9f9; min-height: 100px; }
        #translation-display h3 { margin-top: 0; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #translation-content p { margin: 0 0 1em 0; line-height: 1.6; text-indent: 1.5em; }

    </style>
</head>
<body>
    <div id="left-panel">
        <h2>{{ book_info.filename if book_info else 'Книга не загружена' }}</h2>
        <p>
            <button onclick="document.getElementById('upload-redirect-form').submit();">Открыть другую книгу</button>
            <form id="upload-redirect-form" action="{{ url_for('index') }}" method="get" style="display: none;"></form>
        </p>

        {# Показываем блок управления только если книга загружена #}
        {% if book_info %} {# <--- НАЧАЛО ВНЕШНЕГО IF #}
            <p>
                <label for="model-select">Модель:</label><br>
                <select id="model-select" name="model_name">
                    <option value="">Загрузка...</option> <!-- Начальное состояние -->
                </select>
            </p>
            <p>
                <label for="language-select">Язык перевода:</label><br>
                {# Используем язык, переданный в контексте, или дефолтный #}
                {% set current_lang = target_language | default('russian') %}
                <select id="language-select" name="target_language">
                     <option value="russian" {% if current_lang == 'russian' %}selected{% endif %}>Russian</option>
                     <option value="english" {% if current_lang == 'english' %}selected{% endif %}>English</option>
                     <option value="german" {% if current_lang == 'german' %}selected{% endif %}>German</option>
                     <option value="french" {% if current_lang == 'french' %}selected{% endif %}>French</option>
                     <option value="spanish" {% if current_lang == 'spanish' %}selected{% endif %}>Spanish</option>
                     <!-- Добавьте другие языки -->
                </select>
            </p>
            <p>
                <button id="translate-all-btn" {% if book_info.status == 'processing' %}disabled{% endif %}>Перевести все непроведенные</button>
            </p>
            <p>
                {# Определяем, можно ли скачивать полный файл #}
                {% set can_download_full = book_info.status in ['complete', 'complete_with_errors'] and (book_info.translated_count or 0) > 0 %}
                <a id="download-full-link"
                   href="{{ url_for('download_full', book_id=book_id, lang=current_lang) }}"
                   class="{{ '' if can_download_full else 'hidden' }}"
                   target="_blank" rel="noopener noreferrer">
                     <button id="download-full-btn" {% if not can_download_full %}disabled{% endif %}>Скачать весь текст (.txt)</button>
                </a>
            </p>
            <hr>
            <h3>Оглавление</h3>
            <ul id="toc-list">
                {% if book_info.toc %} {# <--- Начало IF для TOC #}
                    <!-- DEBUG: Rendering TOC with {{ book_info.toc | length }} items -->
                    {% for item in book_info.toc %}
                        {% set section_id = item.id %}
                        {% if section_id %} {# <--- Начало IF для section_id #}
                             {% set current_status = book_info.sections.get(section_id, 'not_translated') %}
                             <li class="toc-item" style="--level: {{ item.level }};"
                                 data-section-id="{{ section_id }}"
                                 data-href="{{ item.href }}"
                                 data-status="{{ current_status }}"
                                 data-is-active="false">

                                 <div class="toc-link-container">
                                     <a href="#" class="toc-link" title="{{ item.title | default('') }}">
                                         {{ item.translated_title if item.translated_title else item.title | default('(Без названия)') }}
                                     </a>
                                     <span class="toc-status status-{{ current_status }}">
                                        {# Форматируем текст статуса для читаемости #}
                                        {% set status_text = '???' %} {# Значение по умолчанию #}
                                        {% if current_status == 'error_context_limit' %}
                                            {% set status_text = 'Err:Limit' %}
                                        {% elif current_status == 'error_translation' %}
                                            {% set status_text = 'Err:API' %}
                                        {% elif current_status == 'error_caching' %}
                                            {% set status_text = 'Err:Cache' %}
                                        {% elif current_status == 'error_unknown' %}
                                            {% set status_text = 'Error' %}
                                        {% elif current_status == 'completed_empty' %}
                                             {% set status_text = 'Empty' %}
                                        {% elif current_status == 'translated' or current_status == 'cached' %} {# Обрабатываем оба как Translated #}
                                             {% set status_text = 'Translated' %} {# Используем слово #}
                                        {% elif current_status == 'processing' %}
                                             {% set status_text = 'Processing' %} {# Используем слово #}
                                        {% elif current_status == 'not_translated' %}
                                             {% set status_text = 'Not Translated' %} {# Используем слова #}
                                        {% endif %} {# <--- Закрываем IF/ELIF блок статуса #}
                                        {{ status_text }}
                                    </span>
                                     <span class="processing-indicator" style="{{ 'display: none;' if current_status != 'processing' else '' }}">(...)</span>
                                 </div>

                                  <div class="toc-actions">
                                      <button class="action-btn update-translation-btn {{ 'hidden' if current_status in ['not_translated', 'processing'] }}"
                                            title="Перевести заново / Обновить перевод">🔄</button>

                                      <a href="{{ url_for('download_section', book_id=book_id, section_id=section_id, lang=current_lang) }}"
                                         class="download-section-link {{ 'hidden' if current_status not in ['translated', 'completed_empty', 'cached'] }}"
                                         title="Скачать раздел">💾</a>
                                 </div>
                             </li>
                        {% endif %} {# <--- Конец IF для section_id #}
                    {% endfor %}
                     <!-- DEBUG: Finished rendering TOC -->
                {% else %}
                    <li>Оглавление не найдено или пусто.</li>
                {% endif %} {# <--- Конец IF для TOC #}
            </ul>
        {% else %} {# <--- ELSE для внешнего IF book_info #}
             <p>Загрузите книгу, чтобы увидеть оглавление и элементы управления.</p>
        {% endif %} {# <--- КОНЕЦ ВНЕШНЕГО IF book_info #}
    </div> <!-- Конец left-panel -->

    <div id="main-content">
         <div id="translation-display" style="display: none;"> {# Скрываем по умолчанию #}
             <h3><span id="translation-section-id">Раздел не выбран</span></h3>
             <div id="translation-content"><p>Нажмите на главу в оглавлении для просмотра или перевода.</p></div>
        </div>
    </div> <!-- Конец main-content -->

    <!-- Передаем ID книги в JavaScript -->
    <script>
        const currentBookId = "{{ book_id | default('None') }}"; // Передаем 'None' как строку, если ID нет
        // Язык и модель теперь берутся из select в JS
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>