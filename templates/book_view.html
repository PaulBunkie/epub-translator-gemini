<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–µ—Ä–µ–≤–æ–¥: {{ (book_info.filename.replace('.epub', '').replace('_', ' ')) if book_info else '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏' }}</title>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–≤—É—Ö –∫–æ–ª–æ–Ω–æ–∫ */
        html, body {
            height: 100%; margin: 0; padding: 0; font-family: sans-serif;
            display: flex; overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ–±—â—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É body */
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        #left-panel {
            width: 350px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å—Å—è */
            height: 100vh; /* –ó–∞–Ω—è—Ç—å –≤—Å—é –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
            overflow-y: auto; /* –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è –ø–∞–Ω–µ–ª–∏ */
            border-right: 1px solid #ccc;
            padding: 15px; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
            box-sizing: border-box; /* –£—á–∏—Ç—ã–≤–∞—Ç—å padding –∏ border –≤ —à–∏—Ä–∏–Ω–µ */
            display: flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è */
            flex-direction: column; /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–¥—É—Ç —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ */
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        #main-content {
            flex-grow: 1; /* –ó–∞–Ω—è—Ç—å –≤—Å–µ –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
            height: 100vh; /* –ó–∞–Ω—è—Ç—å –≤—Å—é –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
            overflow-y: auto; /* –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
            padding: 15px; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
            box-sizing: border-box;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
        #left-panel h2 { margin-top: 0; font-size: 1.1em; word-break: break-word; flex-shrink: 0; } /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
        #left-panel h3 { margin-top: 15px; margin-bottom: 5px; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 3px; flex-shrink: 0; }
        #left-panel p { margin: 5px 0; flex-shrink: 0; } /* –£–º–µ–Ω—å—à–∏–ª –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤ */
        #left-panel label { display: block; margin-bottom: 3px; font-size: 0.9em; font-weight: bold; }

        /* –°—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–∫—Ä–æ–º–µ TOC actions) */
        #left-panel button:not(.action-btn),
        #left-panel .button-like-link button,
        #left-panel #save-prompt-ext-btn {
             cursor: pointer; background-color: #007bff; color: white; border: none;
             border-radius: 4px; padding: 6px 10px; box-sizing: border-box;
             margin-bottom: 5px; text-align: center; font-size: 0.95em;
             width: 100%; display: block; flex-shrink: 0; /* –ö–Ω–æ–ø–∫–∏ –Ω–µ —Å–∂–∏–º–∞—é—Ç—Å—è */
         }
         #left-panel button:not(.action-btn):hover,
         #left-panel .button-like-link button:hover,
         #left-panel #save-prompt-ext-btn:hover { background-color: #0056b3; }
         #left-panel button:disabled { background-color: #ccc !important; opacity: 0.7; cursor: not-allowed; }

         /* –°—Å—ã–ª–∫–∏-–∫–Ω–æ–ø–∫–∏ */
         #left-panel p > a.button-like-link { margin-bottom: 0; display: block; text-decoration: none; flex-shrink: 0; }
         #left-panel p > a.button-like-link button { margin-bottom: 5px; }
         #left-panel p > a.button-like-link:last-of-type button { margin-bottom: 0; }

         .hidden { display: none !important; }
         #left-panel select { width: 100%; padding: 6px 10px; box-sizing: border-box; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; flex-shrink: 0; }
         #left-panel hr { margin: 10px 0; border: 0; border-top: 1px solid #eee; flex-shrink: 0; }

         /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π */
         #prompt-ext-container { margin-top: 10px; margin-bottom: 10px; flex-shrink: 0; }
         #prompt-ext-container label { font-weight: normal; /* –£–±—Ä–∞–ª –∂–∏—Ä–Ω—ã–π, —Ç.–∫. h3 –≤—ã—à–µ */ display: block; margin-bottom: 5px; }
         #prompt-ext-container textarea { width: 100%; box-sizing: border-box; margin-top: 5px; font-family: monospace; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; padding: 5px; }
         #prompt-ext-container span#save-prompt-status { display: block; margin-top: 3px; margin-left: 0; font-style: italic; font-size: 0.9em; text-align: center; min-height: 1.2em; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è (TOC) */
        #toc-container { /* –ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è TOC */
            flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ */
            overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è TOC */
            margin-top: 5px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
        }
        #toc-list { list-style: none; padding-left: 0; margin: 0; } /* –£–±—Ä–∞–ª–∏ margin-top */
        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ .toc-item, .toc-link-container –∏ —Ç.–¥. –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
        .toc-item { padding: 5px 0; padding-left: calc(var(--level, 1) * 18px - 18px); border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: nowrap; font-size: 0.95em; line-height: 1.4; min-height: 28px; }
        .toc-item:last-child { border-bottom: none; }
        .toc-link-container { display: flex; align-items: center; flex-grow: 1; margin-right: 10px; overflow: hidden; }
        .toc-link { cursor: pointer; text-decoration: none; color: #0056b3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; max-width: 100%; }
        .toc-link:hover { text-decoration: underline; }
        .toc-item[data-is-active="true"] > .toc-link-container > .toc-link { font-weight: bold; color: #000; }
        .toc-status { margin-left: 8px; font-size: 0.8em; border-radius: 3px; padding: 1px 4px; white-space: nowrap; flex-shrink: 0; max-width: 15ch; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle; }
        /* ... —Å—Ç–∏–ª–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ .status-* ... */
        .status-not-translated { background-color: #eee; color: #555; } .status-translated-model { background-color: #dfd; color: #070; } .status-translated { background-color: #dfd; color: #070; } .status-cached { background-color: #dfd; color: #070; } .status-processing { background-color: #ffe082; color: #a80; } .status-error { background-color: #fcc; color: #a00; font-weight: bold; } .status-completed_empty { background-color: #e0e0e0; color: #777; } .status-unknown { background-color: #f0f0f0; color: #888; }
        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –°–¢–ê–¢–£–°–û–í –û–ü–ï–†–ê–¶–ò–ô --- */
        .status-summarized { background-color: #cfe2f3; color: #0747a6; } /* –°–≤–µ—Ç–ª–æ-—Å–∏–Ω–∏–π */
        .status-analyzed { background-color: #fce5cd; color: #e69138; } /* –°–≤–µ—Ç–ª–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π */
        /* --- –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ò–õ–ï–ô --- */
        .hidden { display: none !important; }
        .toc-actions { display: flex; align-items: center; flex-shrink: 0; min-width: 60px; justify-content: flex-end; }
        .action-btn { margin-left: 5px; font-size: 1.1em; cursor: pointer; vertical-align: middle; border: none; background: none; padding: 0; color: #007bff; flex-shrink: 0; }
        .action-btn:hover { color: #0056b3; } .action-btn:disabled { color: #ccc; cursor: not-allowed; }
        .download-section-link { margin-left: 8px; text-decoration: none; font-size: 0.9em; vertical-align: middle; color: #555; flex-shrink: 0; }
        .download-section-link:hover { color: #000; } .download-section-link.hidden { visibility: hidden; pointer-events: none; }
        .processing-indicator { margin-left: 5px; font-style: italic; color: #a80; flex-shrink: 0; }
        #toc-loading-message, #toc-loading-message-alt { font-style: italic; color: gray; margin-top: 10px; flex-shrink: 0; }


        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        #translation-display { margin-top: 0; padding: 15px; border: 1px solid #ddd; background-color: #f9f9f9; min-height: 100px; }
        #translation-display h3 { margin-top: 0; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; word-break: break-all; }
        #translation-content p { margin: 0 0 1em 0; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        #translation-content strong { font-weight: bold; }
        #translation-content em { font-style: italic; }

    </style>
</head>
<body>
    <div id="left-panel"> {# –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Ç–µ–ø–µ—Ä—å flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å direction: column #}
        {# 0. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ #}
        <h2>{{ (book_info.filename.replace('.epub', '').replace('_', ' ')) if book_info else '–ö–Ω–∏–≥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞' }}</h2>
        {# –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –¥—Ä—É–≥—É—é –∫–Ω–∏–≥—É" #}
        <p>
            <button onclick="document.getElementById('upload-redirect-form').submit();">–û—Ç–∫—Ä—ã—Ç—å –¥—Ä—É–≥—É—é –∫–Ω–∏–≥—É</button>
            <form id="upload-redirect-form" action="{{ url_for('index') }}" method="get" style="display: none;"></form>
        </p>

        {# --- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–æ–π --- #}
        {% if book_info %}
            {# 1. –í—ã–±–æ—Ä —è–∑—ã–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ #}
            <p>
                <label for="language-select">–¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫:</label>
                <select id="language-select" name="target_language">
                     <option value="russian" {% if target_language == 'russian' %}selected{% endif %}>Russian</option>
                     <option value="english" {% if target_language == 'english' %}selected{% endif %}>English</option>
                     <option value="german" {% if target_language == 'german' %}selected{% endif %}>German</option>
                     <option value="french" {% if target_language == 'french' %}selected{% endif %}>French</option>
                     <option value="spanish" {% if target_language == 'spanish' %}selected{% endif %}>Spanish</option>
                </select>
            </p>
            {# 2. –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ #}
            <p>
                <label for="model-select">–ú–æ–¥–µ–ª—å:</label>
                <select id="model-select" name="model_name">
                    {% if available_models %}
                        <!-- Google Models -->
                        <optgroup label="Google Models">
                        {% for model_obj in available_models %}
                            {% if isinstance(model_obj, dict) %}
                                {% if model_obj['name'].startswith('gemini-') or model_obj['name'].startswith('models/') %}
                                <option value="{{ model_obj['name'] }}" {% if selected_model == model_obj['name'] %}selected{% endif %}>
                                    {{ model_obj['display_name'] }}
                                </option>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        </optgroup>
                        
                        <!-- Free OpenRouter Models -->
                        <optgroup label="Free OpenRouter Models">
                        {% for model_obj in available_models %}
                            {% if isinstance(model_obj, dict) %}
                                {% if not (model_obj['name'].startswith('gemini-') or model_obj['name'].startswith('models/')) %}
                                <option value="{{ model_obj['name'] }}" {% if selected_model == model_obj['name'] %}selected{% endif %}>
                                    {{ model_obj['display_name'] }}
                                </option>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        </optgroup>
                    {% else %}
                        <option value="{{ selected_model | default('gemini-1.5-flash') }}" selected>{{ selected_model | default('gemini-1.5-flash') }}</option>
                        <option disabled>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π</option>
                    {% endif %}
                </select>
            </p>
            {# 3. –í—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏ #}
            <p>
                <label for="operation-select">–û–ø–µ—Ä–∞—Ü–∏—è:</label>
                <select id="operation-select" name="operation_type">
                     <option value="translate" {% if selected_operation == 'translate' %}selected{% endif %}>–ü–µ—Ä–µ–≤–æ–¥</option>
                     <option value="summarize" {% if selected_operation == 'summarize' %}selected{% endif %}>–ü–µ—Ä–µ—Å–∫–∞–∑ (–∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)</option>
                     <option value="analyze" {% if selected_operation == 'analyze' %}selected{% endif %}>–ê–Ω–∞–ª–∏–∑ —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π</option>
                     {# –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å—é–¥–∞ –¥—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –º–µ—Ä–µ –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ #}
                </select>
            </p>
            {# 4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ #}
            <div id="prompt-ext-container">
                <label for="prompt-ext-input" style="font-weight: bold;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</label>
                <textarea id="prompt-ext-input" name="prompt_ext" rows="6" placeholder="–ü—Ä–∏–º–µ—Ä: Enae = –≠–Ω–µ—è (–∂)">{{ prompt_ext | default('') | escape }}</textarea>
                <button id="save-prompt-ext-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</button>
                <span id="save-prompt-status"></span>
            </div>
            {# 5. –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π #}
            <p>
                <button id="translate-all-btn" disabled>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤—Å–µ –Ω–µ–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ</button>
            </p>
            <p> {# –ì—Ä—É–ø–ø–∞ –∫–Ω–æ–ø–æ–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è #}
                {% set can_download_initially = book_info.status in ['complete', 'complete_with_errors'] %}
                <a id="download-full-link" href="{{ url_for('download_full', book_id=book_id, lang=target_language) }}" class="button-like-link {{ '' if can_download_initially else 'hidden' }}" target="_blank" rel="noopener noreferrer">
                     <button id="download-full-btn" {% if not can_download_initially %}disabled{% endif %}>–°–∫–∞—á–∞—Ç—å TXT</button>
                </a>
                <a id="download-epub-link" href="{{ url_for('download_epub', book_id=book_id, lang=target_language) }}" class="button-like-link {{ '' if can_download_initially else 'hidden' }}" target="_blank" rel="noopener noreferrer">
                     <button id="download-epub-btn" {% if not can_download_initially %}disabled{% endif %}>–°–∫–∞—á–∞—Ç—å EPUB</button>
                </a>
            </p>
        {% endif %} {# –ö–æ–Ω–µ—Ü if book_info #}

        {# --- –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ --- #}
        <hr>
        <h3>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</h3>
        {# –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ TOC #}
        <div id="toc-container">
            <p id="toc-loading-message" style="font-style: italic; color: gray;">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è...</p>
            <ul id="toc-list">
                {# --- –ö–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TOC (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- #}
                {% if book_info and 'toc' in book_info and book_info.toc %}
                     <script>document.getElementById('toc-loading-message').style.display = 'none';</script>
                     {% for item in book_info.toc %} {% set section_id = item.id %} {% if section_id %}
                          <li class="toc-item" style="--level: {{ item.level }};" data-section-id="{{ section_id }}" data-href="{{ item.href }}" data-is-active="false">
                              <div class="toc-link-container">
                                  <a href="#" class="toc-link" title="{{ item.title | default('') }} (ID: {{ section_id }})">{{ item.translated_title if item.translated_title else item.title | default('(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)') }}</a>
                                  {% set section_data = book_info.sections.get(section_id) %} {% if section_data %}
                                      {% set section_status = section_data.get('status', 'not_translated') %}{% set model_name = section_data.get('model_name') %}{% set error_message = section_data.get('error_message', section_status) %}
                                      {% set display_text = '?' %}{% set status_class = 'status-unknown' %}{% set tooltip = '' %}{% set is_processing = false %}
                                      {% if section_status == 'translated' %}{% if model_name %}{% set display_text = model_name.split('/')[-1] %}{% set status_class = 'status-translated-model' %}{% set tooltip = 'By: ' + model_name %}{% else %}{% set display_text = 'Translated' %}{% set status_class = 'status-translated' %}{% endif %}
                                      {% elif section_status == 'cached' %}{% set display_text = 'Cached' %}{% set status_class = 'status-translated' %}{% set tooltip = 'From cache' %}
                                      {% elif section_status == 'completed_empty' %}{% set display_text = 'Empty' %}{% set status_class = 'status-completed-empty' %}{% set tooltip = 'Empty section' %}
                                      {% elif section_status == 'summarized' %}{% set display_text = 'Summarized' %}{% set status_class = 'status-summarized' %}{% if model_name %}{% set tooltip = 'By: ' + model_name %}{% endif %}
                                      {% elif section_status == 'analyzed' %}{% set display_text = 'Analyzed' %}{% set status_class = 'status-analyzed' %}{% if model_name %}{% set tooltip = 'By: ' + model_name %}{% endif %}
                                      {% elif section_status.startswith('error_') %}{% set display_text = 'Error' %}{% set status_class = 'status-error' %}{% set tooltip = error_message | default('Error') %}{% if section_status == 'error_context_limit' %} {% set display_text = 'Err:Limit' %}{% elif section_status == 'error_translation' %} {% set display_text = 'Err:API' %}{% elif section_status == 'error_caching' %} {% set display_text = 'Err:Cache' %}{% elif section_status == 'error_extraction' %} {% set display_text = 'Err:Extract' %}{% elif section_status == 'error_unknown' %} {% set display_text = 'Err:Unk' %}{% endif %}
                                      {% elif section_status == 'processing' %}{% set display_text = 'Processing' %}{% set status_class = 'status-processing' %}{% set is_processing = true %}
                                      {% elif section_status == 'not_translated' or section_status == 'idle' %}{% set display_text = 'Not Translated' %}{% set status_class = 'status-not-translated' %}
                                      {% else %}{% set display_text = section_status %}{% set status_class = 'status-unknown' %}{% endif %}
                                      <span class="toc-status {{ status_class }}" {% if tooltip %}title="{{ tooltip }}"{% endif %}>{{ display_text }}</span>
                                      <span class="processing-indicator {% if not is_processing %}hidden{% endif %}">(...)</span>
                                  {% else %}
                                      <span class="toc-status status-unknown" title="No data for ID: {{ section_id }}">?</span>
                                      <span class="processing-indicator" style="display: none;">(...)</span>
                                  {% endif %}
                              </div>
                              <div class="toc-actions">
                                  {% set initial_status = section_data.get('status', '?') if section_data else '?' %}{% set is_processing_initially = initial_status == 'processing' %}{% set show_download_initially = initial_status in ['translated', 'completed_empty', 'cached'] %}
                                  <button class="action-btn update-translation-btn" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–∞–Ω–æ–≤–æ" {% if is_processing_initially %}disabled{% endif %}>üîÑ</button>
                                  <a href="{{ url_for('download_section', book_id=book_id, section_id=section_id, lang=target_language) }}" class="download-section-link {{ 'hidden' if not show_download_initially else '' }}" title="–°–∫–∞—á–∞—Ç—å —Ä–∞–∑–¥–µ–ª">üíæ</a>
                              </div>
                          </li>
                     {% endif %} {% endfor %}
                {% else %}
                     <script>document.getElementById('toc-loading-message').style.display = 'none';</script>
                     <li>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –ø—É—Å—Ç–æ.</li>
                {% endif %}
            </ul>
        </div> {# –ö–æ–Ω–µ—Ü toc-container #}

        {# –ó–∞–ø–∞—Å–Ω–æ–π –±–ª–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –∫–Ω–∏–≥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ #}
        {% if not book_info %}
             <p id="toc-loading-message-alt">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–Ω–∏–≥—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>
             <script> if(document.getElementById('toc-loading-message')) document.getElementById('toc-loading-message').style.display = 'none'; </script>
        {% endif %}

    </div> <!-- –ö–æ–Ω–µ—Ü left-panel -->

    <!-- ================== –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å ================== -->
    <div id="main-content">
         <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ -->
         <div id="translation-display" style="display: none;">
             <h3><span id="translation-section-id">–†–∞–∑–¥–µ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span></h3>
             <div id="translation-content">
                 <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤—É –≤ –æ–≥–ª–∞–≤–ª–µ–Ω–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞.</p>
            </div>
        </div>
        <!-- –ö–æ–Ω–µ—Ü –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ -->
    </div> <!-- –ö–æ–Ω–µ—Ü main-content -->

    <!-- ================== –°–∫—Ä–∏–ø—Ç—ã ================== -->
    <script>
        // –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Flask –≤ JS
        const currentBookId = "{{ book_id | default('None') | escape }}";
        const initialTargetLanguage = "{{ target_language | default('russian') | escape }}";
        const initialSelectedModel = "{{ selected_model | default('gemini-1.5-flash') | escape }}";
    </script>

    <script> // –°–∫—Ä–∏–ø—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è prompt_ext
        document.addEventListener('DOMContentLoaded', function() {
            const promptExtInput = document.getElementById('prompt-ext-input');
            const savePromptBtn = document.getElementById('save-prompt-ext-btn');
            const saveStatusSpan = document.getElementById('save-prompt-status');
            if (savePromptBtn && promptExtInput && saveStatusSpan && currentBookId && currentBookId !== 'None') {
                savePromptBtn.addEventListener('click', function() {
                    const promptText = promptExtInput.value; saveStatusSpan.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...'; saveStatusSpan.style.color = 'orange'; savePromptBtn.disabled = true;
                    fetch(`/save_prompt_ext/${currentBookId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt_text: promptText }) })
                    .then(response => { if (!response.ok) { return response.text().then(text => { throw new Error(`Server error: ${response.status} - ${text || 'No details'}`); }); } return response.json(); })
                    .then(data => { if (data.success) { saveStatusSpan.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!'; saveStatusSpan.style.color = 'green'; } else { saveStatusSpan.textContent = `–û—à–∏–±–∫–∞: ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'}`; saveStatusSpan.style.color = 'red'; console.error("Save prompt error:", data); }})
                    .catch(error => { saveStatusSpan.textContent = `–û—à–∏–±–∫–∞: ${error.message || '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'}`; saveStatusSpan.style.color = 'red'; console.error('Save prompt error:', error); })
                    .finally(() => { savePromptBtn.disabled = false; setTimeout(() => { if (saveStatusSpan) { saveStatusSpan.textContent = ''; saveStatusSpan.style.color = ''; } }, 4000); });
                });
            } else { console.warn("Prompt ext save elements not found or book_id missing."); /* ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏) ... */ }
        });
    </script>

    {# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –ü–û–°–õ–ï –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö #}
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>
</html>