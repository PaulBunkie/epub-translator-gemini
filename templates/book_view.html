<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–µ—Ä–µ–≤–æ–¥: {{ book_info.filename }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body { display: flex; }
        #left-panel { width: 300px; border-right: 1px solid #ccc; padding-right: 15px; height: 100vh; overflow-y: auto; }
        #main-content { flex-grow: 1; padding-left: 15px; height: 100vh; overflow-y: auto; }
        .toc-item { margin-left: calc(var(--level, 1) * 15px); list-style: none; padding: 3px 0; }
        .toc-link { cursor: pointer; text-decoration: underline; color: blue; }
        .toc-status { margin-left: 5px; font-size: 0.8em; border-radius: 3px; padding: 1px 3px; }
        .status-not_translated { background-color: #fdd; color: #900; }
        .status-cached { background-color: #dfd; color: #070; }
        .status-translated { background-color: #cfc; color: #050; }
        .status-processing { background-color: #ffd; color: #a80; }
        .status-error { background-color: #fcc; color: #a00; font-weight: bold; }
        .status-completed_empty { background-color: #eee; color: #777; }
        .download-section-link { margin-left: 5px; text-decoration: none; font-size: 0.9em; }
        .hidden { display: none; }
        #translation-display { margin-top: 20px; padding: 10px; border: 1px dashed #eee; background-color: #f9f9f9; max-height: 80vh; overflow-y: auto; white-space: pre-wrap; /* –ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ */ }
        #translation-display pre p { margin: 0 0 1em 0; } /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤ –≤–Ω—É—Ç—Ä–∏ pre */
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="left-panel">
        <h2>{{ book_info.filename }}</h2>
        <p>
            <button onclick="document.getElementById('upload-redirect-form').submit();">–û—Ç–∫—Ä—ã—Ç—å –¥—Ä—É–≥—É—é –∫–Ω–∏–≥—É</button>
            <form id="upload-redirect-form" action="{{ url_for('index') }}" method="get" style="display: none;"></form>
        </p>
        <p>
            <button id="translate-all-btn" {% if book_info.status == 'processing' %}disabled{% endif %}>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤—Å–µ –Ω–µ–ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ</button>
        </p>
        <p>
            <a id="download-full-link" href="{{ url_for('download_full', book_id=book_id) }}" class="{{ 'hidden' if book_info.status not in ['complete', 'complete_with_errors'] }}">
                 <button id="download-full-btn" {% if book_info.status not in ['complete', 'complete_with_errors'] %}disabled{% endif %}>–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç (.txt)</button>
            </a>
        </p>
        <hr>
        <h3>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</h3>
        <ul id="toc-list">
            {% if book_info.toc %}
                {% for item in book_info.toc %}
                    {% set section_id = item.id %}
                    {% set current_status = book_info.sections.get(section_id, 'not_translated') %}
                    <li class="toc-item" style="--level: {{ item.level }};" data-section-id="{{ section_id }}" data-href="{{ item.href }}" data-status="{{ current_status }}">
                        <a href="#" class="toc-link">{{ item.title }}</a>
                        <span class="toc-status status-{{ current_status }}">
                             {{ current_status | replace('_', ' ') | capitalize }}
                        </span>
                         <a href="{{ url_for('download_section', book_id=book_id, section_id=section_id) }}"
                           class="download-section-link {{ 'hidden' if current_status not in ['cached', 'translated', 'completed_empty'] }}"
                           title="–°–∫–∞—á–∞—Ç—å —Ä–∞–∑–¥–µ–ª">üíæ</a>
                         <span class="processing-indicator" style="{{ 'display: none;' if current_status != 'processing' else '' }}">(...)</span>
                    </li>
                {% endfor %}
            {% else %}
                <li>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å.</li>
            {% endif %}
        </ul>
    </div>

    <div id="main-content">
        <div id="translation-display">
             <h3>–¢–µ–∫—Å—Ç –ø–µ—Ä–µ–≤–æ–¥–∞: <span id="translation-section-id"></span></h3>
             <pre id="translation-content">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤—É –≤ –æ–≥–ª–∞–≤–ª–µ–Ω–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞.</pre>
        </div>
    </div>

    <!-- –ü–µ—Ä–µ–¥–∞–µ–º ID –∫–Ω–∏–≥–∏ –∏ –¥—Ä. –¥–∞–Ω–Ω—ã–µ –≤ JavaScript -->
    <script>
        const currentBookId = "{{ book_id }}";
        const defaultTargetLanguage = "{{ request.args.get('lang', 'russian') }}"; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–∑—ã–∫ –∏–∑ URL –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
        const defaultModelName = "{{ request.args.get('model', 'gemini-1.5-flash') }}"; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å –∏–∑ URL –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>