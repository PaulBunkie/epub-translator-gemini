<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–µ—Ä–µ–≤–æ–¥: {{ book_info.filename if book_info else '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏' }}</title>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> -->
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–≤—É—Ö –∫–æ–ª–æ–Ω–æ–∫ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            display: flex;
            overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ–±—â—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É body */
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        #left-panel {
            width: 350px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å—Å—è */
            height: 100vh; /* –ó–∞–Ω—è—Ç—å –≤—Å—é –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
            overflow-y: auto; /* –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è –ø–∞–Ω–µ–ª–∏, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –≤–ª–µ–∑–∞–µ—Ç */
            border-right: 1px solid #ccc;
            padding: 15px; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
            box-sizing: border-box; /* –£—á–∏—Ç—ã–≤–∞—Ç—å padding –∏ border –≤ —à–∏—Ä–∏–Ω–µ */
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        #main-content {
            flex-grow: 1; /* –ó–∞–Ω—è—Ç—å –≤—Å–µ –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
            height: 100vh; /* –ó–∞–Ω—è—Ç—å –≤—Å—é –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
            overflow-y: auto; /* –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
            padding: 15px; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
            box-sizing: border-box;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
        #left-panel h2 { margin-top: 0; font-size: 1.1em; word-break: break-word;}
        #left-panel h3 { margin-top: 15px; margin-bottom: 5px; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 3px;}
        #left-panel p { margin: 10px 0; }
        #left-panel label { display: block; margin-bottom: 3px; font-size: 0.9em; font-weight: bold; }
        /* –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ (–∫—Ä–æ–º–µ –∏–∫–æ–Ω–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π) */
        #left-panel button:not(.action-btn), #left-panel .button-like-link button { /* –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º –∫–Ω–æ–ø–∫–∞–º, –∫—Ä–æ–º–µ –∏–∫–æ–Ω–æ–∫ */
             cursor: pointer;
             background-color: #007bff; /* –°–∏–Ω–∏–π */
             color: white;
             border: none;
             border-radius: 4px;
             padding: 6px 10px;
             box-sizing: border-box;
             margin-bottom: 5px;
             text-align: center;
             font-size: 0.95em;
             width: 100%; /* –ö–Ω–æ–ø–∫–∏ –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
         }
         #left-panel button:not(.action-btn):hover, #left-panel .button-like-link button:hover {
             background-color: #0056b3;
         }
         #left-panel button:disabled { /* –°—Ç–∏–ª—å –¥–ª—è –í–°–ï–• –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
             background-color: #ccc !important; /* !important –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è */
             opacity: 0.7;
             cursor: not-allowed;
        }

         /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è */
         #left-panel p > a.button-like-link {
              display: block; /* –ß—Ç–æ–±—ã —Å—Å—ã–ª–∫–∏ –∑–∞–Ω–∏–º–∞–ª–∏ –≤—Å—é —à–∏—Ä–∏–Ω—É —Ä–æ–¥–∏—Ç–µ–ª—è <p> */
              text-decoration: none;
              margin-bottom: 5px; /* –î–æ–±–∞–≤–∏–º –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
         }
         #left-panel p > a.button-like-link:last-child {
              margin-bottom: 0; /* –£–±–µ—Ä–µ–º –æ—Ç—Å—Ç—É–ø —É –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–Ω–æ–ø–∫–∏ –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–µ */
         }

         /* –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –∫–Ω–æ–ø–∫–∞–º –≤–Ω—É—Ç—Ä–∏ —Å—Å—ã–ª–æ–∫ */
         #left-panel p > a.button-like-link button {
             width: 100%;
             box-sizing: border-box; /* –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π */
         }

         /* –°—Ç–∏–ª—å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å hidden */
         .hidden { display: none !important; }

        #left-panel select {
            width: 100%;
            padding: 6px 10px;
            box-sizing: border-box;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #left-panel hr { margin: 15px 0; border: 0; border-top: 1px solid #eee; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è */
        #toc-list { list-style: none; padding-left: 0; margin-top: 5px; }
        .toc-item {
            padding: 5px 0;
            padding-left: calc(var(--level, 1) * 18px - 18px); /* –û—Ç—Å—Ç—É–ø –¥–ª—è —É—Ä–æ–≤–Ω—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ */
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            font-size: 0.95em;
            line-height: 1.4;
            min-height: 28px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ */
        }
        .toc-item:last-child { border-bottom: none; }

        .toc-link-container {
             display: flex;
             align-items: center;
             flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
             margin-right: 10px; /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –¥–æ –∫–Ω–æ–ø–æ–∫ */
             overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ, —á—Ç–æ –Ω–µ –≤–ª–µ–∑–ª–æ */
        }

        .toc-link {
            cursor: pointer;
            text-decoration: none;
            color: #0056b3;
            white-space: nowrap; /* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏ */
            overflow: hidden; /* –°–∫—Ä—ã—Ç—å –≤—ã—Ö–æ–¥—è—â–∏–π —Ç–µ–∫—Å—Ç */
            text-overflow: ellipsis; /* –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–æ–µ—Ç–æ—á–∏–µ */
            display: inline-block; /* –ù—É–∂–Ω–æ –¥–ª—è text-overflow */
            max-width: 100%; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã —Ç—Ä–æ–µ—Ç–æ—á–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ */
        }
        .toc-link:hover { text-decoration: underline; }
        /* –ò—Å–ø–æ–ª—å–∑—É–µ–º data-–∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
        .toc-item[data-is-active="true"] > .toc-link-container > .toc-link {
            font-weight: bold;
            color: #000;
        }

        .toc-status {
             margin-left: 8px; /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –æ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –≥–ª–∞–≤—ã */
             font-size: 0.8em;
             border-radius: 3px;
             padding: 1px 4px;
             white-space: nowrap; /* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ */
             flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å—Å—è */
             max-width: 15ch;   /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å. —à–∏—Ä–∏–Ω—É (15 —Å–∏–º–≤–æ–ª–æ–≤, –º–æ–∂–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ) */
             overflow: hidden;  /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ, —á—Ç–æ –Ω–µ –≤–ª–µ–∑–ª–æ */
             text-overflow: ellipsis; /* –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–æ–µ—Ç–æ—á–∏–µ (...) */
             display: inline-block; /* –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è text-overflow —Å max-width */
             vertical-align: middle; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ —Å —Ç–µ–∫—Å—Ç–æ–º —Å—Å—ã–ª–∫–∏ */
        }
        /* –°—Ç–∏–ª–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ */
        .status-not-translated { background-color: #eee; color: #555; }
        .status-translated-model { background-color: #dfd; color: #070; } /* –°—Ç–∞—Ç—É—Å: –ú–æ–¥–µ–ª—å */
        .status-translated { background-color: #dfd; color: #070; } /* –°—Ç–∞—Ç—É—Å: Translated (–±–µ–∑ –º–æ–¥–µ–ª–∏) */
        .status-cached { background-color: #dfd; color: #070; } /* –°—Ç–∞—Ç—É—Å: Cached (–ø–æ–∫–∞–∂–µ–º –∫–∞–∫ Translated) */
        .status-processing { background-color: #ffe082; color: #a80; } /* –°—Ç–∞—Ç—É—Å: Processing */
        .status-error { background-color: #fcc; color: #a00; font-weight: bold; } /* –°—Ç–∞—Ç—É—Å: Error (–æ–±—â–∏–π) */
        .status-completed_empty { background-color: #e0e0e0; color: #777; } /* –°—Ç–∞—Ç—É—Å: Empty */
        .status-unknown { background-color: #f0f0f0; color: #888; } /* –°—Ç–∞—Ç—É—Å: Unknown */

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å–ø—Ä–∞–≤–∞ */
        .toc-actions {
             display: flex;
             align-items: center;
             flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å—Å—è */
             min-width: 60px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
             justify-content: flex-end; /* –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–∂–∞—Ç—ã –≤–ø—Ä–∞–≤–æ */
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π (–∫–Ω–æ–ø–∫–∏ –∏ —Å—Å—ã–ª–∫–∏) */
        .action-btn { /* –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" üîÑ */
            margin-left: 5px;
            font-size: 1.1em;
            cursor: pointer;
            vertical-align: middle;
            border: none;
            background: none;
            padding: 0;
            color: #007bff;
            flex-shrink: 0;
        }
        .action-btn:hover { color: #0056b3; }

        .download-section-link { /* –°—Å—ã–ª–∫–∞ "–°–∫–∞—á–∞—Ç—å" üíæ */
             margin-left: 8px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–∫–∏ "–û–±–Ω–æ–≤–∏—Ç—å" */
             text-decoration: none;
             font-size: 0.9em;
             vertical-align: middle;
             color: #555;
             flex-shrink: 0;
         }
         .download-section-link:hover { color: #000; }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ (...) */
        .processing-indicator {
            margin-left: 5px;
            font-style: italic;
            color: #a80;
            flex-shrink: 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        #translation-display {
            margin-top: 0;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            min-height: 100px;
        }
        #translation-display h3 {
            margin-top: 0;
            font-size: 1.1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
            word-break: break-all; /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö ID —Å–µ–∫—Ü–∏–π */
        }
        #translation-content p {
             margin: 0 0 1em 0; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞ */
             line-height: 1.6; /* –ú–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª */
             white-space: normal; /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤ */
             word-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
        }
        #translation-content strong { font-weight: bold; }
        #translation-content em { font-style: italic; }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ TOC */
        #toc-loading-message, #toc-loading-message-alt {
            font-style: italic;
            color: gray;
            margin-top: 10px;
        }

    </style>
</head>
<body>
    <div id="left-panel">
        <h2>{{ book_info.filename if book_info else '–ö–Ω–∏–≥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞' }}</h2>
        <p>
            <button onclick="document.getElementById('upload-redirect-form').submit();">–û—Ç–∫—Ä—ã—Ç—å –¥—Ä—É–≥—É—é –∫–Ω–∏–≥—É</button>
            <form id="upload-redirect-form" action="{{ url_for('index') }}" method="get" style="display: none;"></form>
        </p>

        {# --- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–æ–π (–µ—Å–ª–∏ –æ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞) --- #}
        {% if book_info %}
            <p>
                <label for="model-select">–ú–æ–¥–µ–ª—å:</label><br>
                <select id="model-select" name="model_name">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    {# –ú–æ–¥–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS #}
                </select>
            </p>
            <p>
                <label for="language-select">–Ø–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∞:</label><br>
                {# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é #}
                {% set current_lang = target_language | default('russian') %}
                <select id="language-select" name="target_language">
                     <option value="russian" {% if current_lang == 'russian' %}selected{% endif %}>Russian</option>
                     <option value="english" {% if current_lang == 'english' %}selected{% endif %}>English</option>
                     <option value="german" {% if current_lang == 'german' %}selected{% endif %}>German</option>
                     <option value="french" {% if current_lang == 'french' %}selected{% endif %}>French</option>
                     <option value="spanish" {% if current_lang == 'spanish' %}selected{% endif %}>Spanish</option>
                     <!-- –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ —è–∑—ã–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
                </select>
            </p>
            <p>
                {# –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤—Å–µ" - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è JS #}
                <button id="translate-all-btn" disabled>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤—Å–µ –Ω–µ–ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ</button>
            </p>
            <p>
                {# –ö–Ω–æ–ø–∫–∏ "–°–∫–∞—á–∞—Ç—å" - –≤–∏–¥–∏–º–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è JS #}
                {% set can_download_initially = book_info.status in ['complete', 'complete_with_errors'] %}
                {# –°—Å—ã–ª–∫–∞ –¥–ª—è TXT #}
                <a id="download-full-link"
                   href="{{ url_for('download_full', book_id=book_id, lang=current_lang) }}"
                   class="button-like-link {{ '' if can_download_initially else 'hidden' }}"
                   target="_blank" rel="noopener noreferrer">
                     <button id="download-full-btn" {% if not can_download_initially %}disabled{% endif %}>–°–∫–∞—á–∞—Ç—å TXT</button>
                </a>
                {# –°—Å—ã–ª–∫–∞ –¥–ª—è EPUB #}
                <a id="download-epub-link"
                   href="{{ url_for('download_epub', book_id=book_id, lang=current_lang) }}"
                   class="button-like-link {{ '' if can_download_initially else 'hidden' }}"
                   target="_blank" rel="noopener noreferrer">
                     <button id="download-epub-btn" {% if not can_download_initially %}disabled{% endif %}>–°–∫–∞—á–∞—Ç—å EPUB</button>
                </a>
            </p>

            <hr>
            <h3>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</h3>

            {# –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ TOC (–±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç–æ JS, –µ—Å–ª–∏ TOC –µ—Å—Ç—å) #}
            <p id="toc-loading-message" style="font-style: italic; color: gray;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è...</p>

            {# --- –°–ø–∏—Å–æ–∫ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è (TOC) --- #}
            <ul id="toc-list">
                {% if book_info and 'toc' in book_info and book_info.toc %}
                    {# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è "–ó–∞–≥—Ä—É–∑–∫–∞...", —Ç.–∫. TOC –µ—Å—Ç—å #}
                    <script>
                        (function() {
                            var msg = document.getElementById('toc-loading-message');
                            if (msg) msg.style.display = 'none';
                        })();
                    </script>
                    {# --- –¶–∏–∫–ª –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º TOC --- #}
                    {% for item in book_info.toc %}
                        {% set section_id = item.id %}
                        {% if section_id %} {# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É —ç–ª–µ–º–µ–Ω—Ç–∞ TOC –µ—Å—Ç—å ID #}
                             {# --- –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ –¥–ª—è —Å–µ–∫—Ü–∏–∏ --- #}
                             <li class="toc-item" style="--level: {{ item.level }};"
                                 data-section-id="{{ section_id }}"
                                 data-href="{{ item.href }}" {# Href –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è JS #}
                                 data-is-active="false" {# –ê—Ç—Ä–∏–±—É—Ç –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏ #}
                                 {# data-status —É–±—Ä–∞–Ω, —Ç.–∫. —Å—Ç–∞—Ç—É—Å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∏–∂–µ #}
                                 >

                                 {# --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Å—ã–ª–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞ --- #}
                                 <div class="toc-link-container">
                                     {# –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ–∫—Ü–∏—é #}
                                     <a href="#" class="toc-link" title="{{ item.title | default('') }} (ID: {{ section_id }})">
                                         {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ #}
                                         {{ item.translated_title if item.translated_title else item.title | default('(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)') }}
                                     </a>

                                     {# --- –ë–ª–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è Jinja –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ) --- #}
                                     {% set section_data = book_info.sections.get(section_id) %} {# –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ #}
                                     {% if section_data %}
                                         {% set section_status = section_data.get('status', 'not_translated') %}
                                         {% set model_name = section_data.get('model_name') %}
                                         {% set error_message = section_data.get('error_message', section_status) %}

                                         {% set display_text = '???' %}
                                         {% set status_class = 'status-unknown' %}
                                         {% set tooltip = '' %}

                                         {# --- –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞/–º–æ–¥–µ–ª–∏ (–ò–î–ï–ù–¢–ò–ß–ù–ê –õ–û–ì–ò–ö–ï –í JS) --- #}
                                         {% if section_status == 'translated' %}
                                             {% if model_name %}
                                                 {% set display_text = model_name.split('/')[-1] %}
                                                 {% set status_class = 'status-translated-model' %}
                                                 {% set tooltip = 'Translated by: ' + model_name %}
                                             {% else %}
                                                 {% set display_text = 'Translated' %}
                                                 {% set status_class = 'status-translated' %}
                                             {% endif %}
                                         {% elif section_status == 'cached' %}
                                              {% set display_text = 'Cached' %}
                                              {% set status_class = 'status-translated' %}
                                         {% elif section_status == 'completed_empty' %}
                                             {% set display_text = 'Empty' %}
                                             {% set status_class = 'status-completed-empty' %}
                                             {% set tooltip = 'Section was empty or contained no translatable text.' %}
                                         {% elif section_status.startswith('error_') %}
                                             {% set display_text = 'Error' %}
                                             {% set status_class = 'status-error' %}
                                             {% set tooltip = error_message | default('Translation error occurred.') %}
                                             {% if section_status == 'error_context_limit' %} {% set display_text = 'Err:Limit' %}
                                             {% elif section_status == 'error_translation' %} {% set display_text = 'Err:API' %}
                                             {% elif section_status == 'error_caching' %} {% set display_text = 'Err:Cache' %}
                                             {% elif section_status == 'error_extraction' %} {% set display_text = 'Err:Extract' %}
                                             {% endif %}
                                         {% elif section_status == 'processing' %}
                                             {% set display_text = 'Processing' %}
                                             {% set status_class = 'status-processing' %}
                                         {% elif section_status == 'not_translated' or section_status == 'idle' %}
                                             {% set display_text = 'Not Translated' %}
                                             {% set status_class = 'status-not-translated' %}
                                         {% else %}
                                             {% set display_text = section_status %}
                                             {% set status_class = 'status-unknown' %}
                                         {% endif %}

                                         {# --- –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ --- #}
                                         <span class="toc-status {{ status_class }}" {% if tooltip %}title="{{ tooltip }}"{% endif %}>
                                             {{ display_text }}
                                         </span>
                                         <span class="processing-indicator" style="{{ 'display: none;' if section_status != 'processing' else 'display: inline;' }}">
                                             (...)
                                         </span>

                                     {% else %}
                                         {# –ï—Å–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ –∏–∑ TOC –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î #}
                                         <span class="toc-status status-unknown" title="Section data not found in DB for ID: {{ section_id }}">Unknown</span>
                                         <span class="processing-indicator" style="display: none;">(...)</span>
                                     {% endif %} {# –ö–æ–Ω–µ—Ü if section_data #}
                                     {# --- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ --- #}

                                 </div> {# –ö–æ–Ω–µ—Ü toc-link-container #}

                                 {# --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π --- #}
                                 <div class="toc-actions">
                                     {# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ #}
                                     {% set initial_status = section_data.get('status', 'not_translated') if section_data else 'not_translated' %}
                                     {% set show_update_initially = initial_status not in ['not_translated', 'processing', 'idle'] %}
                                     {% set show_download_initially = initial_status in ['translated', 'completed_empty', 'cached'] %}

                                     {# –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" üîÑ #}
                                     <button class="action-btn update-translation-btn {{ 'hidden' if not show_update_initially }}"
                                             title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–∞–Ω–æ–≤–æ / –û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥">üîÑ</button>

                                     {# –°—Å—ã–ª–∫–∞ "–°–∫–∞—á–∞—Ç—å" üíæ #}
                                     <a href="{{ url_for('download_section', book_id=book_id, section_id=section_id, lang=current_lang) }}"
                                        class="download-section-link {{ 'hidden' if not show_download_initially }}"
                                        title="–°–∫–∞—á–∞—Ç—å —Ä–∞–∑–¥–µ–ª">üíæ</a>
                                 </div> {# –ö–æ–Ω–µ—Ü toc-actions #}

                             </li> {# –ö–æ–Ω–µ—Ü —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞ –¥–ª—è —Å–µ–∫—Ü–∏–∏ #}
                        {% endif %} {# –ö–æ–Ω–µ—Ü if section_id #}
                    {% endfor %} {# –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ TOC #}
                {% else %}
                     {# --- –ï—Å–ª–∏ TOC –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç --- #}
                     <script>
                        (function() {
                            var msg = document.getElementById('toc-loading-message');
                            if (msg) msg.style.display = 'none';
                        })();
                    </script>
                    <li>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –ø—É—Å—Ç–æ.</li>
                {% endif %} {# –ö–æ–Ω–µ—Ü if book_info.toc #}
            </ul> {# –ö–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ TOC #}
        {% else %}
             {# --- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (book_info is None) --- #}
             <p id="toc-loading-message-alt">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–Ω–∏–≥—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</p>
             {# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ book_info –Ω–µ—Ç #}
              <script>
                 (function() {
                     var msg = document.getElementById('toc-loading-message');
                     if (msg) msg.style.display = 'none';
                 })();
             </script>
        {% endif %} {# –ö–æ–Ω–µ—Ü –≤–Ω–µ—à–Ω–µ–≥–æ if book_info #}
    </div> <!-- –ö–æ–Ω–µ—Ü left-panel -->

    {# --- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ --- #}
    <div id="main-content">
         <div id="translation-display" style="display: none;"> {# –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é #}
             <h3><span id="translation-section-id">–†–∞–∑–¥–µ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span></h3>
             <div id="translation-content"><p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤—É –≤ –æ–≥–ª–∞–≤–ª–µ–Ω–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞.</p></div>
        </div>
    </div> <!-- –ö–æ–Ω–µ—Ü main-content -->

    {# --- –ü–µ—Ä–µ–¥–∞—á–∞ book_id –≤ JavaScript --- #}
    <script>
        const currentBookId = "{{ book_id | default('None') | escape }}";
    </script>
    {# --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ --- #}
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>