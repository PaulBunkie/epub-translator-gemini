<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB Translator</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 300;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-form {
            display: none;
        }
        
        .upload-form.active {
            display: block;
        }
        
        .progress-section {
            display: none;
        }
        
        .progress-section.active {
            display: block;
        }
        
        .result-section {
            display: none;
        }
        
        .result-section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="file"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="file"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-text {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: #555;
        }
        
        .download-link {
            display: inline-block;
            background: #28a745;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
            transition: background 0.3s;
        }
        
        .download-link:hover {
            background: #218838;
        }
        
        .telegram-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .telegram-info h3 {
            margin-top: 0;
            color: #667eea;
        }
        
        .qr-code {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code img {
            max-width: 200px;
            border-radius: 8px;
        }
        
        .book-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .book-info h3 {
            margin-top: 0;
            color: #667eea;
        }
        
        .book-info p {
            margin: 8px 0;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö EPUB Translator</h1>
            <p>–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –∫–Ω–∏–≥—É –Ω–∞ –ª—é–±–æ–π —è–∑—ã–∫</p>
        </div>
        
        <div class="content">
            <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="uploadForm" class="upload-form {% if not book_info %}active{% endif %}">
                <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ EPUB —Ñ–∞–π–ª</h2>
                <form id="epubForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="epubFile">–í—ã–±–µ—Ä–∏—Ç–µ EPUB —Ñ–∞–π–ª:</label>
                        <input type="file" id="epubFile" name="epub_file" accept=".epub" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetLanguage">–Ø–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∞:</label>
                        <select id="targetLanguage" name="target_language" required>
                            <option value="russian">–†—É—Å—Å–∫–∏–π</option>
                            <option value="english">English</option>
                            <option value="german">Deutsch</option>
                            <option value="french">Fran√ßais</option>
                            <option value="spanish">Espa√±ol</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn">–ù–∞—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
                </form>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
            <div id="progressSection" class="progress-section {% if book_info and book_info.current_workflow_status != 'completed' %}active{% endif %}">
                <div class="book-info">
                    <h3>üìñ {{ book_info.filename if book_info else '–û–±—Ä–∞–±–æ—Ç–∫–∞...' }}</h3>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="statusText">{{ book_info.current_workflow_status if book_info else '–ó–∞–≥—Ä—É–∑–∫–∞...' }}</span></p>
                </div>
                
                <!-- –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏) -->
                <div id="permanentLink" class="telegram-info" style="display: none;">
                    <h3>üîó –í–∞—à–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞</h3>
                    <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É:</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <code id="linkText">{{ request.url }}</code>
                        <button onclick="copyLink(event)" style="margin-left: 10px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                    <p><small>–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ</small></p>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏ -->
                <div class="telegram-info">
                    <h3>üíæ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø</h3>
                    <p>‚úÖ –í–∞—à–∞ —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
                    <p><small>–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ <a href="/user" style="color: #667eea;">user</a> - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∂–µ—Ç –≤–∞—à—É –∫–Ω–∏–≥—É</small></p>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="status-text" id="statusMessage">
                    {% if book_info %}
                        {% if book_info.current_workflow_status == 'completed' %}
                            –ü–µ—Ä–µ–≤–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω!
                        {% else %}
                            –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∞—à—É –∫–Ω–∏–≥—É...
                        {% endif %}
                    {% else %}
                        –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª...
                    {% endif %}
                </div>
                
                <!-- QR-–∫–æ–¥ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ -->
                <!-- –£–î–ê–õ–ï–ù–û: –ë–ª–æ–∫ QR-–∫–æ–¥–∞ -->
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
            <div id="resultSection" class="result-section {% if book_info and book_info.current_workflow_status == 'completed' %}active{% endif %}">
                <div class="success">
                    <h3>‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≥–æ—Ç–æ–≤!</h3>
                    <p>–í–∞—à–∞ –∫–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞.</p>
                </div>
                
                <div class="book-info">
                    <h3>üìñ {{ book_info.filename if book_info else '–ö–Ω–∏–≥–∞' }}</h3>
                </div>
                
                <a href="/workflow_download_epub/{{ book_info.book_id if book_info else '' }}" class="download-link">
                    üì• –°–∫–∞—á–∞—Ç—å –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—É—é –∫–Ω–∏–≥—É
                </a>
                
                <div class="telegram-info">
                    <h3>üîó –í–∞—à–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞</h3>
                    <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É:</p>
                    <code>{{ request.url }}</code>
                </div>
                
                <div class="telegram-info">
                    <h3>üíæ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø</h3>
                    <p>‚úÖ –í–∞—à–∞ —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
                    <p><small>–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ <a href="/user" style="color: #667eea;">user</a> - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∂–µ—Ç –≤–∞—à—É –∫–Ω–∏–≥—É</small></p>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        // @ts-nocheck
        var accessToken = "{{ access_token if access_token and access_token != 'None' else '' }}";
        var bookInfo = "{{ book_info | tojson | default('') | safe }}";
        if (bookInfo === "" || bookInfo === "null") { bookInfo = null; } else { bookInfo = JSON.parse(bookInfo); }
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('epubForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            formData.append('access_token', accessToken);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            document.getElementById('uploadForm').classList.remove('active');
            document.getElementById('progressSection').classList.add('active');
            
            try {
                const response = await fetch('/workflow_upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }

                if (!response.ok) {
                    const text = await response.text();
                    showError('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + text);
                    return;
                }

                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    const text = await response.text();
                    showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + text);
                    return;
                }

                if (result.status === 'success') {
                    // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    startProgressTracking(result.book_id);
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + result.message);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        });
        
        // Polling –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏ –ø–æ access_token
        async function pollForBookByToken(token) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏...';
            let found = false;
            while (!found) {
                try {
                    const response = await fetch(`/workflow_book_by_token/${token}`);
                    if (response.status === 200) {
                        const data = await response.json();
                        if (data && data.book_id) {
                            found = true;
                            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π bookInfo –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                            bookInfo = data;
                            updateProgress(data);
                            startProgressTracking(data.book_id);
                            break;
                        }
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
                }
                await new Promise(r => setTimeout(r, 2000));
            }
        }
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function startProgressTracking(bookId) {
            const progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/workflow_book_status/${bookId}`);
                    const data = await response.json();
                    
                    updateProgress(data);
                    
                    if (data.current_workflow_status === 'completed') {
                        clearInterval(progressInterval);
                        showResult();
                    } else if (data.current_workflow_status === 'error') {
                        clearInterval(progressInterval);
                        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –∫–Ω–∏–≥–∏');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                }
            }, 2000);
        }
        
        function updateProgress(data) {
            const statusText = document.getElementById('statusText');
            const statusMessage = document.getElementById('statusMessage');
            const progressFill = document.getElementById('progressFill');
            
            statusText.textContent = data.current_workflow_status || '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∞–ø–æ–≤
            const stages = data.book_stage_statuses || {};
            const totalStages = Object.keys(stages).length;
            const completedStages = Object.values(stages).filter(stage => 
                stage.status === 'completed' || stage.status === 'completed_empty'
            ).length;
            
            const progress = totalStages > 0 ? (completedStages / totalStages) * 100 : 0;
            progressFill.style.width = progress + '%';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (data.current_workflow_status === 'completed') {
                statusMessage.textContent = '–ü–µ—Ä–µ–≤–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω!';
            } else {
                statusMessage.textContent = `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∞—à—É –∫–Ω–∏–≥—É... (${Math.round(progress)}%)`;
            }
        }
        
        function showResult() {
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('resultSection').classList.add('active');
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.content').appendChild(errorDiv);
        }
        
        // –ï—Å–ª–∏ –∫–Ω–∏–≥–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
        if (bookInfo && bookInfo.current_workflow_status !== 'completed') {
            startProgressTracking(bookInfo.book_id);
        } else if (!bookInfo && accessToken && accessToken !== "" && accessToken !== "None" && accessToken !== "null") {
            // –ï—Å–ª–∏ bookInfo –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å accessToken ‚Äî –∂–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏
            document.getElementById('uploadForm').classList.remove('active');
            document.getElementById('progressSection').classList.add('active');
            pollForBookByToken(accessToken);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
        function copyLink(event) {
            const linkText = document.getElementById('linkText').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                button.style.background = '#28a745';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#667eea';
                }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
            });
        }
        
        // –£–¥–∞–ª—è—é —Ñ—É–Ω–∫—Ü–∏—é generateQRCode –∏ –≤—Å–µ –≤—ã–∑–æ–≤—ã showPermanentLink, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å QR-–∫–æ–¥–æ–º
    </script>
</body>
</html> 