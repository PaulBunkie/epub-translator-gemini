<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>EPUB Translator - Загрузка книги</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Стили, приведенные в соответствие с workflow_index.html */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
        }
        .container {
            max-width: 900px;
            margin: auto;
        }
        h1, h2 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        /* Минимальные стили Bootstrap для меню */
        .navbar { position: relative; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding-top: .5rem; padding-bottom: .5rem; }
        .navbar-expand-sm { flex-wrap: nowrap; justify-content: flex-start; }
        .navbar-nav { display: flex; flex-direction: row; padding-left: 0; margin-bottom: 0; list-style: none; }
        .nav-link { display: block; padding: .5rem 1rem; color: rgba(255,255,255,.75); text-decoration: none; }
        .nav-link:hover, .nav-link:focus { color: rgba(255,255,255,1); }
        .navbar-dark .navbar-nav .nav-link.active { color: #fff; }
        .bg-primary { background-color: #0d6efd !important; }
        .navbar-dark { color: #fff; }
        .mb-4 { margin-bottom: 1.5rem !important; }
        .rounded { border-radius: .375rem !important; }
        .me-1 { margin-right: .25rem !important; }

        /* Стили для форм и списков, как в workflow */
        .upload-form {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .upload-form p { margin-bottom: 15px; }
        .upload-form label { display: block; margin-bottom: 5px; font-weight: bold;}
        .upload-form input[type="file"], .upload-form select {
            padding: 8px 12px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .upload-form select:disabled { background-color: #e9ecef; opacity: 0.7; cursor: not-allowed; }
        .upload-form button {
            cursor: pointer; background-color: #007bff; color: white; border: none;
            border-radius: 4px; padding: 10px 15px; font-size: 1em; width: 100%; max-width: 400px;
        }
        .upload-form button:hover { background-color: #0056b3; }

        .book-list { list-style: none; padding: 0; }
        .book-item {
            border-bottom: 1px solid #eee;
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .book-item:last-child {
            border-bottom: none;
        }
        .book-info { flex-grow: 1; margin-right: 15px; word-break: break-all; }
        .book-info .book-title { font-weight: bold; display: block; margin-bottom: 3px; }
        .book-info .book-status { font-size: 0.9em; color: #555; }
        .book-actions { flex-shrink: 0; display: flex; gap: 5px; }
        .book-actions a { text-decoration: none; }
        .book-actions button {
            cursor: pointer; border: none; border-radius: 4px; color: white;
            padding: 5px 10px;
        }
        .book-actions .btn-view { background-color: #007bff; }
        .book-actions .btn-view:hover { background-color: #0056b3; }
        .book-actions .btn-delete { background-color: #dc3545; }
        .book-actions .btn-delete:hover { background-color: #c82333; }

        /* Оверлей для загрузки */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000; display: none; justify-content: center; align-items: center; text-align: center;
        }
        #loading-overlay div {
             background-color: #fff; padding: 30px 40px; border-radius: 8px;
             box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 1.2em;
        }
        .loader {
             border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
             width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="container">
    {% if is_admin_mode %}
    {% set active_page = request.endpoint %}
    <nav class="navbar navbar-expand-sm navbar-dark bg-primary mb-4 rounded">
        <div class="container-fluid" style="padding-left: 2em; padding-right: 2em;">
            <div class="navbar-nav">
                <a class="nav-link {% if active_page == 'books' %}active{% endif %}" href="{{ url_for('books', admin='true' if is_admin_mode else None) }}">
                    <i class="fas fa-language me-1"></i>Перевод
                </a>
                <a class="nav-link {% if active_page == 'workflow_index' %}active{% endif %}" href="{{ url_for('workflow_index', admin='true' if is_admin_mode else None) }}">
                    <i class="fas fa-cogs me-1"></i>Workflow
                </a>
                <a class="nav-link {% if active_page == 'user_main_page' %}active{% endif %}" href="{{ url_for('user_main_page', admin='true' if is_admin_mode else None) }}">
                    <i class="fas fa-user me-1"></i>Пользователь
                </a>
                <a class="nav-link {% if active_page == 'toptube_page' %}active{% endif %}" href="{{ url_for('toptube_page', admin='true' if is_admin_mode else None) }}">
                    <i class="fas fa-video me-1"></i>Видео
                </a>
                <a class="nav-link {% if active_page == 'video_analysis_page' %}active{% endif %}" href="{{ url_for('video_analysis_page', admin='true' if is_admin_mode else None) }}">
                    <i class="fas fa-chart-bar me-1"></i>Видео-анализ
                </a>
                <a class="nav-link {% if active_page == 'find_locations_form_page' %}active{% endif %}" href="{{ url_for('find_locations_form_page', admin='true' if is_admin_mode else None) }}">
                    <i class="fas fa-map-marker-alt me-1"></i>Локации
                </a>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Оверлей для показа во время загрузки -->
    <div id="loading-overlay">
        <div>
            <div class="loader"></div>
            Загрузка и обработка EPUB...<br>
            Перевод оглавления может занять некоторое время.<br>
            Пожалуйста, подождите.
        </div>
    </div>

    <h1>EPUB Переводчик</h1>

    <div class="upload-form">
        <h2>Загрузить новую книгу</h2>
        <form id="upload-form" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
            <p>
                <label for="epub_file">Выберите файл EPUB:</label>
                <input type="file" id="epub_file" name="epub_file" accept=".epub" required>
            </p>
            <p>
                <label for="target_language">Целевой язык:</label>
                 <select id="target_language" name="target_language">
                     <option value="russian" {% if default_language == 'russian' %}selected{% endif %}>Russian</option>
                     <option value="english" {% if default_language == 'english' %}selected{% endif %}>English</option>
                     <option value="german" {% if default_language == 'german' %}selected{% endif %}>German</option>
                     <option value="french" {% if default_language == 'french' %}selected{% endif %}>French</option>
                     <option value="spanish" {% if default_language == 'spanish' %}selected{% endif %}>Spanish</option>
                </select>
            </p>
            <p>
                <label for="model-display">Текущая модель перевода:</label>
                <select id="model-display" name="model_display_disabled" disabled>
                    {% if available_models %}
                        <!-- Google Models -->
                        <optgroup label="Google Models">
                        {% for model_obj in available_models %}
                            {% if model_obj.name.startswith('gemini-') or model_obj.name.startswith('models/') %}
                            <option value="{{ model_obj.name }}" {% if selected_model == model_obj.name %}selected{% endif %}>
                                {{ model_obj.display_name }}
                            </option>
                            {% endif %}
                        {% endfor %}
                        </optgroup>

                        <!-- OpenRouter Models -->
                        <optgroup label="{{ 'All OpenRouter Models' if is_admin_mode else 'Free OpenRouter Models' }}">
                        {% for model_obj in available_models %}
                            {% if not (model_obj.name.startswith('gemini-') or model_obj.name.startswith('models/')) %}
                            <option value="{{ model_obj.name }}" {% if selected_model == model_obj.name %}selected{% endif %}>
                                {{ model_obj.display_name }}
                            </option>
                            {% endif %}
                        {% endfor %}
                        </optgroup>
                    {% else %}
                        <option value="{{ selected_model | default('meta-llama/llama-4-maverick:free') }}" selected>
                            {{ selected_model | default('meta-llama/llama-4-maverick:free') }}
                        </option>
                        <option disabled>Не удалось загрузить список моделей</option>
                    {% endif %}
                </select>
                 <small style="display: block; margin-top: -5px; color: #555;">Модель выбирается на странице просмотра книги.</small>
            </p>
            <p>
                <button type="submit">Загрузить</button>
            </p>
        </form>
    </div>

    <h2>Ранее загруженные книги</h2>

    <ul class="book-list">
        {% if uploaded_books %}
            {% for book in uploaded_books %}
                <li class="book-item">
                    <div class="book-info">
                        <span class="book-title">
                            {{ book.display_name | default('No Name') }}
                            {% if book.target_language %}
                                <span style="font-size: 0.8em; padding: 0px 3px; margin-left: 4px; background-color: #ffecec; border: 1px solid #e0c0c0; border-radius: 3px; color: #c00; white-space: nowrap;">{{ book.target_language }}</span>
                            {% endif %}
                        </span>
                        <span class="book-status" style="font-size: 0.8em;">
                             {% set total = book.total_sections | default(0) %}
                             {% if total > 0 %}
                                 Статус: {{ book.status | default('N/A') | replace('_', ' ') | capitalize }}
                             {% else %}
                                 Статус: Ошибка структуры? ({{ book.total_sections }} секций)
                             {% endif %}
                         </span>
                    </div>
                    <div class="book-actions">
                         <a href="{{ url_for('view_book', book_id=book.book_id) }}">
                              <button type="button" class="btn-view">Просмотр</button>
                         </a>
                         <form action="{{ url_for('delete_book_request', book_id=book.book_id) }}" method="post" style="display: inline;" onsubmit="return confirm('Удалить книгу \'{{ book.display_name | escape }}\'?');">
                             <button type="submit" class="btn-delete">Удалить</button>
                         </form>
                    </div>
                </li>
            {% endfor %}
        {% else %}
            <p>Еще не загружено ни одной книги.</p>
        {% endif %}
    </ul>
</div>

<script>
// Скрипт для показа оверлея при отправке формы
const uploadForm = document.getElementById('upload-form');
const loadingOverlay = document.getElementById('loading-overlay');
const fileInput = document.getElementById('epub_file');

if (uploadForm && loadingOverlay && fileInput) {
    uploadForm.addEventListener('submit', function(event) {
        if (fileInput.files.length === 0) {
            alert('Пожалуйста, выберите файл EPUB для загрузки.');
            event.preventDefault();
            return;
        }
        loadingOverlay.style.display = 'flex';
    });
} else {
    console.error("Не найдены элементы формы или оверлея для JS.");
}

// Скрытие оверлея при навигации назад/вперед
window.addEventListener('pageshow', function(event) {
    if (loadingOverlay && loadingOverlay.style.display === 'flex') {
        loadingOverlay.style.display = 'none';
    }
});
</script>

</body>
</html> 