<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB Translator Workflow</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        h1, h2 {
            color: #333;
        }
        #workflow-content {
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        #workflow-content .container {
            max-width: 800px;
            margin: 20px auto;
        }
        #workflow-content h1 {
            color: #333;
            font-size: 2em;
        }
        #workflow-content h2 {
            color: #333;
            font-size: 1.5em;
        }
        .upload-form {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .book-list {
            list-style: none;
            padding: 0;
        }
        .book-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .book-info strong {
            font-size: 1.1em;
        }
        .book-status {
            font-size: 0.9em;
            color: #555;
        }
        .book-info span.language {
            font-size: 0.8em;
            color: red;
            margin-left: 5px;
            font-weight: bold;
            vertical-align: middle;
        }
        .book-actions button {
            margin-left: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .status-processing {
            color: orange;
            font-weight: bold;
        }
        .status-completed {
            color: green;
            font-weight: bold;
        }
        .status-completed_with_errors {
            color: darkorange;
            font-weight: bold;
        }
        .status-error, .status-error_unknown {
            color: red;
            font-weight: bold;
        }
        .status-idle {
            color: gray;
        }
        .stage-status {
            font-weight: 500;
            color: #667eea;
        }
        .stage-status[data-stage="summarize"] {
            color: #28a745;
        }
        .stage-status[data-stage="analyze"] {
            color: #ffc107;
        }
        .stage-status[data-stage="translate"] {
            color: #17a2b8;
        }
        .stage-status[data-stage="epub_creation"] {
            color: #6f42c1;
        }
        .navbar { position: relative; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding-top: .5rem; padding-bottom: .5rem; }
        .navbar-expand-sm { flex-wrap: nowrap; justify-content: flex-start; }
        .navbar-nav { display: flex; flex-direction: column; padding-left: 0; margin-bottom: 0; list-style: none; }
        .navbar-expand-sm .navbar-nav { flex-direction: row; }
        .nav-link { display: block; padding: .5rem 1rem; color: rgba(255,255,255,.75); text-decoration: none; transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out; }
        .nav-link:hover, .nav-link:focus { color: rgba(255,255,255,1); }
        .navbar-dark .navbar-nav .nav-link.active { color: #fff; }
        .bg-primary { background-color: #0d6efd !important; }
        .navbar-dark { color: #fff; }
        .mb-4 { margin-bottom: 1.5rem !important; }
        .rounded { border-radius: .375rem !important; }
        .me-1 { margin-right: .25rem !important; }
        .workflow-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .workflow-overlay-content {
            background-color: #fff;
            color: #333;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .hidden-list {
            display: none;
        }
        .toggle-list-link {
            font-size: 0.6em;
            text-decoration: none;
            border-bottom: 1px dotted #007bff;
            color: #007bff;
            cursor: pointer;
            font-weight: normal;
        }
        .system-status-widget {
            background: #eef2f7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid #d1d9e6;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        {% if admin %}
        {% set active_page = request.endpoint %}
        <nav class="navbar navbar-expand-sm navbar-dark bg-primary mb-4 rounded">
            <div class="navbar-nav">
                <a class="nav-link {% if active_page == 'books' %}active{% endif %}" href="{{ url_for('books', admin='true' if admin else None) }}">
                    <i class="fas fa-language me-1"></i>Перевод
                </a>
                <a class="nav-link {% if active_page == 'workflow_index' %}active{% endif %}" href="{{ url_for('workflow_index', admin='true' if admin else None) }}">
                    <i class="fas fa-cogs me-1"></i>Workflow
                </a>
                <a class="nav-link {% if active_page == 'user_main_page' %}active{% endif %}" href="{{ url_for('user_main_page', admin='true' if admin else None) }}">
                    <i class="fas fa-user me-1"></i>Пользователь
                </a>
                <a class="nav-link {% if active_page == 'toptube_page' %}active{% endif %}" href="{{ url_for('toptube_page', admin='true' if admin else None) }}">
                    <i class="fas fa-video me-1"></i>Видео
                </a>
                <a class="nav-link {% if active_page == 'video_analysis_page' %}active{% endif %}" href="{{ url_for('video_analysis_page', admin='true' if admin else None) }}">
                    <i class="fas fa-chart-bar me-1"></i>Видео-анализ
                </a>
                <a class="nav-link {% if active_page == 'find_locations_form_page' %}active{% endif %}" href="{{ url_for('find_locations_form_page', admin='true' if admin else None) }}">
                    <i class="fas fa-map-marker-alt me-1"></i>Локации
                </a>
            </div>
        </nav>
        {% endif %}

        <div id="workflow-content">
            <h1>EPUB Workflow Dashboard</h1>

            {% if admin and system_status %}
            <div class="system-status-widget">
                <div title="Свободное место на диске">
                    <i class="fas fa-hdd" style="color: #4a5568; margin-right: 8px;"></i>
                    <strong>Диск:</strong> 
                    {% if system_status.free_gb < 0.2 %}
                        <span style="color: #e53e3e; font-weight: bold; font-size: 1.1em;">{{ system_status.free_gb }} GB</span>
                    {% else %}
                        <span style="color: #38a169; font-weight: bold; font-size: 1.1em;">{{ system_status.free_gb }} GB</span>
                    {% endif %}
                    <small style="color: #718096; margin-left: 5px;">({{ system_status.used_percent }}% занято)</small>
                </div>
                <div style="border-left: 2px solid #cbd5e0; padding-left: 25px;" title="Размер файла workflow.db">
                    <i class="fas fa-database" style="color: #4a5568; margin-right: 8px;"></i>
                    <strong>База данных:</strong> 
                    <span style="color: #2d3748; font-weight: bold;">{{ system_status.db_size_mb }} MB</span>
                </div>
            </div>
            {% endif %}

            {% if admin %}
            <div class="upload-form">
                <h2>Upload New EPUB for Workflow</h2>
                <form action="{{ url_for('workflow_upload_file') }}" method="post" enctype="multipart/form-data">
                    <input type="file" name="epub_file" accept=".epub" required>
                    <input type="hidden" name="admin" value="true">
                     <label for="target_language">Target Language:</label>
                    <select name="target_language" id="target_language">
                        <option value="russian">Russian</option>
                        <option value="english">English</option>
                        <option value="german">German</option>
                        <option value="french">French</option>
                        <option value="spanish">Spanish</option>
                    </select>
                    <button type="submit">Upload and Start Workflow</button>
                </form>
            </div>
            {% endif %}

            <h2>
                <a href="#" id="toggleBookListBtn" class="toggle-list-link">Books in Workflow ▼</a>
            </h2>
            <div id="bookListContainer">
            <ul class="book-list">
                {% for book in workflow_books %}
                    <li class="book-item" data-book-id="{{ book.book_id }}">
                        <div class="book-info">
                            <strong>{{ book.filename }}</strong>
                            {% if book.target_language %}
                                <span class="language">({{ book.target_language }})</span>
                            {% endif %}
                            <div class="book-status book-status-{{ book.status | lower }}">
                                Status: <span class="book-overall-status">{{ book.status or 'unknown' }}</span>
                                {% if book.book_stage_statuses %}
                                    <div style="margin-top: 6px;">
                                    {% for stage_name, stage_data in book.book_stage_statuses.items() %}
                                        <div style="margin-bottom: 2px;">
                                            {% if stage_name == 'translate' %}
                                                <a href="#" class="toggle-sections-link" data-book-id="{{ book.book_id }}" style="text-decoration: none; color: inherit;">
                                                    <span class="toggle-icon">▶</span> <strong>{{ stage_data.display_name or stage_name | title }}:</strong>
                                                </a>
                                            {% else %}
                                                <strong>{{ stage_data.display_name or stage_name | title }}:</strong>
                                            {% endif %}
                                            
                                            <span class="stage-status" data-stage="{{ stage_name }}">
                                                {{ stage_data.status or 'pending' }}
                                                {% if stage_data.is_per_section %}
                                                    ({{ book['processed_sections_count_' ~ stage_name] or 0 }} / {{ book.total_sections or 0 }} секций)
                                                {% endif %}
                                            </span>

                                            {% if stage_name == 'translate' %}
                                                <div class="sections-list" id="sections-{{ book.book_id }}" style="display: none; margin-left: 20px; font-size: 0.9em; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6; margin-top: 5px;">
                                                    <div class="sections-loading">Загрузка секций...</div>
                                                </div>
                                            {% endif %}
                                            {% if stage_name == 'summarize' and (stage_data.status in ['completed', 'completed_empty']) %}
                                                <a href="{{ url_for('workflow_download_summary', book_id=book.book_id) }}" style="margin-left: 10px;">Скачать суммаризацию</a>
                                                
                                                {% if admin %}
                                                    <button class="generate-comic-button" data-book-id="{{ book.book_id }}" style="margin-left: 10px; background-color: #6c757d; color: white; border: none; padding: 2px 8px; cursor: pointer; font-size: 0.8em; border-radius: 3px;">Сделать комикс</button>
                                                {% endif %}

                                                {% if book.comic_status == 'completed' %}
                                                    <a href="{{ url_for('workflow_book_comic_view', book_id=book.book_id, admin='true' if admin else None) }}" style="margin-left: 10px; color: #6f42c1; font-weight: bold;">Смотреть комикс</a>
                                                {% elif book.comic_status == 'processing' %}
                                                    <span style="margin-left: 10px; color: orange;">(Комикс в процессе...)</span>
                                                {% endif %}
                                            {% endif %}
                                            {% if stage_name == 'analyze' and (stage_data.status in ['completed', 'completed_empty']) %}
                                                <a href="{{ url_for('workflow_download_analysis', book_id=book.book_id) }}" style="margin-left: 10px;">Скачать анализ</a>
                                            {% endif %}
                                            {% if stage_name == 'epub_creation' and (stage_data.status in ['completed', 'completed_with_errors']) %}
                                                <a href="{{ url_for('workflow_download_epub', book_id=book.book_id) }}" style="margin-left: 10px;">Скачать EPUB</a>
                                                {% if admin %}
                                                    <a href="{{ url_for('workflow_download_epub', book_id=book.book_id, force_rebuild=1, admin='true') }}" style="margin-left: 10px; font-size: 0.85em; color: #dc3545;" title="Пересобрать файл с учетом новых картинок">Пересобрать EPUB</a>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="book-actions" style="margin-top: 10px;">
                            {% if admin %}
                                <button class="start-workflow-button" data-book-id="{{ book.book_id }}">Start Workflow</button>
                                <button class="delete-book-button" data-book-id="{{ book.book_id }}">Удалить</button>
                            {% endif %}
                        </div>
                    </li>
                {% else %}
                    <p>No books found in the workflow yet. Upload one above!</p>
                {% endfor %}
            </ul>
            </div>
        </div>
    </div>
    <div id="progressOverlay" class="workflow-overlay" style="display: none;">
        <div class="workflow-overlay-content">
            <h2>Processing Workflow...</h2>
            <p id="progressText">Starting...</p>
            <div class="spinner" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        const style = document.createElement('style');
        style.innerHTML = `
            .spinner {
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top: 4px solid #fff;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="{{ url_for('static', filename='js/workflow.js') }}"></script>
</body>
</html>