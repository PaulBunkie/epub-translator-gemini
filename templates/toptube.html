<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aiTube - Анализ популярных видео</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .video-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background: white;
        }
        
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .video-thumbnail {
            position: relative;
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            overflow: hidden;
        }
        
        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .video-card:hover .video-thumbnail img {
            transform: scale(1.05);
        }
        
        .video-thumbnail-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,107,107,0.8), rgba(78,205,196,0.8));
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .video-card:hover .video-thumbnail-overlay {
            opacity: 1;
        }
        
        .play-button {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff6b6b;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .status-badge {
            font-size: 0.8rem;
            border-radius: 20px;
            padding: 5px 12px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 0.7rem 0.5rem;
            min-width: 120px;
            max-width: 180px;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .stats-card .card-body {
            padding: 0.7rem 0.5rem;
        }
        
        .stats-card h5 {
            font-size: 1rem;
            margin-bottom: 0.2rem;
        }
        
        .stats-card h3 {
            font-size: 1.3rem;
            margin-bottom: 0;
        }
        
        .stats-card i {
            font-size: 1.5rem;
            margin-bottom: 0.2rem;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .btn-action {
            min-width: 120px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .analysis-text {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 15px;
        }
        
        .analysis-summary {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-radius: 10px;
            padding: 12px;
            border-left: 4px solid #ffc107;
            min-height: 80px;
            max-height: 120px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }
        
        .video-title {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.8em;
            max-height: 2.8em;
            line-height: 1.4;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .video-title-highlight {
            background: linear-gradient(135deg, #e3f0ff 0%, #d0ebff 100%);
            border-radius: 8px;
            padding: 6px 10px;
            display: block;
            width: 100%;
            font-weight: 600;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(80, 140, 255, 0.07);
            margin-bottom: 0.3em;
            min-height: 4.2em;
            display: flex;
            align-items: center;
        }
        .video-title-highlight a {
            display: block;
            width: 100%;
            color: inherit;
            text-decoration: none;
        }
        
        .analysis-summary-content {
            width: 100%;
            white-space: normal;
            text-overflow: ellipsis;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .video-meta {
            font-size: 0.85rem;
            color: #666;
        }
        
        .video-meta i {
            color: #667eea;
            width: 16px;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-body {
            padding: 1rem;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }
        
        .form-select, .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .meta-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 0.7em;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 0.5em;
        }
        
        .meta-inline .meta-item {
            display: flex;
            align-items: center;
            gap: 0.2em;
        }
        
        .video-meta-col, .video-summary-col {
            display: unset;
            align-items: unset;
            gap: unset;
            min-height: unset;
        }
        
        .analysis-summary {
            width: 100%;
            margin-bottom: 0;
        }
        
        .card-footer-fixed {
            margin-top: auto;
        }
        
        .channel-title {
            font-size: 0.95em;
            color: #b23c17;
            font-weight: 600;
            margin-bottom: 1rem;
            letter-spacing: 0.01em;
        }
        
        .meta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 1rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #666;
        }
        
        .duration-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 1rem;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .video-card {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .video-card:nth-child(1) { animation-delay: 0.1s; }
        .video-card:nth-child(2) { animation-delay: 0.2s; }
        .video-card:nth-child(3) { animation-delay: 0.3s; }
        .video-card:nth-child(4) { animation-delay: 0.4s; }
        .video-card:nth-child(5) { animation-delay: 0.5s; }
        
        /* Мобильные устройства */
        @media (max-width: 768px) {
            /* Убираем навигационную панель */
            .navbar {
                display: none !important;
            }
            
            /* Убираем сиреневый фон */
            body {
                background: white !important;
            }
            
            /* Минимизируем отступы белой подложки */
            .main-content {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                margin: 0 !important;
                padding: 10px !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            
            /* Убираем отступ сверху */
            .main-content .row:first-child {
                margin-top: 0;
            }
            
            /* Белый заголовок с уменьшенным шрифтом */
            .main-content h1 {
                color: white !important;
                font-size: 1.5rem !important;
            }
            
            /* Белая иконка Play для мобилы */
            .main-content h1 .fas {
                color: white !important;
            }
            
            /* Белый подзаголовок для мобилы */
            .main-content p.text-muted {
                color: rgba(255, 255, 255, 0.8) !important;
            }
            /* Цвет буквы a для мобилы */
            .ai-logo-a {
                color: #ffe066 !important;
            }
            .ai-logo-tube {
                color: white !important;
            }
        }
        
        /* Скрываем навигацию для не-админов */
        .navbar {
            display: none;
        }
        
        /* Показываем навигацию только для админов */
        .admin-mode .navbar {
            display: block;
        }
        /* Цвет буквы a для десктопа */
        .ai-logo-a {
            color: #b23c17;
        }
        .ai-logo-tube {
            color: #4b3fa7;
        }
        @media (min-width: 768px) {
            #stats-container {
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 16px;
                justify-content: center;
                align-items: stretch;
            }
        }
        @media (max-width: 767.98px) {
            #stats-container {
                display: flex;
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }
        }
        .stats-block {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-radius: 16px;
            width: 150px;
            min-width: 0;
            min-height: 80px;
            flex: 0 0 150px;
            padding: 10px 8px 8px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(80, 80, 160, 0.10);
            margin: 0;
        }
        .stats-block i {
            font-size: 1.5rem;
            margin-bottom: 0.2em;
        }
        .stats-label {
            font-size: 0.95em;
            margin-bottom: 0.2em;
            font-weight: 400;
        }
        .stats-value {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 0;
        }
        #stats-container {
            display: flex;
            flex-direction: row;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            flex-wrap: nowrap;
        }
        .stat-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-radius: 999px;
            min-width: 80px;
            min-height: 48px;
            padding: 6px 12px 4px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            font-weight: 500;
            border: none;
            box-shadow: 0 1px 4px rgba(80, 80, 160, 0.10);
            transition: background 0.2s;
        }
        .stat-btn i {
            font-size: 1.1rem;
            margin-bottom: 0.1em;
        }
        .stat-label {
            font-size: 0.85em;
            margin-bottom: 0.1em;
            font-weight: 400;
        }
        .stat-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 0;
        }
        @media (max-width: 767.98px) {
            #stats-container {
                flex-wrap: wrap;
                gap: 8px;
            }
            .stat-btn {
                min-width: 44vw;
                font-size: 0.95rem;
                padding: 6px 0 4px 0;
            }
        }
        /* Цвет иконки Play в заголовке для десктопа */
        .main-content h1 .fa-play-circle {
            color: #4b3fa7 !important;
        }
        @media (max-width: 768px) {
            .main-content h1 .fa-play-circle {
                color: white !important;
            }
        }
        
        /* Стили для чата */
        .chat-message {
            margin-bottom: 15px;
        }
        
        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .user-message {
            text-align: right;
        }
        
        .user-bubble {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 6px;
        }
        
        .ai-message {
            text-align: left;
        }
        
        .ai-bubble {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 6px;
        }
        
        .chat-history {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background-color: #fefefe;
        }
        
        .chat-history:empty:before {
            content: "Диалог будет отображаться здесь...";
            color: #999;
            font-style: italic;
        }
        
        /* Стили для ссылок по таймкодам */
        .timelink {
            color: #dc3545 !important;
            text-decoration: none !important;
            font-weight: bold;
            background: rgba(220, 53, 69, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(220, 53, 69, 0.3);
            display: inline-block;
            margin: 0 2px;
            transition: all 0.2s ease;
        }
        
        .timelink:hover {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
        }
        
        /* Стили для форматированного текста в чате */
        .ai-bubble h3, .ai-bubble h4, .ai-bubble h5 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .ai-bubble h3 {
            font-size: 1.1em;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 5px;
        }
        
        .ai-bubble ul, .ai-bubble ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ai-bubble li {
            margin-bottom: 5px;
        }
        
        .ai-bubble p {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .ai-bubble strong {
            color: #495057;
        }
        
        /* Стили для плавающей кнопки "Обсудить" при выделении текста */
        .floating-discuss-btn {
            position: absolute;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            z-index: 1060;
            display: none;
            white-space: nowrap;
            transition: all 0.2s ease;
            animation: popIn 0.2s ease-out;
            min-height: 44px; /* Минимальный размер для тача */
            line-height: 24px;
        }
        
        /* Увеличенная кнопка для мобильных устройств */
        @media (max-width: 768px) {
            .floating-discuss-btn {
                padding: 12px 20px;
                font-size: 15px;
                border-radius: 30px;
                min-height: 48px;
                min-width: 120px;
                line-height: 24px;
            }
        }
        
        .floating-discuss-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        
        .floating-discuss-btn:active {
            transform: translateY(0);
        }
        
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Стиль для выделенного текста */
        ::selection {
            background-color: rgba(40, 167, 69, 0.2);
            color: inherit;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: #3a256a !important;">
        <div class="container">
            <div class="navbar-nav justify-content-center w-100">
                <a class="nav-link" href="/books{% if admin %}?admin=true{% endif %}"><i class="fas fa-book me-1"></i>Перевод</a>
                <a class="nav-link" href="/workflow{% if admin %}?admin=true{% endif %}"><i class="fas fa-cogs me-1"></i>Workflow</a>
                <a class="nav-link" href="/user{% if admin %}?admin=true{% endif %}"><i class="fas fa-user me-1"></i>Пользователь</a>
                <a class="nav-link active" href="/?admin=true"><i class="fas fa-video me-1"></i>Видео</a>
                <a class="nav-link" href="/video-analysis{% if admin %}?admin=true{% endif %}"><i class="fas fa-chart-bar me-1"></i>Видео-анализ</a>
                <a class="nav-link" href="/trump{% if admin %}?admin=true{% endif %}"><i class="fas fa-map-marker-alt me-1"></i>Локации</a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <!-- Заголовок и статистика -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-6 mb-1 text-center fw-bold" style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: bold;">
                    <i class="fas fa-play-circle text-primary me-2"></i><span class="ai-logo-a">ai</span><span class="ai-logo-tube">Tube</span>
                </h1>
                <p class="text-muted mb-0 text-center" style="font-size: 0.9rem;">
                    ИИ-анализ популярных видео
                </p>
            </div>
        </div>

        <!-- Кнопки управления и статистика (всё скрывается для не-админа) -->
        <div class="row mb-4" id="management-container">
            <div class="col-12">
                <div id="stats-container" class="d-flex flex-wrap gap-2 justify-content-center mb-4 admin-only">
                    <button type="button" class="btn btn-primary btn-sm stat-btn">
                        <i class="fas fa-video"></i>
                        <div class="stat-label">Всего</div>
                        <div class="stat-value" id="total-videos">-</div>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm stat-btn">
                        <i class="fas fa-check-circle"></i>
                        <div class="stat-label">Анализ</div>
                        <div class="stat-value" id="analyzed-videos">-</div>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm stat-btn">
                        <i class="fas fa-clock"></i>
                        <div class="stat-label">В обр.</div>
                        <div class="stat-value" id="processing-videos">-</div>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm stat-btn">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="stat-label">Ошибки</div>
                        <div class="stat-value" id="error-videos">-</div>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm stat-btn">
                        <i class="fas fa-clock"></i>
                        <div class="stat-label">Последний сбор</div>
                        <div class="stat-value" id="last-collection">-</div>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm stat-btn">
                        <i class="fas fa-database"></i>
                        <div class="stat-label">Добавлено</div>
                        <div class="stat-value" id="added-count">-</div>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm stat-btn">
                        <i class="fas fa-calendar-alt"></i>
                        <div class="stat-label">Следующий запуск</div>
                        <div class="stat-value" id="next-run">-</div>
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-cogs me-2"></i>Управление
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-warning btn-action" onclick="runFullWorkflow()">
                                <i class="fas fa-cogs me-1"></i>
                                Полный процесс
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="workflow-spinner"></span>
                            </button>
                            <button class="btn btn-primary btn-action" onclick="collectVideos()">
                                <i class="fas fa-download me-1"></i>
                                Собрать видео
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="collect-spinner"></span>
                            </button>
                            <button class="btn btn-success btn-action" onclick="analyzeNextVideo()">
                                <i class="fas fa-play me-1"></i>
                                Анализировать все видео
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="analyze-spinner"></span>
                            </button>
                            <button class="btn btn-danger btn-action" onclick="resetStuckVideos()">
                                <i class="fas fa-undo me-1"></i>
                                Сбросить зависшие
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="reset-spinner"></span>
                            </button>
                            <button class="btn btn-warning btn-action" onclick="resetErrorVideos()">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Сбросить ошибки
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="reset-errors-spinner"></span>
                            </button>
                            <button class="btn btn-info btn-action" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-1"></i>
                                Обновить
                            </button>
                            <button class="btn btn-dark btn-action" onclick="deleteNonAnalyzedVideos()">
                                <i class="fas fa-trash me-1"></i>
                                Удалить неуспешные
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="delete-spinner"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Фильтры -->
        <div class="row mb-4" id="filters-container">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label for="status-filter" class="form-label">Статус:</label>
                                <select class="form-select" id="status-filter" onchange="loadVideos()">
                                    <option value="analyzed">Проанализированные</option>
                                    <option value="new">Новые</option>
                                    <option value="processing">В обработке</option>
                                    <option value="error">С ошибками</option>
                                    <option value="all">Все</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="limit-filter" class="form-label">Количество:</label>
                                <select class="form-select" id="limit-filter" onchange="loadVideos()">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список видео -->
        <div class="row" id="videos-container">
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3">Загрузка видео...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для детального просмотра -->
    <div class="modal fade" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalTitle">Детали видео</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="videoModalBody">
                    <!-- Контент будет загружен динамически -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" id="modalChatBtn" style="display: none;" onclick="toggleVideoChat()">
                        <i class="fas fa-comments me-1"></i>Обсудить
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Глобальные переменные
        var currentVideos = [];
        var isAdminMode = false;

        // Проверяем режим при загрузке страницы
        function checkAdminMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const adminParam = urlParams.get('admin');
            isAdminMode = adminParam === 'true';
            
            console.log('[AdminMode] URL params:', window.location.search);
            console.log('[AdminMode] admin param value:', adminParam);
            console.log('[AdminMode] isAdminMode:', isAdminMode);
            
            // Добавляем класс admin-mode к body для показа навигации
            if (isAdminMode) {
                document.body.classList.add('admin-mode');
            } else {
                document.body.classList.remove('admin-mode');
            }
            
            // Скрываем/показываем элементы в зависимости от режима
            const adminElements = [
                'stats-container',
                'management-container', 
                'filters-container'
            ];
            
            adminElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = isAdminMode ? 'block' : 'none';
                }
            });
            
            // Если не админский режим, загружаем только проанализированные видео
            if (!isAdminMode) {
                document.getElementById('status-filter').value = 'analyzed';
                document.getElementById('limit-filter').value = '50';
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminMode();
            if (isAdminMode) {
                loadStats();
            }
            loadVideos();
            tryOpenModalByParam();
        });

        // Загрузка статистики
        async function loadStats() {
            try {
                const response = await fetch('/api/toptube/stats');
                const data = await response.json();
                
                console.log('Статистика получена:', data); // Отладочная информация
                
                if (data.success) {
                    const stats = data.stats;
                    console.log('Данные статистики:', stats); // Отладочная информация
                    
                    document.getElementById('total-videos').textContent = stats.total || 0;
                    document.getElementById('analyzed-videos').textContent = stats.analyzed || 0;
                    document.getElementById('processing-videos').textContent = stats.processing || 0;
                    document.getElementById('error-videos').textContent = stats.error || 0;
                    
                    // Информация о последнем сборе
                    if (stats.last_collection_time) {
                        console.log('Raw last_collection_time:', stats.last_collection_time);
                        
                        // Парсим время из SQLite формата (UTC)
                        const lastCollection = new Date(stats.last_collection_time + 'Z'); // Добавляем Z для явного указания UTC
                        const now = new Date();
                        
                        console.log('Parsed lastCollection:', lastCollection.toISOString());
                        console.log('Current time:', now.toISOString());
                        
                        const diffMs = now - lastCollection;
                        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        
                        console.log('Time difference (ms):', diffMs);
                        console.log('Hours:', diffHours, 'Minutes:', diffMinutes);
                        
                        let timeText;
                        if (diffHours > 0) {
                            timeText = `${diffHours}ч ${diffMinutes}м назад`;
                        } else {
                            timeText = `${diffMinutes}м назад`;
                        }
                        
                        document.getElementById('last-collection').textContent = timeText;
                    } else {
                        document.getElementById('last-collection').textContent = 'Нет данных';
                    }
                    
                    document.getElementById('added-count').textContent = stats.last_collection_added || 0;
                    if (data.time_until_next) {
                        document.getElementById('next-run').textContent = data.time_until_next;
                    } else {
                        document.getElementById('next-run').textContent = '-';
                    }
                } else {
                    console.error('Ошибка в ответе статистики:', data.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }

        // Загрузка видео
        async function loadVideos() {
            let status, limit;
            
            if (isAdminMode) {
                // В админском режиме используем значения из фильтров
                status = document.getElementById('status-filter').value;
                limit = document.getElementById('limit-filter').value;
            } else {
                // В обычном режиме всегда загружаем только проанализированные видео
                status = 'analyzed';
                limit = '50';
            }
            
            try {
                const response = await fetch(`/api/toptube/videos?status=${status}&limit=${limit}`);
                const data = await response.json();
                
                if (data.success) {
                    currentVideos = data.videos;
                    renderVideos(data.videos);
                } else {
                    showError('Ошибка загрузки видео: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки видео:', error);
                showError('Ошибка загрузки видео');
            }
        }

        // Отрисовка видео
        function renderVideos(videos) {
            const container = document.getElementById('videos-container');
            
            if (videos.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h5>Видео не найдены</h5>
                            <p>Попробуйте изменить фильтры или собрать новые видео</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = videos.map(video => createVideoCard(video)).join('');
        }

        // Создание карточки видео
        function createVideoCard(video) {
            const statusBadge = getStatusBadge(video.status);
            const duration = formatDuration(video.duration);
            const views = formatNumber(video.views);
            const subscribers = formatNumber(video.subscribers);
            const publishedDate = new Date(video.published_at).toLocaleDateString('ru-RU');
            const thumbnailUrl = `https://img.youtube.com/vi/${video.video_id}/maxresdefault.jpg`;
            let statusHtml = '';
            if (isAdminMode) {
                statusHtml = `<span>${statusBadge}</span>`;
            }
            return `
                <div class="col-md-6 col-lg-4 col-xxl-3 mb-4">
                    <div class="card video-card h-100 d-flex flex-column">
                        <div class="video-thumbnail">
                            <img src="${thumbnailUrl}" alt="${video.title}" 
                                 onerror="this.src='https://img.youtube.com/vi/${video.video_id}/hqdefault.jpg'"
                                 onload="this.style.display='block'">
                            <div class="video-thumbnail-overlay">
                                <div class="play-button">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                            <div class="duration-badge">${duration}</div>
                        </div>
                        
                        <div class="card-body d-flex flex-column">
                            <h6 class="video-title mb-2">
                                <a href="${video.url}" target="_blank" class="text-decoration-none">
                                    ${video.title}
                                </a>
                            </h6>
                            <p class="channel-title mb-2">${video.channel_title}</p>
                            <div class="meta-inline mb-2">
                                <div class="meta-item"><i class="fas fa-eye me-1"></i> ${views}</div>
                                <div class="meta-item"><i class="fas fa-users me-1"></i> ${subscribers}</div>
                                <div class="meta-item"><i class="fas fa-calendar me-1"></i> ${publishedDate}</div>
                                <div class="meta-item"><i class="fas fa-clock me-1"></i> ${duration}</div>
                            </div>
                            ${video.analysis_summary ? `
                                <div class="analysis-summary mb-3">
                                    <div class="analysis-summary-content">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                        ${video.analysis_summary}
                                    </div>
                                </div>
                            ` : video.analysis_result ? `
                                <div class="analysis-text mb-3">
                                    <strong>Анализ:</strong><br>
                                    ${video.analysis_result.substring(0, 200)}${video.analysis_result.length > 200 ? '...' : ''}
                                </div>
                            ` : ''}
                            <div class="d-flex align-items-center mt-auto card-footer-row">
                                ${statusHtml}
                                <button class="btn btn-outline-primary btn-sm rounded-pill flex-grow-1 mx-2" style="min-width:120px" onclick="showVideoDetails('${video.video_id}')">
                                    <i class="fas fa-info-circle me-1"></i>Подробно
                                </button>
                                <button class="btn btn-outline-secondary btn-sm rounded-pill ms-2" onclick="shareVideo('${video.video_id}')">
                                    <i class="fas fa-share-alt"></i> Поделиться
                                </button>
                                ${isAdminMode ? `
                                    <button class="btn btn-outline-danger btn-sm rounded-pill ms-2" onclick="deleteVideo(${video.id})" title="Удалить видео">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Получение бейджа статуса
        function getStatusBadge(status) {
            const badges = {
                'new': '<span class="badge bg-secondary status-badge">Н</span>',
                'processing': '<span class="badge bg-warning status-badge">П</span>',
                'analyzed': '<span class="badge bg-success status-badge"><i class=\"fas fa-check\"></i></span>',
                'error': '<span class="badge bg-danger status-badge">О</span>'
            };
            return badges[status] || '<span class="badge bg-secondary status-badge">?</span>';
        }

        // Форматирование длительности
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return hours > 0 ? `${hours}ч ${minutes}м` : `${minutes}м`;
        }

        // Форматирование чисел
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Показать детали видео
        function showVideoDetails(videoId) {
            const video = currentVideos.find(v => v.video_id === videoId);
            if (!video) return;

            const modalTitle = document.getElementById('videoModalTitle');
            const modalBody = document.getElementById('videoModalBody');
            const thumbnailUrl = `https://img.youtube.com/vi/${video.video_id}/maxresdefault.jpg`;
            
            modalTitle.textContent = video.title;
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-2">
                            <img src="${thumbnailUrl}" alt="${video.title}" 
                                 class="img-fluid rounded" style="max-width: 180px; max-height: 110px; object-fit:cover;"
                                 onerror="this.src='https://img.youtube.com/vi/${video.video_id}/hqdefault.jpg'">
                        </div>
                        <div style="font-size:0.95em;">
                          <div><strong>Канал:</strong> ${video.channel_title}</div>
                          <div><strong>Длительность:</strong> ${formatDuration(video.duration)}</div>
                          <div><strong>Просмотры:</strong> ${formatNumber(video.views)}</div>
                          <div><strong>Подписчики:</strong> ${formatNumber(video.subscribers)}</div>
                          <div><strong>Дата публикации:</strong> ${new Date(video.published_at).toLocaleDateString('ru-RU')}</div>
                          <div><strong>Статус:</strong> ${getStatusBadge(video.status)}</div>
                        </div>
                        <a href="${video.url}" target="_blank" class="btn btn-primary btn-sm w-100 mt-2">
                            <i class="fas fa-external-link-alt me-1"></i> YouTube
                        </a>
                        <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="shareVideo('${video.video_id}')">
                            <i class="fas fa-share-alt"></i> Поделиться
                        </button>
                        ${video.analysis_result || video.analysis_summary ? `
                            <button class="btn btn-success btn-sm w-100 mt-2" onclick="toggleVideoChat()">
                                <i class="fas fa-comments me-1"></i> Обсудить
                            </button>
                        ` : ''}
                    </div>
                    <div class="col-md-8">
                        <div id="modal-analysis-markdown"></div>
                        ${video.error_message ? `
                            <div class="mt-3">
                                <h6 class="text-danger">Ошибка</h6>
                                <div class="text-danger small">${video.error_message}</div>
                            </div>
                        ` : ''}
                        
                        <!-- Кнопка "Обсудить" внизу контента -->
                        ${video.analysis_result || video.analysis_summary ? `
                            <div class="mt-4 text-center">
                                <button class="btn btn-success" onclick="toggleVideoChat()">
                                    <i class="fas fa-comments me-2"></i>Обсудить это видео
                                </button>
                            </div>
                        ` : ''}
                        
                    </div>
                </div>
                
                <!-- Диалог для обсуждения (скрыт по умолчанию) -->
                <div id="videoChatSection" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-comments me-2"></i>Обсуждение видео
                                <button type="button" class="btn btn-sm btn-outline-light float-end" onclick="toggleVideoChat()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- История диалога -->
                            <div id="chatHistory" class="chat-history mb-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-muted text-center py-3">
                                    <i class="fas fa-robot me-2"></i>
                                    Привет! Готов обсудить это видео. О чем хотите поговорить?
                                </div>
                            </div>
                            
                            <!-- Поле для ввода сообщения -->
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="Задайте вопрос о содержании видео..." onkeypress="handleChatKeyPress(event)">
                                <button class="btn btn-success" type="button" onclick="sendChatMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            
                            <!-- Индикатор загрузки -->
                            <div id="chatLoader" class="text-center mt-2" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-success" role="status">
                                    <span class="visually-hidden">Думаю...</span>
                                </div>
                                <small class="text-muted ms-2">ИИ обдумывает ответ...</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const analysisDiv = document.getElementById('modal-analysis-markdown');
                if (video.analysis_result) {
                    if (window.marked) {
                        analysisDiv.innerHTML = window.marked.parse(video.analysis_result);
                    } else {
                        analysisDiv.textContent = video.analysis_result;
                    }
                } else if (video.analysis_summary) {
                    analysisDiv.innerHTML = `<div class="analysis-summary-content">${video.analysis_summary}</div>`;
                } else {
                    analysisDiv.innerHTML = '<p class="text-muted">Анализ недоступен</p>';
                }
                
                // Показываем кнопку "Обсудить" в футере если есть анализ
                const modalChatBtn = document.getElementById('modalChatBtn');
                if (video.analysis_result || video.analysis_summary) {
                    modalChatBtn.style.display = 'inline-block';
                    // Сохраняем ID видео для чата
                    const previousVideoId = window.currentVideoId;
                    window.currentVideoId = videoId;
                    console.log(`[VideoModal] Переключение видео: ${previousVideoId || 'none'} → ${videoId}`);
                    
                    // НЕ отменяем запросы - позволяем им завершиться и сохранить ответы в соответствующие чаты
                    if (previousVideoId && previousVideoId !== videoId) {
                        console.log(`[RequestIsolation] Переключение ${previousVideoId} → ${videoId}. Активные запросы предыдущего видео продолжат выполнение`);
                    }
                    
                    // Загружаем умные подсказки для видео (асинхронно)
                    loadVideoSuggestions(videoId);
                } else {
                    modalChatBtn.style.display = 'none';
                }
            }, 0);
            // Очищаем предыдущее выделение при открытии нового видео
            clearTextSelectionAndButton();
            
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            
            // Добавляем обработчик закрытия модала
            const modalElement = document.getElementById('videoModal');
            modalElement.addEventListener('hidden.bs.modal', function () {
                console.log('[Modal] Модал закрыт, очищаем выделение');
                clearTextSelectionAndButton();
            });
            
            modal.show();
        }

        function shareVideo(videoId) {
            const url = `${window.location.origin}/?video=${videoId}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Ссылка скопирована!');
            });
        }

        function deleteVideo(videoId) {
            if (!confirm('Вы уверены, что хотите удалить это видео? Это действие нельзя отменить.')) {
                return;
            }
            
            fetch(`/api/toptube/videos/${videoId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Удаляем карточку видео из интерфейса
                    const videoCard = document.querySelector(`[onclick*="deleteVideo(${videoId})"]`).closest('.col-md-6');
                    if (videoCard) {
                        videoCard.remove();
                    }
                    alert('Видео успешно удалено!');
                } else {
                    alert('Ошибка при удалении видео: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Ошибка при удалении видео:', error);
                alert('Ошибка при удалении видео');
            });
        }

        // === ФУНКЦИИ ДЛЯ ВИДЕО ДИАЛОГОВ ===
        
        function startVideoChat(videoId) {
            // Открываем детали видео и сразу показываем диалог
            showVideoDetails(videoId);
            setTimeout(() => {
                toggleVideoChat();
            }, 100);
        }

        function toggleVideoChat() {
            const chatSection = document.getElementById('videoChatSection');
            const isVisible = chatSection.style.display !== 'none';
            
            if (isVisible) {
                // Скрываем диалог
                chatSection.style.display = 'none';
            } else {
                // Показываем диалог
                chatSection.style.display = 'block';
                // Фокусируемся на поле ввода
                document.getElementById('chatInput').focus();
                // Инициализируем диалог если нужно
                initializeVideoChat();
            }
        }

        function initializeVideoChat() {
            const chatHistory = document.getElementById('chatHistory');
            // Очищаем старое приветственное сообщение
            chatHistory.innerHTML = '';
            
            console.log(`[ChatHistory] Инициализация чата для видео ${window.currentVideoId}`);
            
            // Восстанавливаем историю из памяти
            if (window.currentVideoId) {
                const savedHistory = getChatHistory(window.currentVideoId);
                console.log(`[ChatHistory] Восстанавливаем ${savedHistory.length} сообщений для видео ${window.currentVideoId}`);
                
                // Проверяем есть ли новые ответы (сообщения assistant которые пришли пока видео было неактивно)
                let newResponses = 0;
                if (savedHistory.length > 0) {
                    // Считаем сколько сообщений assistant в конце истории
                    for (let i = savedHistory.length - 1; i >= 0; i--) {
                        if (savedHistory[i].role === 'assistant' && 
                            savedHistory[i].timestamp > (Date.now() - 60000)) { // за последнюю минуту
                            newResponses++;
                        } else {
                            break;
                        }
                    }
                    
                    if (newResponses > 0) {
                        console.log(`[ChatHistory] 🔔 Найдено ${newResponses} новых ответов для видео ${window.currentVideoId}!`);
                    }
                }
                
                savedHistory.forEach(msg => {
                    // Используем skipSave=true чтобы НЕ дублировать сообщения в истории
                    addChatMessage(msg.role, msg.content, null, true);
                });
            }
            
            // Если истории нет, добавляем приветственное сообщение с умными подсказками
            if (chatHistory.children.length === 0) {
                const smartSuggestions = window.currentVideoId ? getVideoSuggestions(window.currentVideoId) : getFallbackSuggestions();
                addChatMessage('welcome', 'Привет! Готов обсудить это видео. Вот несколько идей для разговора:', smartSuggestions);
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!window.currentVideoId) {
                alert('Ошибка: не выбрано видео для обсуждения');
                return;
            }
            
            // КРИТИЧНО: Захватываем videoId в начале функции для изоляции
            const videoId = window.currentVideoId;
            console.log(`[ChatIsolation] Отправляем сообщение для видео ${videoId}: "${message.substring(0, 50)}..."`);
            
            // Проверяем не заблокирован ли уже этот видео
            if (window.videoLoadingStates && window.videoLoadingStates[videoId]) {
                console.log(`[ChatIsolation] Видео ${videoId} уже обрабатывает запрос, игнорируем`);
                return;
            }
            
            // Отменяем предыдущий запрос для этого же видео чтобы избежать дублирования
            if (window.videoRequestControllers[videoId]) {
                console.log(`[ChatIsolation] Отменяем предыдущий запрос для видео ${videoId} чтобы избежать дублирования`);
                window.videoRequestControllers[videoId].abort();
                delete window.videoRequestControllers[videoId];
            }
            
            // Добавляем сообщение пользователя (только если это еще активное видео)
            if (window.currentVideoId === videoId) {
                addChatMessage('user', message);
                input.value = ''; // Очищаем поле ввода
            } else {
                console.log(`[ChatIsolation] Видео ${videoId} больше не активно, отменяем`);
                return;
            }
            
            // Включаем индикатор загрузки для этого видео
            setVideoLoading(videoId, true);
            
            try {
                // Создаем AbortController для этого запроса
                const controller = new AbortController();
                window.videoRequestControllers[videoId] = controller;
                
                // Получаем историю диалога для конкретного видео
                const history = getChatHistory(videoId);
                
                console.log(`[ChatIsolation] Отправляем API запрос для видео ${videoId}`);
                
                // Отправляем запрос к API с abort signal
                const response = await fetch(`/api/videos/${videoId}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: history
                    }),
                    signal: controller.signal
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`[ChatIsolation] Получен ответ для видео ${videoId}, модель: ${data.model_used}`);
                    
                    // Сохраняем ответ в историю соответствующего видео
                    saveChatMessage(videoId, 'assistant', data.response);
                    
                    // Показываем в UI только если это активное видео
                    if (window.currentVideoId === videoId) {
                        addChatMessage('ai', data.response, null, true); // skipSave=true, уже сохранили выше
                    } else {
                        console.log(`[ChatIsolation] Ответ сохранен в историю неактивного видео ${videoId}, будет показан при возвращении`);
                    }
                } else {
                    console.log(`[ChatIsolation] Ошибка API для видео ${videoId}: ${data.error}`);
                    
                    // Сохраняем сообщение об ошибке
                    const errorMessage = `❌ Ошибка: ${data.error}`;
                    saveChatMessage(videoId, 'assistant', errorMessage);
                    
                    // Показываем в UI только если это активное видео
                    if (window.currentVideoId === videoId) {
                        addChatMessage('ai', errorMessage, null, true); // skipSave=true
                    } else {
                        console.log(`[ChatIsolation] Ошибка сохранена в историю неактивного видео ${videoId}`);
                    }
                }
                
            } catch (error) {
                // Игнорируем ошибки отмененных запросов
                if (error.name === 'AbortError') {
                    console.log(`[ChatIsolation] Запрос для видео ${videoId} отменен`);
                    return;
                }
                
                console.error(`[ChatIsolation] Ошибка сети для видео ${videoId}:`, error);
                
                // Сохраняем сообщение об ошибке сети в историю
                const networkErrorMessage = '❌ Ошибка сети. Проверьте подключение к интернету.';
                saveChatMessage(videoId, 'assistant', networkErrorMessage);
                
                // Показываем в UI только если это активное видео
                if (window.currentVideoId === videoId) {
                    addChatMessage('ai', networkErrorMessage, null, true); // skipSave=true
                } else {
                    console.log(`[ChatIsolation] Ошибка сети сохранена в историю неактивного видео ${videoId}`);
                }
            } finally {
                // Убираем контроллер из активных
                if (window.videoRequestControllers[videoId]) {
                    delete window.videoRequestControllers[videoId];
                }
                
                // Отключаем индикатор загрузки для этого видео
                setVideoLoading(videoId, false);
            }
        }

        // === УМНЫЕ ПОДСКАЗКИ ===
        
        function loadVideoSuggestions(videoId) {
            console.log(`[Suggestions] Запрос подсказок для видео ${videoId}`);
            
            // Проверяем кеш подсказок
            if (window.videoSuggestions && window.videoSuggestions[videoId]) {
                console.log(`[Suggestions] Используем кешированные подсказки для ${videoId}`);
                return;
            }
            
            // Инициализируем хранилище подсказок
            if (!window.videoSuggestions) {
                window.videoSuggestions = {};
            }
            
            // Помечаем что подсказки загружаются
            window.videoSuggestions[videoId] = 'loading';
            
            // Асинхронный запрос подсказок
            fetch(`/api/videos/${videoId}/suggestions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.suggestions) {
                        window.videoSuggestions[videoId] = data.suggestions;
                        if (data.generated_by_ai && data.model_used) {
                            console.log(`[Suggestions] Загружено ${data.suggestions.length} умных подсказок для ${videoId} (модель: ${data.model_used})`);
                        } else {
                            console.log(`[Suggestions] Загружено ${data.suggestions.length} стандартных подсказок для ${videoId}`);
                        }
                    } else {
                        console.log(`[Suggestions] Ошибка при загрузке подсказок: ${data.error || 'Неизвестная ошибка'}`);
                        window.videoSuggestions[videoId] = getFallbackSuggestions();
                    }
                })
                .catch(error => {
                    console.error(`[Suggestions] Ошибка запроса подсказок:`, error);
                    window.videoSuggestions[videoId] = getFallbackSuggestions();
                });
        }
        
        function getFallbackSuggestions() {
            return [
                "🤔 Объясни главную идею простыми словами",
                "📊 Какие факты и данные наиболее важные?",
                "💡 Что было самым неожиданным открытием?",
                "🔍 На какие моменты стоит обратить внимание?"
            ];
        }
        
        function getVideoSuggestions(videoId) {
            if (!window.videoSuggestions || !window.videoSuggestions[videoId]) {
                return getFallbackSuggestions();
            }
            
            const suggestions = window.videoSuggestions[videoId];
            
            // Если подсказки ещё загружаются, возвращаем fallback
            if (suggestions === 'loading') {
                return getFallbackSuggestions();
            }
            
            return Array.isArray(suggestions) ? suggestions : getFallbackSuggestions();
        }

        // === ФОРМАТИРОВАНИЕ СООБЩЕНИЙ ===
        
        function parseMarkdown(text) {
            if (!text) return text;
            
            // Экранируем HTML теги
            text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Заголовки
            text = text.replace(/^### (.*$)/gim, '<h5>$1</h5>');
            text = text.replace(/^## (.*$)/gim, '<h4>$1</h4>');
            text = text.replace(/^# (.*$)/gim, '<h3>$1</h3>');
            
            // Жирный текст
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Курсив
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Списки
            text = text.replace(/^\* (.*$)/gim, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Нумерованные списки
            text = text.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // Переносы строк
            text = text.replace(/\n\n/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            
            // Обрамляем в параграфы если есть переносы
            if (text.includes('<br>') || text.includes('</p><p>')) {
                text = '<p>' + text + '</p>';
            }
            
            return text;
        }
        
        function addTimecodeLinks(text) {
            if (!text || !window.currentVideoId) return text;
            
            // Паттерн для поиска таймкодов: (00:05:48) или 00:05:48 или (05:48)
            const timePattern = /(\()?(\d{1,2}:\d{2}(?::\d{2})?)\)?/g;
            
            return text.replace(timePattern, (match, paren, time) => {
                console.log(`[Timelink] Обрабатываем таймкод: ${time}`);
                
                // Конвертируем время в секунды
                const parts = time.split(':');
                let seconds = 0;
                
                if (parts.length === 2) {
                    // Формат MM:SS
                    const minutes = parseInt(parts[0]) || 0;
                    const secs = parseInt(parts[1]) || 0;
                    seconds = minutes * 60 + secs;
                } else if (parts.length === 3) {
                    // Формат HH:MM:SS
                    const hours = parseInt(parts[0]) || 0;
                    const minutes = parseInt(parts[1]) || 0;
                    const secs = parseInt(parts[2]) || 0;
                    seconds = hours * 3600 + minutes * 60 + secs;
                }
                
                console.log(`[Timelink] ${time} → ${seconds} секунд`);
                
                // Создаем YouTube ссылку с таймкодом
                const youtubeUrl = `https://www.youtube.com/watch?v=${window.currentVideoId}&t=${seconds}s`;
                
                return `<a href="${youtubeUrl}" target="_blank" class="timelink" title="Перейти к ${time} в видео (${seconds}с)">${paren || ''}${time}${paren ? ')' : ''}</a>`;
            });
        }
        
        function formatAiMessage(message) {
            // Сначала Markdown, потом таймкоды
            let formatted = parseMarkdown(message);
            formatted = addTimecodeLinks(formatted);
            return formatted;
        }

        function addChatMessage(sender, message, suggestions = null, skipSave = false) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            
            // Сохраняем в истории диалога (кроме приветственного сообщения и при восстановлении истории)
            if (window.currentVideoId && sender !== 'welcome' && !skipSave) {
                console.log(`[ChatHistory] Сохраняем сообщение для видео ${window.currentVideoId}: ${sender} - "${message.substring(0, 50)}..."`);
                saveChatMessage(window.currentVideoId, sender, message);
            } else if (skipSave) {
                console.log(`[ChatHistory] Восстанавливаем сообщение (не сохраняем): ${sender} - "${message.substring(0, 50)}..."`);
            }
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-bubble user-bubble">
                        <strong>Вы:</strong> ${message}
                    </div>
                `;
            } else {
                // Форматируем сообщение от ИИ (Markdown + таймкоды)
                const formattedMessage = formatAiMessage(message);
                
                let html = `
                    <div class="message-bubble ai-bubble">
                        <strong><i class="fas fa-robot me-1"></i>ИИ:</strong> ${formattedMessage}
                `;
                
                if (suggestions) {
                    html += '<div class="mt-2">';
                    suggestions.forEach(suggestion => {
                        html += `<button class="btn btn-outline-secondary btn-sm me-2 mb-1" onclick="document.getElementById('chatInput').value='${suggestion.replace(/[🤔📊💡🔍] /, '')}'">${suggestion}</button>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                messageDiv.innerHTML = html;
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // === ФУНКЦИИ УПРАВЛЕНИЯ ИСТОРИЕЙ ЧАТА ===
        
        function getChatHistory(videoId) {
            if (!window.chatSessions) {
                window.chatSessions = {};
            }
            return window.chatSessions[videoId] || [];
        }
        
        function saveChatMessage(videoId, role, content) {
            if (!window.chatSessions) {
                window.chatSessions = {};
            }
            
            if (!window.chatSessions[videoId]) {
                window.chatSessions[videoId] = [];
            }
            
            const history = window.chatSessions[videoId];
            const message = {
                role: role === 'user' ? 'user' : 'assistant',
                content: content,
                timestamp: Date.now()
            };
            
            history.push(message);
            console.log(`[ChatHistory] Сохранено сообщение в историю видео ${videoId}. Всего сообщений: ${history.length}`);
            
            // Обрезаем до максимум 10 сообщений (5 пар user-assistant)
            if (history.length > 10) {
                const removed = history.splice(0, history.length - 10);
                console.log(`[ChatHistory] Удалено ${removed.length} старых сообщений для видео ${videoId}`);
            }
        }
        
        function clearChatHistory(videoId) {
            if (window.chatSessions && window.chatSessions[videoId]) {
                console.log(`[ChatHistory] Очищаем историю для видео ${videoId}`);
                delete window.chatSessions[videoId];
            }
        }
        
        // Функция для очистки всех висящих вопросов во всех видео
        function cleanupOrphanedQuestions() {
            let totalCleaned = 0;
            
            if (!window.chatSessions) return totalCleaned;
            
            Object.keys(window.chatSessions).forEach(videoId => {
                const history = window.chatSessions[videoId];
                
                // Идем с конца и удаляем висящие вопросы
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].role === 'user') {
                        const hasResponse = i + 1 < history.length && history[i + 1].role === 'assistant';
                        if (!hasResponse) {
                            console.log(`[Cleanup] Удаляем висящий вопрос в видео ${videoId}: "${history[i].content.substring(0, 50)}..."`);
                            history.splice(i, 1);
                            totalCleaned++;
                        }
                    }
                }
            });
            
            // Обновляем UI активного видео если что-то было очищено
            if (totalCleaned > 0 && window.currentVideoId) {
                refreshChatDisplay();
            }
            
            console.log(`[Cleanup] Очищено ${totalCleaned} висящих вопросов`);
            
            if (totalCleaned > 0) {
                console.log('Состояние после очистки:');
                debugChatSessions();
            }
            
            return totalCleaned;
        }
        
        // Быстрая статистика по видео
        function getVideoStats(videoId) {
            if (!videoId) videoId = window.currentVideoId;
            if (!videoId) return null;
            
            const history = getChatHistory(videoId);
            const hasActiveRequest = !!(window.videoRequestControllers && window.videoRequestControllers[videoId]);
            const isLoading = !!(window.videoLoadingStates && window.videoLoadingStates[videoId]);
            
            let userMessages = 0;
            let assistantMessages = 0;
            let orphanedQuestions = 0;
            
            history.forEach((msg, index) => {
                if (msg.role === 'user') {
                    userMessages++;
                    const hasResponse = index + 1 < history.length && history[index + 1].role === 'assistant';
                    if (!hasResponse) orphanedQuestions++;
                } else if (msg.role === 'assistant') {
                    assistantMessages++;
                }
            });
            
            return {
                videoId,
                isActive: videoId === window.currentVideoId,
                totalMessages: history.length,
                userMessages,
                assistantMessages,
                orphanedQuestions,
                hasActiveRequest,
                isLoading
            };
        }

        // Дебаг функция для проверки состояния всех чат-сессий
        function debugChatSessions() {
            console.log('=== DEBUG CHAT SESSIONS ===');
            console.log(`Текущее активное видео: ${window.currentVideoId}`);
            
            // История сообщений
            if (!window.chatSessions || Object.keys(window.chatSessions).length === 0) {
                console.log('История сообщений: пусто');
            } else {
                console.log('История сообщений:');
                Object.keys(window.chatSessions).forEach(videoId => {
                    const history = window.chatSessions[videoId];
                    console.log(`  - Видео ${videoId}: ${history.length} сообщений`);
                    
                    let orphanedQuestions = 0;
                    history.forEach((msg, index) => {
                        const isOrphan = msg.role === 'user' && 
                                       (index + 1 >= history.length || history[index + 1].role !== 'assistant');
                        if (isOrphan) orphanedQuestions++;
                        
                        console.log(`    ${index + 1}. ${msg.role}${isOrphan ? ' [БЕЗ ОТВЕТА]' : ''}: "${msg.content.substring(0, 50)}..."`);
                    });
                    
                    if (orphanedQuestions > 0) {
                        console.warn(`    ⚠️ ВНИМАНИЕ: ${orphanedQuestions} висящих вопросов без ответа!`);
                    }
                });
            }
            
            // Активные запросы
            if (!window.videoRequestControllers || Object.keys(window.videoRequestControllers).length === 0) {
                console.log('Активные запросы: нет');
            } else {
                console.log('Активные запросы:');
                Object.keys(window.videoRequestControllers).forEach(videoId => {
                    const isActive = videoId === window.currentVideoId;
                    console.log(`  - Видео ${videoId}: запрос в процессе ${isActive ? '[АКТИВНОЕ]' : '[ФОНОВОЕ]'}`);
                });
            }
            
            // Состояния загрузки
            if (!window.videoLoadingStates || Object.keys(window.videoLoadingStates).length === 0) {
                console.log('Состояния загрузки: нет');
            } else {
                console.log('Состояния загрузки:');
                Object.keys(window.videoLoadingStates).forEach(videoId => {
                    const isLoading = window.videoLoadingStates[videoId];
                    console.log(`  - Видео ${videoId}: ${isLoading ? 'загружается' : 'готово'}`);
                });
            }
            
            // Подсказки
            if (!window.videoSuggestions || Object.keys(window.videoSuggestions).length === 0) {
                console.log('Подсказки: нет');
            } else {
                console.log('Подсказки:');
                Object.keys(window.videoSuggestions).forEach(videoId => {
                    const suggestions = window.videoSuggestions[videoId];
                    console.log(`  - Видео ${videoId}: ${Array.isArray(suggestions) ? suggestions.length + ' подсказок' : suggestions}`);
                });
            }
            
            // Общая сводка
            console.log('=== СВОДКА ===');
            if (window.chatSessions && Object.keys(window.chatSessions).length > 0) {
                console.log('Статистика по всем видео:');
                Object.keys(window.chatSessions).forEach(videoId => {
                    const stats = getVideoStats(videoId);
                    const statusParts = [];
                    if (stats.isActive) statusParts.push('АКТИВНОЕ');
                    if (stats.hasActiveRequest) statusParts.push('ЗАГРУЖАЕТСЯ');
                    if (stats.orphanedQuestions > 0) statusParts.push(`${stats.orphanedQuestions} ВИСЯЩИХ`);
                    
                    const status = statusParts.length > 0 ? ` [${statusParts.join(', ')}]` : '';
                    console.log(`  ${videoId}${status}: ${stats.userMessages} вопросов, ${stats.assistantMessages} ответов`);
                });
            } else {
                console.log('Нет активных диалогов');
            }
        }

        function tryOpenModalByParam() {
            const params = new URLSearchParams(window.location.search);
            const videoId = params.get('video');
            if (videoId) {
                const video = currentVideos.find(v => v.video_id === videoId);
                if (video) {
                    showVideoDetails(videoId);
                } else {
                    setTimeout(tryOpenModalByParam, 300);
                }
            }
        }

        // Функции для управления видео
        async function collectVideos() {
            const spinner = document.getElementById('collect-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/collect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Сбор видео запущен в фоне');
                    setTimeout(() => {
                        loadStats();
                        loadVideos();
                    }, 2000);
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка сбора видео:', error);
                alert('Ошибка сбора видео: ' + error.message);
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function runFullWorkflow() {
            const spinner = document.getElementById('workflow-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/full-workflow', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Полный рабочий процесс запущен в фоне');
                    setTimeout(() => {
                        loadStats();
                        loadVideos();
                    }, 2000);
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка запуска полного процесса:', error);
                alert('Ошибка запуска полного процесса: ' + error.message);
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function analyzeNextVideo() {
            const spinner = document.getElementById('analyze-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Анализ всех необработанных видео запущен в фоне');
                    setTimeout(() => {
                        loadStats();
                        loadVideos();
                    }, 2000);
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка анализа видео:', error);
                alert('Ошибка анализа видео: ' + error.message);
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function resetStuckVideos() {
            const spinner = document.getElementById('reset-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/reset-stuck', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Сброшено ${data.reset_count} зависших видео`);
                    loadStats();
                    loadVideos();
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка сброса зависших видео:', error);
                alert('Ошибка сброса зависших видео: ' + error.message);
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function resetErrorVideos() {
            const spinner = document.getElementById('reset-errors-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/reset-errors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Сброшено ${data.reset_count} видео с ошибками`);
                    loadStats();
                    loadVideos();
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка сброса видео с ошибками:', error);
                alert('Ошибка сброса видео с ошибками: ' + error.message);
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function refreshData() {
            try {
                await loadStats();
                await loadVideos();
                alert('Данные обновлены');
            } catch (error) {
                console.error('Ошибка обновления данных:', error);
                alert('Ошибка обновления данных: ' + error.message);
            }
        }

        async function deleteNonAnalyzedVideos() {
            if (!confirm('Вы уверены, что хотите удалить все неуспешные видео? Это действие нельзя отменить.')) {
                return;
            }
            
            const spinner = document.getElementById('delete-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/delete-non-analyzed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Удалено ${data.deleted_count} неуспешных видео`);
                    loadStats();
                    loadVideos();
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка удаления неуспешных видео:', error);
                alert('Ошибка удаления неуспешных видео: ' + error.message);
            } finally {
                spinner.style.display = 'none';
            }
        }

        function showError(message) {
            alert('Ошибка: ' + message);
        }
        // === ИЗОЛЯЦИЯ ЗАПРОСОВ ПО ВИДЕО ===
        
        // Хранилище активных запросов к API по каждому видео
        window.videoRequestControllers = {};
        
        // Хранилище состояния загрузки для каждого видео
        window.videoLoadingStates = {};
        
        function abortVideoRequest(videoId) {
            if (window.videoRequestControllers[videoId]) {
                console.log(`[RequestIsolation] Отменяем запрос для видео ${videoId}`);
                window.videoRequestControllers[videoId].abort();
                delete window.videoRequestControllers[videoId];
                
                // При принудительной отмене удаляем висящий вопрос
                removeLastUserMessage(videoId);
            }
        }
        
        function removeLastUserMessage(videoId) {
            // Удаляем из истории в памяти
            if (window.chatSessions && window.chatSessions[videoId]) {
                const history = window.chatSessions[videoId];
                
                // Ищем последнее сообщение пользователя без ответа
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].role === 'user') {
                        // Проверяем есть ли после него ответ assistant
                        const hasResponse = i + 1 < history.length && history[i + 1].role === 'assistant';
                        if (!hasResponse) {
                            console.log(`[RequestIsolation] Удаляем висящий вопрос для видео ${videoId}: "${history[i].content.substring(0, 50)}..."`);
                            history.splice(i, 1);
                            
                            // Если это активное видео, обновляем UI
                            if (window.currentVideoId === videoId) {
                                refreshChatDisplay();
                            }
                            break;
                        }
                    }
                }
            }
        }
        
        function refreshChatDisplay() {
            // Перерисовываем чат для активного видео
            if (!window.currentVideoId) return;
            
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            // Очищаем текущий чат
            chatHistory.innerHTML = '';
            
            // Восстанавливаем историю без сохранения (skipSave=true)
            const savedHistory = getChatHistory(window.currentVideoId);
            savedHistory.forEach(msg => {
                addChatMessage(msg.role, msg.content, null, true);
            });
            
            // Если истории нет, показываем приветствие
            if (chatHistory.children.length === 0) {
                const smartSuggestions = getVideoSuggestions(window.currentVideoId);
                addChatMessage('welcome', 'Привет! Готов обсудить это видео. Вот несколько идей для разговора:', smartSuggestions);
            }
            
            console.log(`[RequestIsolation] Обновлен дисплей чата для видео ${window.currentVideoId}`);
        }
        
        function setVideoLoading(videoId, isLoading) {
            if (!window.videoLoadingStates) {
                window.videoLoadingStates = {};
            }
            window.videoLoadingStates[videoId] = isLoading;
            
            // Обновляем UI только если это активное видео
            if (window.currentVideoId === videoId) {
                const chatLoader = document.getElementById('chatLoader');
                if (chatLoader) {
                    chatLoader.style.display = isLoading ? 'block' : 'none';
                }
            }
            
            console.log(`[RequestIsolation] Видео ${videoId} загрузка: ${isLoading}`);
        }

        // === ОБСУЖДЕНИЕ ВЫДЕЛЕННОГО ТЕКСТА ===
        
        let selectedText = '';
        let selectedRange = null;
        
        // Создаем плавающую кнопку для обсуждения
        function createFloatingDiscussBtn() {
            if (document.getElementById('floatingDiscussBtn')) {
                return document.getElementById('floatingDiscussBtn');
            }
            
            const btn = document.createElement('button');
            btn.id = 'floatingDiscussBtn';
            btn.className = 'floating-discuss-btn';
            btn.innerHTML = '<i class="fas fa-comments me-1"></i>Обсудить';
            btn.onclick = discussSelectedText;
            document.body.appendChild(btn);
            return btn;
        }
        
        // Обработчик выделения текста в модальном окне
        function handleTextSelection() {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            const btn = createFloatingDiscussBtn();
            
            if (text.length > 0) {
                selectedText = text;
                selectedRange = selection.getRangeAt(0);
                
                // Показываем кнопку рядом с выделением
                const rect = selectedRange.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                
                btn.style.display = 'block';
                
                // Особое позиционирование для мобильных устройств
                if (isMobileDevice()) {
                    // На мобилках позиционируем по центру экрана, но ниже выделения
                    const buttonWidth = 120; // примерная ширина кнопки
                    const leftPosition = Math.max(10, Math.min(
                        window.innerWidth - buttonWidth - 10,
                        rect.left + scrollLeft + rect.width / 2 - buttonWidth / 2
                    ));
                    
                    btn.style.left = leftPosition + 'px';
                    btn.style.top = (rect.bottom + scrollTop + 15) + 'px'; // больше отступ для мобилок
                } else {
                    // Стандартное позиционирование для десктопа
                    btn.style.left = (rect.left + scrollLeft + rect.width / 2 - btn.offsetWidth / 2) + 'px';
                    btn.style.top = (rect.bottom + scrollTop + 8) + 'px';
                }
                
                console.log(`[TextSelection] Выделен текст: "${text.substring(0, 100)}..."`);
            } else {
                btn.style.display = 'none';
                selectedText = '';
                selectedRange = null;
            }
        }
        
        // Обработчик клика по кнопке "Обсудить"
        function discussSelectedText() {
            if (!selectedText || !window.currentVideoId) {
                console.log('[TextSelection] Нет выделенного текста или активного видео');
                return;
            }
            
            // КРИТИЧНО: Захватываем videoId для изоляции
            const videoId = window.currentVideoId;
            console.log(`[TextSelection] Инициируем диалог для видео ${videoId} с выделенным текстом: "${selectedText.substring(0, 100)}..."`);
            
            // Открываем чат если он закрыт
            const chatSection = document.getElementById('videoChatSection');
            if (chatSection.style.display === 'none') {
                toggleVideoChat();
            }
            
            // Проверяем что видео еще активно
            if (window.currentVideoId !== videoId) {
                console.log(`[TextSelection] Видео ${videoId} больше не активно, отменяем обсуждение`);
                return;
            }
            
            // Формируем сообщение с контекстом
            const message = `Объясни этот фрагмент из видео: "${selectedText}"`;
            
            // Вставляем в поле ввода
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = message;
                chatInput.focus();
                
                // Автоматически отправляем сообщение (с небольшой задержкой)
                setTimeout(() => {
                    // Финальная проверка актуальности видео перед отправкой
                    if (window.currentVideoId === videoId) {
                        sendChatMessage();
                    } else {
                        console.log(`[TextSelection] Видео изменилось, отменяем автоотправку`);
                    }
                }, 100);
            }
            
            // Скрываем кнопку
            const btn = document.getElementById('floatingDiscussBtn');
            if (btn) btn.style.display = 'none';
            
            // Очищаем выделение
            window.getSelection().removeAllRanges();
            selectedText = '';
            selectedRange = null;
        }
        
        // Проверка мобильного устройства
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   ('ontouchstart' in window);
        }
        
        // Функция для полной очистки выделения и кнопки
        function clearTextSelectionAndButton() {
            // Скрываем плавающую кнопку
            const btn = document.getElementById('floatingDiscussBtn');
            if (btn) {
                btn.style.display = 'none';
            }
            
            // Очищаем выделение
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
            
            // Очищаем переменные
            selectedText = '';
            selectedRange = null;
            
            console.log('[TextSelection] Очистка выделения и кнопки');
        }
        
        // Улучшенный обработчик выделения для всех устройств
        function checkTextSelectionInModal() {
            const modal = document.getElementById('videoModal');
            if (modal && modal.classList.contains('show')) {
                setTimeout(handleTextSelection, 10);
            }
        }
        
        // Добавляем обработчики событий при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Обработчик выделения для десктопа
            document.addEventListener('mouseup', checkTextSelectionInModal);
            
            // Обработчик выделения для мобильных устройств
            if (isMobileDevice()) {
                // touchend для завершения касания
                document.addEventListener('touchend', checkTextSelectionInModal);
                
                // selectionchange для изменения выделения (универсальный)
                document.addEventListener('selectionchange', function() {
                    const modal = document.getElementById('videoModal');
                    if (modal && modal.classList.contains('show')) {
                        // Небольшая задержка для мобильных устройств
                        setTimeout(handleTextSelection, 150);
                    }
                });
                
                console.log('[TextSelection] Мобильное устройство обнаружено, включены touch события');
            }
            
            // Скрываем кнопку при клике в другом месте
            document.addEventListener('click', function(e) {
                const btn = document.getElementById('floatingDiscussBtn');
                if (btn && e.target !== btn && !btn.contains(e.target)) {
                    btn.style.display = 'none';
                }
            });
            
            // Скрываем кнопку при прокрутке (обычная и внутри модала)
            document.addEventListener('scroll', function() {
                const btn = document.getElementById('floatingDiscussBtn');
                if (btn) btn.style.display = 'none';
            });
            
            // Дополнительно отслеживаем скролл внутри модального окна
            const modalBody = document.getElementById('videoModalBody');
            if (modalBody) {
                modalBody.addEventListener('scroll', function() {
                    const btn = document.getElementById('floatingDiscussBtn');
                    if (btn) btn.style.display = 'none';
                });
            }
        });
    </script>

    <!-- Плавающая кнопка для обсуждения выделенного текста будет создана динамически -->

</body>
</html>