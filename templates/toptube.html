<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopTube - Анализ популярных видео</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .video-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background: white;
        }
        
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .video-thumbnail {
            position: relative;
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            overflow: hidden;
        }
        
        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .video-card:hover .video-thumbnail img {
            transform: scale(1.05);
        }
        
        .video-thumbnail-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,107,107,0.8), rgba(78,205,196,0.8));
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .video-card:hover .video-thumbnail-overlay {
            opacity: 1;
        }
        
        .play-button {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff6b6b;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .status-badge {
            font-size: 0.8rem;
            border-radius: 20px;
            padding: 5px 12px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 0.7rem 0.5rem;
            min-width: 120px;
            max-width: 180px;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .stats-card .card-body {
            padding: 0.7rem 0.5rem;
        }
        
        .stats-card h5 {
            font-size: 1rem;
            margin-bottom: 0.2rem;
        }
        
        .stats-card h3 {
            font-size: 1.3rem;
            margin-bottom: 0;
        }
        
        .stats-card i {
            font-size: 1.5rem;
            margin-bottom: 0.2rem;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .btn-action {
            min-width: 120px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .analysis-text {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 15px;
        }
        
        .analysis-summary {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-radius: 10px;
            padding: 12px;
            border-left: 4px solid #ffc107;
            min-height: 80px;
            max-height: 120px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }
        
        .video-title {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.8em;
            max-height: 2.8em;
            line-height: 1.4;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .video-title-highlight {
            background: linear-gradient(135deg, #e3f0ff 0%, #d0ebff 100%);
            border-radius: 8px;
            padding: 6px 10px;
            display: block;
            width: 100%;
            font-weight: 600;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(80, 140, 255, 0.07);
            margin-bottom: 0.3em;
            min-height: 4.2em;
            display: flex;
            align-items: center;
        }
        .video-title-highlight a {
            display: block;
            width: 100%;
            color: inherit;
            text-decoration: none;
        }
        
        .analysis-summary-content {
            width: 100%;
            white-space: normal;
            text-overflow: ellipsis;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .video-meta {
            font-size: 0.85rem;
            color: #666;
        }
        
        .video-meta i {
            color: #667eea;
            width: 16px;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-body {
            padding: 1rem;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }
        
        .form-select, .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .meta-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 0.7em;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 0.5em;
        }
        
        .meta-inline .meta-item {
            display: flex;
            align-items: center;
            gap: 0.2em;
        }
        
        .video-meta-col, .video-summary-col {
            display: unset;
            align-items: unset;
            gap: unset;
            min-height: unset;
        }
        
        .analysis-summary {
            width: 100%;
            margin-bottom: 0;
        }
        
        .card-footer-fixed {
            margin-top: auto;
        }
        
        .channel-title {
            font-size: 0.95em;
            color: #b23c17;
            font-weight: 600;
            margin-bottom: 1rem;
            letter-spacing: 0.01em;
        }
        
        .meta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 1rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #666;
        }
        
        .duration-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 1rem;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .video-card {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .video-card:nth-child(1) { animation-delay: 0.1s; }
        .video-card:nth-child(2) { animation-delay: 0.2s; }
        .video-card:nth-child(3) { animation-delay: 0.3s; }
        .video-card:nth-child(4) { animation-delay: 0.4s; }
        .video-card:nth-child(5) { animation-delay: 0.5s; }
        
        /* Мобильные устройства */
        @media (max-width: 768px) {
            /* Убираем навигационную панель */
            .navbar {
                display: none !important;
            }
            
            /* Убираем сиреневый фон */
            body {
                background: white !important;
            }
            
            /* Минимизируем отступы белой подложки */
            .main-content {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                margin: 0 !important;
                padding: 10px !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            
            /* Убираем отступ сверху */
            .main-content .row:first-child {
                margin-top: 0;
            }
            
            /* Белый заголовок с уменьшенным шрифтом */
            .main-content h1 {
                color: white !important;
                font-size: 1.5rem !important;
            }
            
            /* Белая иконка Play для мобилы */
            .main-content h1 .fas {
                color: white !important;
            }
            
            /* Белый подзаголовок для мобилы */
            .main-content p.text-muted {
                color: rgba(255, 255, 255, 0.8) !important;
            }
            /* Цвет буквы a для мобилы */
            .ai-logo-a {
                color: #ffe066 !important;
            }
            .ai-logo-itube {
                color: white !important;
            }
        }
        
        /* Скрываем навигацию для не-админов */
        .navbar {
            display: none;
        }
        
        /* Показываем навигацию только для админов */
        .admin-mode .navbar {
            display: block;
        }
        /* Цвет буквы a для десктопа */
        .ai-logo-a {
            color: #b23c17;
        }
        .ai-logo-itube {
            color: #4b3fa7;
        }
        @media (min-width: 768px) {
            #stats-container {
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 16px;
                justify-content: center;
                align-items: stretch;
            }
        }
        @media (max-width: 767.98px) {
            #stats-container {
                display: flex;
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }
        }
        .stats-block {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-radius: 16px;
            width: 150px;
            min-width: 0;
            min-height: 80px;
            flex: 0 0 150px;
            padding: 10px 8px 8px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(80, 80, 160, 0.10);
            margin: 0;
        }
        .stats-block i {
            font-size: 1.5rem;
            margin-bottom: 0.2em;
        }
        .stats-label {
            font-size: 0.95em;
            margin-bottom: 0.2em;
            font-weight: 400;
        }
        .stats-value {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 0;
        }
        #stats-container {
            display: flex;
            flex-direction: row;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            flex-wrap: nowrap;
        }
        .stat-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-radius: 999px;
            min-width: 80px;
            min-height: 48px;
            padding: 6px 12px 4px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            font-weight: 500;
            border: none;
            box-shadow: 0 1px 4px rgba(80, 80, 160, 0.10);
            transition: background 0.2s;
        }
        .stat-btn i {
            font-size: 1.1rem;
            margin-bottom: 0.1em;
        }
        .stat-label {
            font-size: 0.85em;
            margin-bottom: 0.1em;
            font-weight: 400;
        }
        .stat-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 0;
        }
        @media (max-width: 767.98px) {
            #stats-container {
                flex-wrap: wrap;
                gap: 8px;
            }
            .stat-btn {
                min-width: 44vw;
                font-size: 0.95rem;
                padding: 6px 0 4px 0;
            }
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-play-circle me-2"></i>aiTube
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Главная</a>
                <a class="nav-link" href="/workflow"><i class="fas fa-cogs me-1"></i>Workflow</a>
                <a class="nav-link active" href="/toptube"><i class="fas fa-video me-1"></i>Видео</a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <!-- Заголовок и статистика -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-6 mb-1 text-center fw-bold" style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; font-weight: bold;">
                    <i class="fas fa-play-circle text-primary me-2"></i><span class="ai-logo-a">a</span><span class="ai-logo-itube">iTube</span>
                </h1>
                <p class="text-muted mb-0 text-center" style="font-size: 0.9rem;">
                    ИИ-анализ популярных YouTube видео
                </p>
            </div>
        </div>

        <!-- Статистика -->
        <div class="d-flex flex-wrap gap-2 justify-content-center mb-4">
            <button type="button" class="btn btn-primary btn-sm stat-btn">
                <i class="fas fa-video"></i>
                <div class="stat-label">Всего</div>
                <div class="stat-value" id="total-videos">-</div>
            </button>
            <button type="button" class="btn btn-primary btn-sm stat-btn">
                <i class="fas fa-check-circle"></i>
                <div class="stat-label">Анализ</div>
                <div class="stat-value" id="analyzed-videos">-</div>
            </button>
            <button type="button" class="btn btn-primary btn-sm stat-btn">
                <i class="fas fa-clock"></i>
                <div class="stat-label">В обр.</div>
                <div class="stat-value" id="processing-videos">-</div>
            </button>
            <button type="button" class="btn btn-primary btn-sm stat-btn">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="stat-label">Ошибки</div>
                <div class="stat-value" id="error-videos">-</div>
            </button>
        </div>

        <!-- Кнопки управления -->
        <div class="row mb-4" id="management-container">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-cogs me-2"></i>Управление
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-warning btn-action" onclick="runFullWorkflow()">
                                <i class="fas fa-cogs me-1"></i>
                                Полный процесс
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="workflow-spinner"></span>
                            </button>
                            <button class="btn btn-primary btn-action" onclick="collectVideos()">
                                <i class="fas fa-download me-1"></i>
                                Собрать видео
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="collect-spinner"></span>
                            </button>
                            <button class="btn btn-success btn-action" onclick="analyzeNextVideo()">
                                <i class="fas fa-play me-1"></i>
                                Анализировать все видео
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="analyze-spinner"></span>
                            </button>
                            <button class="btn btn-danger btn-action" onclick="resetStuckVideos()">
                                <i class="fas fa-undo me-1"></i>
                                Сбросить зависшие
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="reset-spinner"></span>
                            </button>
                            <button class="btn btn-warning btn-action" onclick="resetErrorVideos()">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Сбросить ошибки
                                <span class="spinner-border spinner-border-sm loading-spinner ms-1" id="reset-errors-spinner"></span>
                            </button>
                            <button class="btn btn-info btn-action" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-1"></i>
                                Обновить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Фильтры -->
        <div class="row mb-4" id="filters-container">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label for="status-filter" class="form-label">Статус:</label>
                                <select class="form-select" id="status-filter" onchange="loadVideos()">
                                    <option value="analyzed">Проанализированные</option>
                                    <option value="new">Новые</option>
                                    <option value="processing">В обработке</option>
                                    <option value="error">С ошибками</option>
                                    <option value="all">Все</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="limit-filter" class="form-label">Количество:</label>
                                <select class="form-select" id="limit-filter" onchange="loadVideos()">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список видео -->
        <div class="row" id="videos-container">
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3">Загрузка видео...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для детального просмотра -->
    <div class="modal fade" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalTitle">Детали видео</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="videoModalBody">
                    <!-- Контент будет загружен динамически -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Глобальные переменные
        let currentVideos = [];
        let isAdminMode = false;

        // Проверяем режим при загрузке страницы
        function checkAdminMode() {
            const urlParams = new URLSearchParams(window.location.search);
            isAdminMode = urlParams.has('admin');
            
            // Добавляем класс admin-mode к body для показа навигации
            if (isAdminMode) {
                document.body.classList.add('admin-mode');
            } else {
                document.body.classList.remove('admin-mode');
            }
            
            // Скрываем/показываем элементы в зависимости от режима
            const adminElements = [
                'stats-container',
                'management-container', 
                'filters-container'
            ];
            
            adminElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = isAdminMode ? 'block' : 'none';
                }
            });
            
            // Если не админский режим, загружаем только проанализированные видео
            if (!isAdminMode) {
                document.getElementById('status-filter').value = 'analyzed';
                document.getElementById('limit-filter').value = '50';
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminMode();
            if (isAdminMode) {
                loadStats();
            }
            loadVideos();
        });

        // Загрузка статистики
        async function loadStats() {
            try {
                const response = await fetch('/api/toptube/stats');
                const data = await response.json();
                
                console.log('Статистика получена:', data); // Отладочная информация
                
                if (data.success) {
                    const stats = data.stats;
                    console.log('Данные статистики:', stats); // Отладочная информация
                    
                    document.getElementById('total-videos').textContent = stats.total || 0;
                    document.getElementById('analyzed-videos').textContent = stats.analyzed || 0;
                    document.getElementById('processing-videos').textContent = stats.processing || 0;
                    document.getElementById('error-videos').textContent = stats.error || 0;
                } else {
                    console.error('Ошибка в ответе статистики:', data.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }

        // Загрузка видео
        async function loadVideos() {
            let status, limit;
            
            if (isAdminMode) {
                // В админском режиме используем значения из фильтров
                status = document.getElementById('status-filter').value;
                limit = document.getElementById('limit-filter').value;
            } else {
                // В обычном режиме всегда загружаем только проанализированные видео
                status = 'analyzed';
                limit = '50';
            }
            
            try {
                const response = await fetch(`/api/toptube/videos?status=${status}&limit=${limit}`);
                const data = await response.json();
                
                if (data.success) {
                    currentVideos = data.videos;
                    renderVideos(data.videos);
                } else {
                    showError('Ошибка загрузки видео: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки видео:', error);
                showError('Ошибка загрузки видео');
            }
        }

        // Отрисовка видео
        function renderVideos(videos) {
            const container = document.getElementById('videos-container');
            
            if (videos.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h5>Видео не найдены</h5>
                            <p>Попробуйте изменить фильтры или собрать новые видео</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = videos.map(video => createVideoCard(video)).join('');
        }

        // Создание карточки видео
        function createVideoCard(video) {
            const statusBadge = getStatusBadge(video.status);
            const duration = formatDuration(video.duration);
            const views = formatNumber(video.views);
            const subscribers = formatNumber(video.subscribers);
            const publishedDate = new Date(video.published_at).toLocaleDateString('ru-RU');
            const thumbnailUrl = `https://img.youtube.com/vi/${video.video_id}/maxresdefault.jpg`;
            
            return `
                <div class="col-md-6 col-lg-4 col-xxl-3 mb-4">
                    <div class="card video-card h-100 d-flex flex-column">
                        <div class="video-thumbnail">
                            <img src="${thumbnailUrl}" alt="${video.title}" 
                                 onerror="this.src='https://img.youtube.com/vi/${video.video_id}/hqdefault.jpg'"
                                 onload="this.style.display='block'">
                            <div class="video-thumbnail-overlay">
                                <div class="play-button">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                            <div class="duration-badge">${duration}</div>
                        </div>
                        
                        <div class="card-body d-flex flex-column">
                            <h6 class="video-title mb-2">
                                <a href="${video.url}" target="_blank" class="text-decoration-none">
                                    ${video.title}
                                </a>
                            </h6>
                            <p class="channel-title mb-2">${video.channel_title}</p>
                            <div class="meta-inline mb-2">
                                <div class="meta-item"><i class="fas fa-eye me-1"></i> ${views}</div>
                                <div class="meta-item"><i class="fas fa-users me-1"></i> ${subscribers}</div>
                                <div class="meta-item"><i class="fas fa-calendar me-1"></i> ${publishedDate}</div>
                                <div class="meta-item"><i class="fas fa-clock me-1"></i> ${duration}</div>
                            </div>
                            ${video.analysis_summary ? `
                                <div class="analysis-summary mb-3">
                                    <div class="analysis-summary-content">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                        ${video.analysis_summary}
                                    </div>
                                </div>
                            ` : video.analysis_result ? `
                                <div class="analysis-text mb-3">
                                    <strong>Анализ:</strong><br>
                                    ${video.analysis_result.substring(0, 200)}${video.analysis_result.length > 200 ? '...' : ''}
                                </div>
                            ` : ''}
                            <div class="d-flex justify-content-between align-items-center mt-auto">
                                <span>${statusBadge}</span>
                                <button class="btn btn-outline-primary btn-sm" style="min-width:120px" onclick="showVideoDetails('${video.video_id}')">
                                    <i class="fas fa-info-circle me-1"></i>Детали
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Получение бейджа статуса
        function getStatusBadge(status) {
            const badges = {
                'new': '<span class="badge bg-secondary status-badge">Новое</span>',
                'processing': '<span class="badge bg-warning status-badge">Обработка</span>',
                'analyzed': '<span class="badge bg-success status-badge">Проанализировано</span>',
                'error': '<span class="badge bg-danger status-badge">Ошибка</span>'
            };
            return badges[status] || '<span class="badge bg-secondary status-badge">' + status + '</span>';
        }

        // Форматирование длительности
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return hours > 0 ? `${hours}ч ${minutes}м` : `${minutes}м`;
        }

        // Форматирование чисел
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Показать детали видео
        function showVideoDetails(videoId) {
            const video = currentVideos.find(v => v.video_id === videoId);
            if (!video) return;

            const modalTitle = document.getElementById('videoModalTitle');
            const modalBody = document.getElementById('videoModalBody');
            const thumbnailUrl = `https://img.youtube.com/vi/${video.video_id}/maxresdefault.jpg`;
            
            modalTitle.textContent = video.title;
            
            // Уменьшаем превью и левую колонку
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-2">
                            <img src="${thumbnailUrl}" alt="${video.title}" 
                                 class="img-fluid rounded" style="max-width: 180px; max-height: 110px; object-fit:cover;"
                                 onerror="this.src='https://img.youtube.com/vi/${video.video_id}/hqdefault.jpg'">
                        </div>
                        <div style="font-size:0.95em;">
                          <div><strong>Канал:</strong> ${video.channel_title}</div>
                          <div><strong>Длительность:</strong> ${formatDuration(video.duration)}</div>
                          <div><strong>Просмотры:</strong> ${formatNumber(video.views)}</div>
                          <div><strong>Подписчики:</strong> ${formatNumber(video.subscribers)}</div>
                          <div><strong>Дата публикации:</strong> ${new Date(video.published_at).toLocaleDateString('ru-RU')}</div>
                          <div><strong>Статус:</strong> ${getStatusBadge(video.status)}</div>
                        </div>
                        <a href="${video.url}" target="_blank" class="btn btn-primary btn-sm w-100 mt-2">
                            <i class="fas fa-external-link-alt me-1"></i> YouTube
                        </a>
                    </div>
                    <div class="col-md-8">
                        <h6>Анализ</h6>
                        <div id="modal-analysis-markdown"></div>
                        ${video.error_message ? `
                            <div class="mt-3">
                                <h6 class="text-danger">Ошибка</h6>
                                <div class="text-danger small">${video.error_message}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            // Рендерим анализ как markdown
            setTimeout(() => {
                const analysisDiv = document.getElementById('modal-analysis-markdown');
                if (video.analysis_result) {
                    if (window.marked) {
                        analysisDiv.innerHTML = window.marked.parse(video.analysis_result);
                    } else {
                        analysisDiv.textContent = video.analysis_result;
                    }
                } else {
                    analysisDiv.innerHTML = '<p class="text-muted">Анализ недоступен</p>';
                }
            }, 0);
            new bootstrap.Modal(document.getElementById('videoModal')).show();
        }

        // Сбор видео
        async function collectVideos() {
            const spinner = document.getElementById('collect-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/collect', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Сбор видео запущен в фоне');
                    setTimeout(() => {
                        loadStats();
                        loadVideos();
                    }, 5000);
                } else {
                    showError('Ошибка запуска сбора: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка сбора видео:', error);
                showError('Ошибка сбора видео');
            } finally {
                spinner.style.display = 'none';
            }
        }

        // Анализ всех необработанных видео
        async function analyzeNextVideo() {
            const spinner = document.getElementById('analyze-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/analyze', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Анализ всех необработанных видео запущен в фоне');
                    setTimeout(() => {
                        loadStats();
                        loadVideos();
                    }, 3000);
                } else {
                    showError('Ошибка запуска анализа: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка анализа видео:', error);
                showError('Ошибка анализа видео');
            } finally {
                spinner.style.display = 'none';
            }
        }

        // Запуск полного рабочего процесса
        async function runFullWorkflow() {
            const spinner = document.getElementById('workflow-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/full-workflow', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Полный рабочий процесс запущен в фоне (сбор → анализ → очистка)');
                    setTimeout(() => {
                        loadStats();
                        loadVideos();
                    }, 5000);
                } else {
                    showError('Ошибка запуска полного процесса: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка полного рабочего процесса:', error);
                showError('Ошибка полного рабочего процесса');
            } finally {
                spinner.style.display = 'none';
            }
        }

        // Сброс зависших видео
        async function resetStuckVideos() {
            const spinner = document.getElementById('reset-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/reset-stuck', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    setTimeout(() => {
                        loadStats();
                        loadVideos();
                    }, 1000);
                } else {
                    showError('Ошибка сброса зависших видео: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка сброса зависших видео:', error);
                showError('Ошибка сброса зависших видео');
            } finally {
                spinner.style.display = 'none';
            }
        }

        // Сброс видео с ошибками
        async function resetErrorVideos() {
            const spinner = document.getElementById('reset-errors-spinner');
            spinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/toptube/reset-errors', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    setTimeout(() => {
                        loadStats();
                        loadVideos();
                    }, 1000);
                } else {
                    showError('Ошибка сброса видео с ошибками: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка сброса видео с ошибками:', error);
                showError('Ошибка сброса видео с ошибками');
            } finally {
                spinner.style.display = 'none';
            }
        }

        // Обновление данных
        function refreshData() {
            if (isAdminMode) {
                loadStats();
            }
            loadVideos();
        }

        // Показать уведомление об успехе
        function showSuccess(message) {
            // Можно добавить toast уведомления
            alert('✅ ' + message);
        }

        // Показать уведомление об ошибке
        function showError(message) {
            // Можно добавить toast уведомления
            alert('❌ ' + message);
        }
    </script>
</body>
</html> 